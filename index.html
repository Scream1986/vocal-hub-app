<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS completo qui */
    </style>
</head>
<body>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURAZIONE E STATO ---
        const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let state = { /* ... */ };
        // ... altre variabili e utility ...

        // --- FUNZIONI CORE ---
        // ... login, logout, etc ...

        const loadInitialData = async () => {
            showLoading(true);
            // MODIFICA: Carica anche start_hour e end_hour
            const { data, error } = await supabase.from('schedule_config').select('location, work_days, start_hour, end_hour');
            showLoading(false);
            if (error) return console.error("Errore caricamento config calendario:", error);
            state.scheduleConfig = {};
            if (data) data.forEach(item => {
                state.scheduleConfig[item.location] = {
                    work_days: item.work_days || [],
                    start_hour: item.start_hour || 15,
                    end_hour: item.end_hour || 21
                };
            });
            renderLocationButtons();
        };

        // --- FUNZIONI GESTIONE CALENDARIO ---
        const renderScheduleSettings = async () => {
            // ... (logica esistente) ...
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('*').order('location');
            showLoading(false);
            // ... (logica esistente) ...
            data.forEach(locationData => {
                let locationHtml = `
                    <div style="border: 1px solid #eee; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;" data-location-block="${locationData.location}">
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="start-${locationData.location}">Ora Inizio</label>
                                <input type="number" id="start-${locationData.location}" class="schedule-hour-input" data-location="${locationData.location}" data-type="start_hour" min="0" max="23" value="${locationData.start_hour || 15}">
                            </div>
                            <div class="form-group">
                                <label for="end-${locationData.location}">Ora Fine</label>
                                <input type="number" id="end-${locationData.location}" class="schedule-hour-input" data-location="${locationData.location}" data-type="end_hour" min="1" max="24" value="${locationData.end_hour || 21}">
                            </div>
                        </div>
                    </div>`;
                contentDiv.innerHTML += locationHtml;
            });
        };
        
        const saveScheduleSettings = async () => {
            // ... (logica esistente per locationsToDelete) ...
            const updates = [];
            document.querySelectorAll('.days-checkboxes').forEach(div => {
                const location = div.dataset.location;
                const work_days = Array.from(div.querySelectorAll('input:checked')).map(box => parseInt(box.value));
                // NUOVA PARTE: Legge i valori degli orari
                const start_hour = document.getElementById(`start-${location}`).value;
                const end_hour = document.getElementById(`end-${location}`).value;
                updates.push({ location, work_days, start_hour, end_hour });
            });
            
            showLoading(true);
            // Usa upsert per aggiornare o inserire
            const { error } = await supabase.from('schedule_config').upsert(updates, { onConflict: 'location' });
            showLoading(false);
            
            if (error) { alert("Errore nel salvataggio."); console.error(error); } 
            else { alert("Impostazioni salvate."); await loadInitialData(); navigateTo('main-screen'); }
        };

        const addLocation = async () => {
            // Quando si aggiunge una nuova sede, ora verranno usati i valori di default (15 e 21)
            // La logica rimane la stessa.
        };

        const renderAdminTimeGrid = async (dateStr, location) => {
            // ... (logica esistente) ...
            // MODIFICA: Usa gli orari dallo stato invece che valori fissi
            const locationConfig = state.scheduleConfig[location];
            const slots = generateTimeSlots(locationConfig.start_hour, locationConfig.end_hour, 15);
            // ... (il resto della funzione rimane invariato) ...
        };

        // ... Tutte le altre funzioni e gli event listener completi ...
    });
    </script>
</body>
</html>