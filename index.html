<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURAZIONE SUPABASE ---
        const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. STATO GLOBALE E ELEMENTI DOM ---
        let state = {
            currentUser: null,
            scheduleConfig: {},
            currentDate: new Date(),
            currentLocation: null,
            selectedDate: null,
            allUsers: []
        };
        state.currentDate.setDate(1);

        const loadingSpinner = document.getElementById('loading-spinner');
        const mainEl = document.querySelector('main');
        const screens = {
            'login-screen': document.getElementById('login-screen'),
            'main-screen': document.getElementById('main-screen'),
            'schedule-settings-screen': document.getElementById('schedule-settings-screen'),
            'student-list-screen': document.getElementById('student-list-screen'),
            'booking-screen': document.getElementById('booking-screen'),
        };
        const genericModal = {
            overlay: document.getElementById('generic-modal-overlay'),
            title: document.getElementById('generic-modal-title'),
            message: document.getElementById('generic-modal-message'),
            buttons: document.getElementById('generic-modal-buttons'),
        };

        // --- 3. FUNZIONI UTILITY E MODALI ---
        const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
        const navigateTo = (screenId) => {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        };
        const formatDate = (date) => date.toISOString().split('T')[0];
        const formatTime = (date) => date.toTimeString().substring(0, 5);

        const generateTimeSlots = (startHour, endHour, intervalMinutes) => {
            const slots = [];
            let currentTime = new Date(`1970-01-01T${startHour}:00:00Z`);
            const endTime = new Date(`1970-01-01T${endHour}:00:00Z`);
            while (currentTime < endTime) {
                slots.push(currentTime.toTimeString().substring(0, 5));
                currentTime.setMinutes(currentTime.getMinutes() + intervalMinutes);
            }
            return slots;
        };

        const showModal = (title, message, buttonsConfig) => {
            genericModal.title.textContent = title;
            genericModal.message.innerHTML = message;
            genericModal.buttons.innerHTML = '';
            buttonsConfig.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = `btn ${btnConfig.class}`;
                button.addEventListener('click', () => {
                    genericModal.overlay.style.display = 'none';
                    if (btnConfig.onClick) btnConfig.onClick();
                });
                genericModal.buttons.appendChild(button);
            });
            genericModal.overlay.style.display = 'flex';
        };

        const showAlert = (message, title = "Avviso") => {
            showModal(title, message, [{ text: 'OK', class: 'btn-primary' }]);
        };

        const showConfirm = (title, message, onConfirm) => {
            showModal(title, message, [
                { text: 'Annulla', class: 'btn-secondary' },
                { text: 'Conferma', class: 'btn-primary', onClick: onConfirm }
            ]);
        };
        
        // --- 4. FUNZIONI CORE ---
        const login = async () => {
            const code = document.getElementById('student-code').value.toUpperCase().trim();
            if (!code) return showAlert('Inserisci un codice.');
            showLoading(true);
            const { data: user, error } = await supabaseClient.from('users').select('*').eq('code', code).single();
            showLoading(false);
            if (error && error.code !== 'PGRST116') { return showAlert('Errore di connessione. Riprova più tardi.'); }
            if (user) {
                state.currentUser = user;
                document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
                await loadInitialData();
                if (user.role === 'admin') {
                    updateAdminUI();
                    const { data: users } = await supabaseClient.from('users').select('id, code, name').eq('role', 'student');
                    state.allUsers = users || [];
                } else {
                    renderStudentBookingSummary();
                }
                navigateTo('main-screen');
            } else {
                showAlert('Codice non valido. Riprova.');
            }
        };

        const loadInitialData = async () => {
            showLoading(true);
            const { data, error } = await supabaseClient.from('schedule_config').select('location, work_days');
            showLoading(false);
            if (error) { return console.error("Errore caricamento config calendario:", error); }
            state.scheduleConfig = {};
            if (data) data.forEach(item => { state.scheduleConfig[item.location] = item.work_days || []; });
            renderLocationButtons();
        };

        const renderLocationButtons = () => {
            const container = document.getElementById('location-buttons-container');
            container.innerHTML = '';
            const locations = Object.keys(state.scheduleConfig);
            if (locations.length > 0) {
                locations.forEach(location => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.dataset.location = location;
                    btn.textContent = location;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = `<p style="text-align:center; color: #666;">Nessuna sede configurata.</p>`;
            }
        };
        
        const renderStudentBookingSummary = async () => {
            const summaryDiv = document.getElementById('student-bookings-summary');
            summaryDiv.innerHTML = '<h4>Le Tue Prossime Lezioni</h4>';
            showLoading(true);
            const today = formatDate(new Date());
            const { data: myFutureBookings, error } = await supabaseClient
                .from('bookings')
                .select('*')
                .eq('user_code', state.currentUser.code)
                .gte('date', today)
                .order('date', { ascending: true })
                .order('start_time', { ascending: true });
            showLoading(false);

            if (error) {
                console.error("Error fetching bookings:", error);
                summaryDiv.innerHTML += "<p>Impossibile caricare le prenotazioni.</p>";
                return;
            }

            if (myFutureBookings.length > 0) {
                myFutureBookings.forEach(booking => {
                    const lessonStart = new Date(`${booking.date}T${booking.start_time}`);
                    const now = new Date();
                    const hoursUntilLesson = (lessonStart - now) / (1000 * 60 * 60);

                    // Aggiunta gestione per richiesta cambio, se vuoi implementarla
                    let changeButtonHtml = `<button class="btn btn-secondary btn-sm" disabled>Cambio non disp.</button>`;
                    if (hoursUntilLesson > 36) {
                        changeButtonHtml = `<button class="btn btn-secondary btn-sm btn-request-change" data-booking-id="${booking.id}">Richiedi Cambio</button>`;
                    }

                    summaryDiv.innerHTML += `
                        <div class="student-list-item" style="background-color: #e9ecef; margin-bottom: 0.5rem;">
                            <span>
                                <strong>${new Date(booking.date + 'T00:00:00').toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</strong><br>
                                <small>Ore: ${booking.start_time.substring(0,5)} - ${booking.end_time.substring(0,5)} (${booking.location})</small>
                            </span>
                            </div>
                    `;
                });
            } else {
                summaryDiv.innerHTML = "<p style='text-align:center;'>Nessuna lezione futura prenotata.</p><hr>";
            }
        };

        const updateAdminUI = () => {
            document.getElementById('admin-actions').innerHTML = `
                <button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button>
                <button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button>
            `;
        };

        const logout = () => {
            showConfirm('Uscita', 'Sei sicuro di voler uscire?', () => {
                state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, allUsers: [] };
                state.currentDate.setDate(1);
                document.getElementById('student-code').value = '';
                document.getElementById('student-bookings-summary').innerHTML = '';
                navigateTo('login-screen');
            });
        };

        // --- 5. GESTIONE CALENDARIO E ORARI ---
        const isDayOfWeekAvailable = (date, location) => {
            const dayOfWeek = date.getDay(); // 0 = Domenica, 1 = Lunedì...
            return state.scheduleConfig[location]?.includes(dayOfWeek) || false;
        };

        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('time-slots-container').style.display = 'none';
            document.getElementById('booking-admin-actions').innerHTML = '';
            state.selectedDate = null;
            
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Allineamento a Lunedì = 0
            
            for (let i = 0; i < dayOfWeek; i++) { calendarGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.classList.add('calendar-day');
                // Controlla se il giorno è nel futuro
                if (date < new Date(new Date().toDateString())) {
                     dayEl.classList.add('invalid');
                } else if (isDayOfWeekAvailable(date, state.currentLocation)) {
                    dayEl.classList.add('valid');
                    dayEl.dataset.date = formatDate(date);
                } else {
                    dayEl.classList.add('invalid');
                }
                calendarGrid.appendChild(dayEl);
            }
        };
        
        const renderTimeSlots = async (date) => {
            state.selectedDate = date;
            const dateStr = formatDate(date);
            document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
            document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');

            document.getElementById('selected-date-label').textContent = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('time-slots-container').style.display = 'block';
            
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = '';

            if (state.currentUser.role === 'admin') {
                document.getElementById('booking-admin-actions').innerHTML = `
                    <div class="day-week-controls">
                        <button id="block-day-btn" class="btn btn-danger btn-sm">Blocca Giorno</button>
                        <button id="unblock-day-btn" class="btn btn-success btn-sm">Sblocca Giorno</button>
                        <button id="block-week-btn" class="btn btn-danger btn-sm">Blocca Settimana</button>
                        <button id="unblock-week-btn" class="btn btn-success btn-sm">Sblocca Settimana</button>
                    </div>`;
                await renderAdminTimeGrid(dateStr, state.currentLocation);
            } else {
                await renderStudentTimeSlots(dateStr, state.currentLocation);
            }
        };

        const renderAdminTimeGrid = async (dateStr, location) => {
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = 'Caricamento orari...';
            showLoading(true);
            
            const { data: bookings, error: bookingsError } = await supabaseClient.from('bookings').select('*, users(name)').eq('date', dateStr).eq('location', location);
            const { data: blocked, error: blockedError } = await supabaseClient.from('blocked_slots').select('*').eq('date', dateStr).eq('location', location);
            
            showLoading(false);
            if (bookingsError) {
                console.error(bookingsError);
                showAlert('Errore nel database', 'Non è stato possibile caricare le prenotazioni. Assicurati che il collegamento tra le tabelle `bookings` e `users` sia stato creato correttamente nel SQL Editor di Supabase.');
                return;
            }
            if (blockedError) {
                console.error(blockedError);
                showAlert('Errore', 'Non è stato possibile caricare gli orari bloccati.');
                return;
            }

            const slots = generateTimeSlots(15, 21, 15);
            let gridHtml = '<div class="admin-time-grid">';
            gridHtml += slots.map(slot => {
                let status = 'free';
                let tooltip = `Orario: ${slot}, Libero`;
                const booking = bookings.find(b => slot >= b.start_time.substring(0, 5) && slot < b.end_time.substring(0, 5));
                if (booking) {
                    status = 'booked';
                    tooltip = `Occupato da: ${booking.users ? booking.users.name : 'Utente Sconosciuto'}`;
                } else {
                    const isBlocked = blocked.some(b => slot >= b.start_time.substring(0, 5) && slot < b.end_time.substring(0, 5));
                    if (isBlocked) { status = 'blocked'; tooltip = 'Bloccato'; }
                }
                return `<div class="time-slot ${status}" data-time="${slot}" title="${tooltip}">${slot}</div>`;
            }).join('');
            gridHtml += '</div>';
            slotsContent.innerHTML = gridHtml;
        };
        
        const renderStudentTimeSlots = async (dateStr, location) => {
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = 'Caricamento orari disponibili...';
            showLoading(true);

            const { data: bookings, error: bErr } = await supabaseClient.from('bookings').select('start_time, end_time').eq('date', dateStr).eq('location', location);
            const { data: blocked, error: blErr } = await supabaseClient.from('blocked_slots').select('start_time, end_time').eq('date', dateStr).eq('location', location);

            showLoading(false);
            if (bErr || blErr) return console.error(bErr || blErr);

            const allEventsOnDate = [...bookings, ...blocked];

            const isTimespanFree = (checkStart, checkEnd) => {
                for (const event of allEventsOnDate) {
                    const eventStart = new Date(`${dateStr}T${event.start_time}`);
                    const eventEnd = new Date(`${dateStr}T${event.end_time}`);
                    if (checkStart < eventEnd && checkEnd > eventStart) return false;
                }
                return true;
            };

            const getAvailableSlots = (duration) => {
                const available = new Set();
                const allPossibleSlots = generateTimeSlots(15, 21, 15);
                
                allPossibleSlots.forEach(timeStr => {
                    const potentialStart = new Date(`${dateStr}T${timeStr}`);
                    const now = new Date();
                    const hoursUntilSlot = (potentialStart - now) / (1000 * 60 * 60);
                    if (hoursUntilSlot <= 12) return;

                    const potentialEnd = new Date(potentialStart.getTime() + duration * 60000);
                    if (potentialEnd <= new Date(`${dateStr}T21:00:00`) && isTimespanFree(potentialStart, potentialEnd)) {
                        available.add(timeStr);
                    }
                });
                return Array.from(available).sort();
            };

            const slots45 = getAvailableSlots(45);
            const slots60 = getAvailableSlots(60);
            
            let html = `<h4>Crea Nuova Prenotazione</h4><div class="student-time-slots">`;
            if (slots45.length === 0 && slots60.length === 0) {
                html += "<p>Nessun orario disponibile per oggi.</p>";
            } else {
                if (slots45.length > 0) {
                    html += '<h5>Lezione da 45 minuti</h5>';
                    slots45.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn btn-primary btn-sm btn-book" data-time="${slot}" data-duration="45">Prenota</button></div>`; });
                }
                if (slots60.length > 0) {
                    html += '<h5>Lezione da 60 minuti</h5>';
                    slots60.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn btn-primary btn-sm btn-book" data-time="${slot}" data-duration="60">Prenota</button></div>`; });
                }
            }
            html += '</div>';
            slotsContent.innerHTML = html;
        };

        // --- 6. FUNZIONI ADMIN ---
        const renderStudentList = async () => {
            const listDiv = document.getElementById('student-list');
            listDiv.innerHTML = '';
            showLoading(true);
            const { data: users, error } = await supabaseClient.from('users').select('*').eq('role', 'student').order('name');
            showLoading(false);
            if (error) { return console.error("Errore caricamento allievi:", error); }
            users.forEach(student => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'student-list-item';
                itemDiv.innerHTML = `
                    <div class="student-info">${student.name}<br><small style="color: #6c757d;">Codice: ${student.code}</small></div>
                    <div class="student-actions">
                        <button class="btn btn-secondary btn-sm btn-edit-student" data-id="${student.id}" data-name="${student.name}" data-code="${student.code}">Modifica</button>
                        <button class="btn btn-danger btn-sm btn-delete-student" data-id="${student.id}" data-name="${student.name}">Elimina</button>
                    </div>`;
                listDiv.appendChild(itemDiv);
            });
        };
        const showUserModal = (isEdit, userData) => {
            document.getElementById('user-modal-title').textContent = isEdit ? 'Modifica Allievo' : 'Crea Nuovo Allievo';
            document.getElementById('user-modal-name').value = userData.name || '';
            document.getElementById('user-modal-code').value = userData.code || '';
            const saveBtn = document.getElementById('user-modal-save');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.onclick = () => handleSaveUser(userData.id);
            document.getElementById('user-modal-overlay').style.display = 'flex';
        };
        const handleSaveUser = async (userId) => {
            const name = document.getElementById('user-modal-name').value.trim();
            const code = document.getElementById('user-modal-code').value.toUpperCase().trim();
            if (!name || !code) { return showAlert("Nome e Codice non possono essere vuoti."); }
            showLoading(true);
            const { error } = userId ? 
                await supabaseClient.from('users').update({ name, code }).eq('id', userId) :
                await supabaseClient.from('users').insert({ name, code, role: 'student' });
            showLoading(false);
            if (error) { return showAlert("Errore: il codice potrebbe essere già in uso."); }
            showAlert(`Allievo "${name}" salvato.`);
            await renderStudentList();
            document.getElementById('user-modal-overlay').style.display = 'none';
        };
        const deleteUser = (userId, userName) => {
            showConfirm('Elimina Allievo', `Sei sicuro di voler eliminare "${userName}"? <br>Verranno eliminate anche tutte le sue prenotazioni.`, async () => {
                showLoading(true);
                const { data: userToDelete, error: userError } = await supabaseClient.from('users').select('code').eq('id', userId).single();
                if (userError) { showLoading(false); return showAlert("Utente non trovato."); }
                if (userToDelete) { await supabaseClient.from('bookings').delete().eq('user_code', userToDelete.code); }
                const { error } = await supabaseClient.from('users').delete().eq('id', userId);
                showLoading(false);
                if (error) { return showAlert("Errore durante l'eliminazione."); }
                showAlert("Allievo eliminato.");
                await renderStudentList();
            });
        };
        const renderScheduleSettings = async () => {
            const contentDiv = document.getElementById('schedule-settings-content');
            contentDiv.innerHTML = '';
            const daysOfWeek = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            showLoading(true);
            const { data, error } = await supabaseClient.from('schedule_config').select('*').order('location');
            showLoading(false);
            if(error) { return console.error("Errore caricamento impostazioni:", error); }
            data.forEach(locationData => {
                let locationHtml = `<div style="border:1px solid #eee; padding:1rem; border-radius:8px; margin-bottom:1rem;"><div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0;">${locationData.location}</h4><button class="btn btn-danger btn-sm btn-remove-location" data-location="${locationData.location}">&times; Rimuovi</button></div><div class="days-checkboxes" data-location="${locationData.location}" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;">`;
                for (let i = 1; i <= 6; i++) {
                    const isChecked = (locationData.work_days || []).includes(i);
                    locationHtml += `<div><input type="checkbox" id="${locationData.location}-${i}" value="${i}" ${isChecked ? 'checked' : ''}><label for="${locationData.location}-${i}" style="margin-left:0.25rem;">${daysOfWeek[i]}</label></div>`;
                }
                // Aggiungiamo anche la domenica
                 const isSundayChecked = (locationData.work_days || []).includes(0);
                 locationHtml += `<div><input type="checkbox" id="${locationData.location}-0" value="0" ${isSundayChecked ? 'checked' : ''}><label for="${locationData.location}-0" style="margin-left:0.25rem;">${daysOfWeek[0]}</label></div>`;

                locationHtml += `</div></div>`;
                contentDiv.innerHTML += locationHtml;
            });
        };
        const saveScheduleSettings = async () => {
            const newConfig = [];
            document.querySelectorAll('.days-checkboxes').forEach(div => {
                const location = div.dataset.location;
                const work_days = [];
                div.querySelectorAll('input[type="checkbox"]:checked').forEach(box => { work_days.push(parseInt(box.value)); });
                newConfig.push({ location, work_days });
            });
            showLoading(true);
            // Upsert per semplicità: inserisce o aggiorna
            const { error } = await supabaseClient.from('schedule_config').upsert(newConfig, { onConflict: 'location' });
            showLoading(false);
            if(error) { showAlert(`Errore nel salvataggio: ${error.message}`); console.error(error); } 
            else { showAlert("Impostazioni salvate."); await loadInitialData(); navigateTo('main-screen'); }
        };
        const addLocation = async () => {
            const input = document.getElementById('new-location-name');
            const newLocationName = input.value.trim();
            if (!newLocationName) return;
            showLoading(true);
            const { error } = await supabaseClient.from('schedule_config').insert({ location: newLocationName, work_days: [] });
            showLoading(false);
            if(error) { showAlert("Errore: la sede potrebbe già esistere."); } 
            else { await renderScheduleSettings(); input.value = ''; }
        };
        const removeLocation = (locationToRemove) => {
            showConfirm('Rimuovi Sede', `Sei sicuro di voler rimuovere la sede "${locationToRemove}"?`, async () => {
                showLoading(true);
                await supabaseClient.from('bookings').delete().eq('location', locationToRemove);
                await supabaseClient.from('blocked_slots').delete().eq('location', locationToRemove);
                const { error } = await supabaseClient.from('schedule_config').delete().eq('location', locationToRemove);
                showLoading(false);
                if(error) { showAlert("Errore durante la rimozione."); } 
                else { await renderScheduleSettings(); await loadInitialData(); }
            });
        };

        const handleBlockUnblockDay = (block = true) => {
            if (!state.selectedDate) return;
            const action = block ? 'bloccare' : 'sbloccare';
            showConfirm(`Conferma ${action}`, `Sei sicuro di voler ${action} l'intera giornata del ${state.selectedDate.toLocaleDateString('it-IT')}?`, async () => {
                const dateStr = formatDate(state.selectedDate);
                showLoading(true);
                await supabaseClient.from('blocked_slots').delete().eq('date', dateStr).eq('location', state.currentLocation);
                if (block) {
                    const { error } = await supabaseClient.from('blocked_slots').insert({
                        location: state.currentLocation, date: dateStr, start_time: '15:00', end_time: '21:00'
                    });
                    if (error) showAlert(`Errore durante il blocco: ${error.message}`);
                }
                showLoading(false);
                await renderTimeSlots(state.selectedDate);
            });
        };

        const handleBlockUnblockWeek = (block = true) => {
            if (!state.selectedDate) return;
            const action = block ? 'bloccare' : 'sbloccare';
            const date = new Date(state.selectedDate);
            const dayOfWeek = date.getDay() === 0 ? 6 : date.getDay() - 1;
            const weekStart = new Date(date.setDate(date.getDate() - dayOfWeek));

            showConfirm(`Conferma ${action}`, `Sei sicuro di voler ${action} tutti i giorni lavorativi di questa settimana?`, async () => {
                showLoading(true);
                const promises = [];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    if (isDayOfWeekAvailable(day, state.currentLocation)) {
                        const dateStr = formatDate(day);
                        promises.push(supabaseClient.from('blocked_slots').delete().eq('date', dateStr).eq('location', state.currentLocation));
                        if(block) {
                             promises.push(supabaseClient.from('blocked_slots').insert({
                                location: state.currentLocation, date: dateStr, start_time: '15:00', end_time: '21:00'
                            }));
                        }
                    }
                }
                await Promise.all(promises);
                showLoading(false);
                await renderTimeSlots(state.selectedDate);
            });
        };
        
        // --- 7. EVENT LISTENERS ---
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        document.getElementById('location-buttons-container').addEventListener('click', (e) => {
            const location = e.target.dataset.location;
            if (location) {
                state.currentLocation = location;
                document.getElementById('booking-location-title').textContent = `Sede di ${location}`;
                state.currentDate = new Date();
                state.currentDate.setDate(1);
                renderCalendar();
                navigateTo('booking-screen');
            }
        });

        document.getElementById('booking-screen').addEventListener('click', async (e) => {
            if (e.target.id === 'back-to-main-btn') {
                 if (state.currentUser.role === 'student') await renderStudentBookingSummary();
                 return navigateTo('main-screen');
            }
            if (e.target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
            if (e.target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
            if (e.target.classList.contains('valid')) {
                const date = new Date(e.target.dataset.date + 'T12:00:00');
                await renderTimeSlots(date);
            }
            if (e.target.id === 'block-day-btn') handleBlockUnblockDay(true);
            if (e.target.id === 'unblock-day-btn') handleBlockUnblockDay(false);
            if (e.target.id === 'block-week-btn') handleBlockUnblockWeek(true);
            if (e.target.id === 'unblock-week-btn') handleBlockUnblockWeek(false);
        });

        document.getElementById('slots-content').addEventListener('click', async (e) => {
            const target = e.target;
            // Studente prenota
            if (target.classList.contains('btn-book')) {
                const startTime = target.dataset.time;
                const duration = parseInt(target.dataset.duration);
                showConfirm('Conferma Prenotazione', `Confermi la prenotazione per ${state.selectedDate.toLocaleDateString('it-IT')} alle ${startTime} per ${duration} minuti?`, async () => {
                    const slotEnd = new Date(new Date(`${formatDate(state.selectedDate)}T${startTime}`).getTime() + duration * 60000);
                    showLoading(true);
                    const { error } = await supabaseClient.from('bookings').insert({
                        user_code: state.currentUser.code, location: state.currentLocation, date: formatDate(state.selectedDate),
                        start_time: startTime, end_time: formatTime(slotEnd), is_package: false
                    });
                    showLoading(false);
                    if (error) { showAlert(`Errore nella prenotazione: ${error.message}`); } 
                    else { showAlert('Prenotazione effettuata!'); await renderTimeSlots(state.selectedDate); }
                });
            }
            // Admin clicca su uno slot
            else if (state.currentUser?.role === 'admin' && target.classList.contains('time-slot')) {
                const time = target.dataset.time;
                const dateStr = formatDate(state.selectedDate);
                
                let modalContent = `
                    <div class="form-group">
                        <label>Azione per l'orario ${time}:</label>
                        <button id="modal-assign-lesson" class="btn btn-primary">Assegna Lezione</button>
                        <button id="modal-block-slot" class="btn btn-danger">Blocca Orario</button>
                        <button id="modal-unblock-slot" class="btn btn-success">Sblocca Orario</button>
                    </div>
                `;
                showModal(`Gestisci Orario ${time}`, modalContent, [{ text: 'Chiudi', class: 'btn-secondary' }]);

                document.getElementById('modal-assign-lesson').onclick = () => {
                    let studentOptions = state.allUsers.map(u => `<option value="${u.code}">${u.name} (${u.code})</option>`).join('');
                    let assignContent = `
                        <div class="form-group"><label for="student-select">Seleziona Allievo:</label><select id="student-select">${studentOptions}</select></div>
                        <div class="form-group"><label for="duration-input">Durata (minuti):</label><input type="number" id="duration-input" value="45"></div>
                    `;
                    showConfirm('Assegna Lezione', assignContent, async () => {
                        const studentCode = document.getElementById('student-select').value;
                        const duration = parseInt(document.getElementById('duration-input').value);
                        if (studentCode && duration > 0) {
                            const endTime = formatTime(new Date(new Date(`${dateStr}T${time}`).getTime() + duration * 60000));
                            showLoading(true);
                            await supabaseClient.from('bookings').insert({ user_code: studentCode, location: state.currentLocation, date: dateStr, start_time: time, end_time: endTime, is_package: false });
                            showLoading(false);
                            await renderTimeSlots(state.selectedDate);
                        }
                    });
                };
                document.getElementById('modal-block-slot').onclick = () => {
                     let blockContent = `<div class="form-group"><label for="block-duration-input">Durata blocco (minuti):</label><input type="number" id="block-duration-input" value="15"></div>`;
                     showConfirm('Blocca Orario', blockContent, async () => {
                         const duration = parseInt(document.getElementById('block-duration-input').value);
                         if (duration > 0) {
                            const endTime = formatTime(new Date(new Date(`${dateStr}T${time}`).getTime() + duration * 60000));
                            showLoading(true);
                            await supabaseClient.from('blocked_slots').insert({ location: state.currentLocation, date: dateStr, start_time: time, end_time: endTime });
                            showLoading(false);
                            await renderTimeSlots(state.selectedDate);
                         }
                     });
                };
                 document.getElementById('modal-unblock-slot').onclick = () => {
                     showConfirm('Sblocca Orario', `Sei sicuro di voler rimuovere tutti i blocchi che iniziano alle ${time}?`, async () => {
                        showLoading(true);
                        await supabaseClient.from('blocked_slots').delete().eq('location', state.currentLocation).eq('date', dateStr).eq('start_time', time);
                        showLoading(false);
                        await renderTimeSlots(state.selectedDate);
                     });
                };
            }
        });
        
        mainEl.addEventListener('click', async (e) => {
            if (e.target.id === 'manage-students-btn') { await renderStudentList(); navigateTo('student-list-screen'); }
            if (e.target.id === 'manage-schedule-btn') { await renderScheduleSettings(); navigateTo('schedule-settings-screen'); }
            if (e.target.id === 'back-to-main-from-student-list-btn' || e.target.id === 'back-to-main-from-schedule-settings-btn') { navigateTo('main-screen'); }
        });

        document.getElementById('student-list-screen').addEventListener('click', (e) => {
            if (e.target.id === 'create-student-btn') showUserModal(false, {});
            if (e.target.classList.contains('btn-edit-student')) { showUserModal(true, e.target.dataset); }
            if (e.target.classList.contains('btn-delete-student')) { deleteUser(e.target.dataset.id, e.target.dataset.name); }
        });

        document.getElementById('schedule-settings-screen').addEventListener('click', async (e) => {
            if (e.target.id === 'add-location-btn') await addLocation();
            if (e.target.id === 'save-schedule-settings-btn') await saveScheduleSettings();
            if (e.target.classList.contains('btn-remove-location')) removeLocation(e.target.dataset.location);
        });

        document.getElementById('user-modal-cancel').addEventListener('click', () => { document.getElementById('user-modal-overlay').style.display = 'none'; });
    });
</script>