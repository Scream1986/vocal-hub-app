<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --header-bg: #000; --button-primary-bg: #ffc107; --button-primary-text: #000; --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545; --light-color: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--light-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
        .app-container { width: 100%; max-width: 480px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background-color: var(--header-bg); color: white; text-align: center; }
        main { padding: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        h2, h3, h4, h5 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { min-height: 80px; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-logout { background-color: var(--danger-color); color: white; margin-top: 1rem; }
        #loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background-color: rgba(255,255,255,0.8); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .modal-buttons .btn { width: auto; margin-top: 0; }
        .student-list-item { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .student-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #f8f9fa; }
        .student-info { font-weight: 500; }
        .student-actions .btn { width: auto; margin: 0 0.25rem; }
        .student-details { display: none; padding: 1rem; border-top: 1px solid #ddd; background-color: #fdfdfd; }
        .student-stats { display: flex; justify-content: space-around; text-align: center; margin-bottom: 1rem; }
        .stat-item span { display: block; font-size: 1.2rem; font-weight: bold; }
        .calendar { margin-top: 1.5rem; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .weekday { padding: 0.75rem 0.25rem; border-radius: 4px; }
        .weekday { font-weight: bold; }
        .calendar-day.invalid { color: #ccc; pointer-events: none; }
        .calendar-day.valid { background-color: #ffffff; border: 1px solid #ddd; cursor: pointer; }
        .calendar-day.selected { background-color: var(--button-primary-bg); color: var(--button-primary-text); font-weight: bold; border: 1px solid var(--button-primary-bg); }
        .admin-time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
        .time-slot { padding: 0.5rem; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.9rem; color: white; border: 1px solid rgba(0, 0, 0, 0.1); }
        .time-slot.free { background-color: var(--success-color); }
        .time-slot.booked { background-color: var(--secondary-color); }
        .time-slot.blocked { background-color: var(--danger-color); }
        .student-time-slots .available-slot, .booked-slot { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-time-slots .btn-book, .booked-slot .btn-request-change { padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; border: none; border-radius: 4px; flex-shrink: 0; margin-left: 1rem; }
        .student-time-slots .btn-book { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .booked-slot { background-color: #e9ecef; }
        .btn-request-change { background-color: var(--secondary-color); color: white; }
        .btn-request-change:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; border: 1px solid #ddd; }
        #booking-admin-actions .day-week-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .admin-tool-card { background: #fff; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1.5rem; }
        .time-inputs-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem; align-items: center; }
        #block-modal-form .form-group { display: flex; align-items: center; gap: 0.5rem; }
        #block-modal-form .form-group label { flex-shrink: 0; margin-bottom: 0; text-align: left; }
        #block-modal-form .form-group input[type="number"] { width: 70px; }
        #duration-selection-container { margin: 1.5rem 0; }
        #duration-selection-container div { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    </style>
</head>
<body>
    <div id="loading-spinner">Caricamento...</div>
    <div class="app-container">
        <header id="app-header" style="padding: 0.5rem;">
            <img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>
        <main>
            <div id="login-screen" class="screen active"><h2>Accesso</h2><div class="form-group"><label for="student-code">Codice Allievo</label><input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off"></div><button id="login-btn" class="btn btn-primary">Accedi</button></div>
            
            <div id="main-screen" class="screen">
                <h2 id="welcome-message"></h2>
                <div id="lesson-counter-display"></div>
                <div id="student-bookings-summary"></div>
                <div id="student-actions" style="margin-top: 1rem; margin-bottom: 1.5rem;"><button id="view-history-btn" class="btn btn-secondary">Storico Lezioni</button></div>
                <hr>
                <p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p>
                <div id="location-buttons-container"></div>
                <div id="admin-actions" style="margin-top: 1.5rem;"></div>
                <button id="logout-btn" class="btn btn-logout">Esci</button>
            </div>

            <div id="booking-screen" class="screen">
                <h2 id="booking-location-title"></h2>
                <div id="booking-admin-actions"></div>
                <div class="calendar">
                    <div id="calendar-header">
                        <button id="prev-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&lt;</button>
                        <h3 id="month-year-label"></h3>
                        <button id="next-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&gt;</button>
                    </div>
                    <div id="calendar-weekdays"><div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div></div>
                    <div id="calendar-grid"></div>
                </div>
                <div id="duration-selection-container" style="display:none;"></div>
                <div id="time-slots-container" style="display:none; margin-top: 1rem;">
                    <h3>Orari per il <span id="selected-date-label"></span></h3>
                    <div id="slots-content"></div>
                </div>
                <button id="back-to-main-btn" class="btn btn-secondary" style="margin-top: 2rem;">Torna Indietro</button>
            </div>
            
            <div id="other-screens">
                <div id="schedule-screen" class="screen"><h2>Orari della Settimana</h2><div id="schedule-header"><button id="prev-week-btn" class="btn btn-secondary btn-sm">&lt; Prec.</button><h4 id="week-label" style="margin:0;"></h4><button id="next-week-btn" class="btn btn-secondary btn-sm">Succ. &gt;</button></div><div id="schedule-grid" style="margin-top: 1rem;"></div><button id="back-to-main-from-schedule-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button></div>
                <div id="schedule-settings-screen" class="screen"><h2>Impostazioni Calendario</h2><div id="schedule-settings-content"></div><hr><div class="form-group"><label for="new-location-name">Aggiungi una nuova sede</label><input type="text" id="new-location-name" placeholder="Nome nuova sede"><button id="add-location-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Aggiungi Sede</button></div><button id="save-schedule-settings-btn" class="btn btn-primary">Salva Modifiche</button><button id="back-to-main-from-schedule-settings-btn" class="btn btn-secondary">Torna Indietro</button></div>
                <div id="student-list-screen" class="screen"><h2>Gestione Allievi</h2><button id="create-student-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Crea Nuovo Allievo</button><div id="student-list"></div><button id="back-to-main-from-student-list-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button></div>
                <div id="notifications-screen" class="screen"><h2>Notifiche Studenti</h2><div id="notifications-list"></div><button id="back-to-main-from-notifications-btn" class="btn btn-secondary">Torna Indietro</button></div>
                <div id="history-screen" class="screen"><h2>Storico Lezioni</h2><div id="past-bookings-list"></div><button id="back-to-main-from-history-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button></div>
            </div>
        </main>
    </div>
    <div id="user-modal-overlay" class="modal-overlay"><div class="modal-content"><h4 id="user-modal-title"></h4><div class="form-group"><label for="user-modal-name">Nome Allievo</label><input type="text" id="user-modal-name"></div><div class="form-group"><label for="user-modal-code">Codice Allievo</label><input type="text" id="user-modal-code" autocomplete="off"></div><div class="modal-buttons"><button id="user-modal-cancel" class="btn btn-secondary">Annulla</button><button id="user-modal-save" class="btn btn-primary">Salva</button></div></div></div>

    <div id="block-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h4 id="block-modal-title">Gestisci Blocco Orario</h4>
            <p id="block-modal-info" style="font-size: 0.9rem; color: #666;"></p>
            <form id="block-modal-form">
                <div class="form-group"><label for="block-end-time">Fino alle ore:</label><input type="time" id="block-end-time" step="900" required></div><hr>
                <p style="font-weight: 500; text-align:left;">Applica questa regola:</p>
                <div class="form-group"><input type="radio" id="recurrence-once" name="recurrence" value="once" checked><label for="recurrence-once">Solo per questo giorno</label></div>
                <div class="form-group"><input type="radio" id="recurrence-weekly" name="recurrence" value="weekly"><label for="recurrence-weekly">Per</label><input type="number" id="recurrence-weeks" min="1" value="4"><label for="recurrence-weeks">settimane</label></div>
                <div class="form-group"><input type="radio" id="recurrence-forever" name="recurrence" value="forever"><label for="recurrence-forever">Per sempre</label></div>
                <div id="block-modal-buttons" class="modal-buttons">
                    <button type="button" id="block-modal-cancel" class="btn btn-secondary">Annulla</button>
                    <button type="submit" id="block-modal-unblock" class="btn btn-success">Sblocca Orario</button>
                    <button type="submit" id="block-modal-block" class="btn btn-danger">Blocca Orario</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, calendarPollingInterval: null, locationsToDelete: [] };
        state.currentDate.setDate(1);
        const loadingSpinner = document.getElementById('loading-spinner');
        
        const screens = {};
        document.querySelectorAll('main > .screen, #other-screens > .screen').forEach(el => screens[el.id] = el);

        const blockModal = {
            overlay: document.getElementById('block-modal-overlay'),
            info: document.getElementById('block-modal-info'),
            endTime: document.getElementById('block-end-time'),
            form: document.getElementById('block-modal-form'),
            unblockBtn: document.getElementById('block-modal-unblock'),
            blockBtn: document.getElementById('block-modal-block')
        };

        const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
        const navigateTo = (screenId) => {
            if (state.calendarPollingInterval) { clearInterval(state.calendarPollingInterval); state.calendarPollingInterval = null; }
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        };
        const formatDate = (date) => {
            if (!date || !(date instanceof Date)) return null;
            return date.toISOString().split('T')[0];
        };
        const formatTime = (timeStr) => timeStr ? timeStr.substring(0, 5) : '';

        const login = async () => {
            const code = document.getElementById('student-code').value.toUpperCase().trim();
            if (!code) return;
            showLoading(true);
            const { data: user, error } = await supabase.from('users').select('*').eq('code', code).single();
            showLoading(false);
            if (error && error.code !== 'PGRST116') return alert(`Errore: ${error.message}`);
            
            if (user) {
                state.currentUser = user;
                document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
                await loadInitialData();
                if (user.role === 'admin') updateAdminUI();
                else renderStudentBookingSummary();
                navigateTo('main-screen');
            } else {
                alert('Codice non valido.');
            }
        };

        const loadInitialData = async () => {
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('*');
            showLoading(false);
            if (error) return console.error("Errore caricamento config:", error);
            state.scheduleConfig = {};
            if (data) data.forEach(item => {
                state.scheduleConfig[item.location] = {
                    work_days: item.work_days || [],
                    start_time_am: item.start_time_am || '09:00:00',
                    end_time_am: item.end_time_am || '13:00:00',
                    start_time_pm: item.start_time_pm || '15:00:00',
                    end_time_pm: item.end_time_pm || '21:00:00'
                };
            });
            renderLocationButtons();
        };

        const renderLocationButtons = () => {
            const container = document.getElementById('location-buttons-container');
            container.innerHTML = '';
            const locations = Object.keys(state.scheduleConfig);
            if (locations.length > 0) {
                locations.forEach(location => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.dataset.location = location;
                    btn.textContent = location;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = `<p style="text-align:center;">Nessuna sede configurata.</p>`;
            }
        };

        const updateAdminUI = async () => {
            const adminActionsDiv = document.getElementById('admin-actions');
            const { count } = await supabase.from('notifications').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            adminActionsDiv.innerHTML = `<button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button><button id="view-schedule-btn" class="btn btn-primary">Orari Generali</button><button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button><button id="view-notifications-btn" class="btn btn-secondary">Notifiche (${count ?? 0})</button>`;
        };

        const logout = () => {
            state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, calendarPollingInterval: null, locationsToDelete: [] };
            state.currentDate.setDate(1);
            document.getElementById('student-code').value = '';
            navigateTo('login-screen');
        };
        
        const renderStudentBookingSummary = async () => {
            const summaryDiv = document.getElementById('student-bookings-summary');
            const counterDisplay = document.getElementById('lesson-counter-display');
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const { data: bookings, error } = await supabase.from('bookings').select('*').eq('user_code', state.currentUser.code).gte('date', formatDate(today)).order('date').order('start_time');
            
            if (error) return;
            const count = bookings ? bookings.length : 0;
            const used = state.currentUser.changes_used ?? 0;
            const allowed = state.currentUser.changes_allowed ?? 0;

            counterDisplay.innerHTML = `<div style="text-align:center; font-size: 1.1rem; color: #333; margin-bottom: 0.5rem; border: 1px solid #eee; padding: 0.75rem; border-radius: 8px; background-color: #f8f9fa;">Hai <strong>${count}</strong> lezioni in programma.</div><div style="text-align:center; font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">Cambi utilizzati: <strong>${used} / ${allowed}</strong></div>`;

            if (count > 0) {
                summaryDiv.innerHTML = '<h4>Le Tue Prossime Lezioni</h4>' + bookings.map(booking => {
                    const lessonStart = new Date(`${booking.date}T${booking.start_time}`);
                    const canRequestChange = (lessonStart - new Date()) / 36e5 > 36;
                    return `<div class="booked-slot"><span><strong>${lessonStart.toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</strong><br><small>Ore: ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)} (${booking.location})</small></span><button class="btn-request-change" data-booking-id="${booking.id}" ${canRequestChange ? '' : 'disabled'}>${canRequestChange ? 'Richiedi Cambio' : 'Scaduto'}</button></div>`;
                }).join('');
            } else {
                summaryDiv.innerHTML = `<p style='text-align:center;'>Nessuna lezione futura prenotata.</p>`;
            }
        };
        
        const isDayOfWeekAvailable = (date, location) => state.scheduleConfig[location]?.work_days?.includes(date.getDay()) || false;
        
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            ['time-slots-container', 'duration-selection-container'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById('booking-admin-actions').innerHTML = '';
            state.selectedDate = null;

            const year = state.currentDate.getFullYear(), month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            let dayOfWeek = (firstDay.getDay() + 6) % 7; 
            for (let i = 0; i < dayOfWeek; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'calendar-day ' + (isDayOfWeekAvailable(date, state.currentLocation) ? 'valid' : 'invalid');
                if (dayEl.classList.contains('valid')) dayEl.dataset.date = formatDate(date);
                calendarGrid.appendChild(dayEl);
            }
        };
        
        const handleDateSelection = async (dateStr) => {
            state.selectedDate = new Date(dateStr + 'T00:00:00Z');
            document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
            document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');
            document.getElementById('selected-date-label').textContent = state.selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('time-slots-container').style.display = 'none';
            
            if (state.currentUser.role === 'admin') {
                document.getElementById('duration-selection-container').style.display = 'none';
                document.getElementById('booking-admin-actions').innerHTML = `<div class="day-week-controls"><button id="block-day-btn" class="btn btn-danger">Blocca Giorno</button><button id="unblock-day-btn" class="btn btn-success">Sblocca Giorno</button></div> <div class="day-week-controls"><button id="block-week-btn" class="btn btn-danger">Blocca Settimana</button><button id="unblock-week-btn" class="btn btn-success">Sblocca Settimana</button></div>`;
                await renderTimeSlots(dateStr);
            } else {
                document.getElementById('booking-admin-actions').innerHTML = '';
                const durationContainer = document.getElementById('duration-selection-container');
                durationContainer.innerHTML = `<h4>Scegli la durata della lezione:</h4><div><button class="btn btn-secondary btn-duration" data-duration="45">45 min</button><button class="btn btn-secondary btn-duration" data-duration="60">60 min</button></div>`;
                durationContainer.style.display = 'block';
            }
        };

        const renderTimeSlots = async (dateStr, duration = null) => {
            if (!dateStr) return;
            
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = 'Cerco disponibilità...';
            document.getElementById('time-slots-container').style.display = 'block';

            const locationConfig = state.scheduleConfig[state.currentLocation];
            const selectedDayOfWeek = new Date(dateStr + 'T00:00:00Z').getDay();

            const { data: bookings } = await supabase.from('bookings').select('start_time, end_time, users(name)').eq('date', dateStr).eq('location', state.currentLocation);
            const { data: rules } = await supabase.from('availability_rules').select('*').eq('location', state.currentLocation).eq('day_of_week', selectedDayOfWeek).lte('start_date', dateStr);
            
            const activeRules = (rules || []).filter(rule => !rule.end_date || new Date(rule.end_date) >= new Date(dateStr + 'T00:00:00Z'));

            const slotsMap = new Map();
            const timeRanges = [
                { start: locationConfig.start_time_am, end: locationConfig.end_time_am },
                { start: locationConfig.start_time_pm, end: locationConfig.end_time_pm }
            ];
            timeRanges.forEach(range => {
                let currentTime = new Date(`${dateStr}T${range.start}`);
                const endTime = new Date(`${dateStr}T${range.end}`);
                while(currentTime < endTime) {
                    slotsMap.set(currentTime.toTimeString().substring(0,5), { status: 'free' });
                    currentTime.setMinutes(currentTime.getMinutes() + 15);
                }
            });
            const applyRule = (type, start, end) => {
                for (const time of slotsMap.keys()) {
                    if (time >= formatTime(start) && time < formatTime(end)) slotsMap.get(time).status = (type === 'BLOCK') ? 'blocked' : 'free';
                }
            };
            activeRules.forEach(r => applyRule(r.rule_type, r.start_time, r.end_time));
            (bookings || []).forEach(b => applyRule('BLOCK', b.start_time, b.end_time));
            
            if (state.currentUser.role === 'admin') {
                let adminHtml = '<div class="admin-time-grid">';
                for(const [time, slot] of slotsMap.entries()){
                    const booking = (bookings || []).find(b => time >= formatTime(b.start_time) && time < formatTime(b.end_time));
                    const currentStatus = booking ? 'booked' : slot.status;
                    const tooltip = currentStatus === 'booked' ? `Occupato da: ${booking.users.name}` : `Stato: ${currentStatus}`;
                    adminHtml += `<div class="time-slot ${currentStatus}" data-time="${time}" title="${tooltip}" data-booking='${booking ? JSON.stringify(booking) : 'null'}'>${time}</div>`;
                }
                adminHtml += '</div>';
                slotsContent.innerHTML = adminHtml;
            } else {
                const isTimespanFree = (start) => {
                    for (let i = 0; i < duration / 15; i++) {
                        const checkTime = new Date(start.getTime() + i * 15 * 60000);
                        if (!slotsMap.has(checkTime.toTimeString().substring(0,5)) || slotsMap.get(checkTime.toTimeString().substring(0,5)).status !== 'free') return false;
                    }
                    return true;
                };

                let lastAmSlot = null;
                const endAmTime = new Date(`${dateStr}T${locationConfig.end_time_am}`);
                const startAmTime = new Date(`${dateStr}T${locationConfig.start_time_am}`);
                for (let t = endAmTime.getTime() - duration * 60000; t >= startAmTime.getTime(); t -= 15 * 60000) {
                    if (isTimespanFree(new Date(t))) {
                        lastAmSlot = new Date(t).toTimeString().substring(0, 5);
                        break;
                    }
                }

                let firstPmSlot = null;
                const startPmTime = new Date(`${dateStr}T${locationConfig.start_time_pm}`);
                const endPmTime = new Date(`${dateStr}T${locationConfig.end_time_pm}`);
                for (let t = startPmTime.getTime(); t <= endPmTime.getTime() - duration * 60000; t += 15 * 60000) {
                     if (isTimespanFree(new Date(t))) {
                        firstPmSlot = new Date(t).toTimeString().substring(0, 5);
                        break;
                    }
                }
                
                let studentHtml = '<div class="student-time-slots">';
                if (!lastAmSlot && !firstPmSlot) {
                    studentHtml += `<p>Nessun orario disponibile per una lezione da ${duration} minuti.</p>`;
                } else {
                    if(lastAmSlot) studentHtml += `<h4>Orario Mattutino:</h4><div class="available-slot"><span>Ore: <strong>${lastAmSlot}</strong></span><button class="btn-book" data-time="${lastAmSlot}" data-duration="${duration}">Prenota</button></div>`;
                    if(firstPmSlot) studentHtml += `<h4>Orario Pomeridiano:</h4><div class="available-slot"><span>Ore: <strong>${firstPmSlot}</strong></span><button class="btn-book" data-time="${firstPmSlot}" data-duration="${duration}">Prenota</button></div>`;
                }
                studentHtml += '</div>';
                slotsContent.innerHTML = studentHtml;
            }
        };

        const openBlockModal = (startTime, isBlocked) => {
            blockModal.form.reset();
            document.getElementById('recurrence-once').checked = true;
            blockModal.form.dataset.startTime = startTime;
            blockModal.info.textContent = `Giorno: ${state.selectedDate.toLocaleDateString('it-IT', {weekday: 'long'})} | Inizio: ${startTime}`;
            const nextSlotTime = new Date(`${formatDate(state.selectedDate)}T${startTime}`);
            nextSlotTime.setMinutes(nextSlotTime.getMinutes() + 15);
            blockModal.endTime.value = nextSlotTime.toTimeString().substring(0, 5);
            blockModal.blockBtn.style.display = isBlocked ? 'none' : 'inline-block';
            blockModal.unblockBtn.style.display = isBlocked ? 'inline-block' : 'none';
            blockModal.overlay.style.display = 'flex';
        };

        const handleSaveBlockRule = async (e) => {
            e.preventDefault();
            const ruleType = e.submitter.id === 'block-modal-block' ? 'BLOCK' : 'UNBLOCK';
            const { startTime } = blockModal.form.dataset;
            const endTime = blockModal.endTime.value;
            if (endTime <= startTime) return alert("L'orario di fine non è valido.");
            
            const recurrence = document.querySelector('input[name="recurrence"]:checked').value;
            const startDate = new Date(state.selectedDate);
            let endDate = null;
            if (recurrence === 'once') endDate = new Date(startDate);
            else if (recurrence === 'weekly') {
                const weeks = parseInt(document.getElementById('recurrence-weeks').value);
                if (!weeks || weeks < 1) return alert("Numero settimane non valido.");
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (weeks * 7) - 1);
            }

            showLoading(true);
            await supabase.from('availability_rules').insert({
                location: state.currentLocation, rule_type: ruleType, day_of_week: startDate.getDay(),
                start_time: startTime, end_time: endTime, start_date: formatDate(startDate), end_date: formatDate(endDate)
            });
            showLoading(false);
            blockModal.overlay.style.display = 'none';
            await renderTimeSlots(formatDate(state.selectedDate));
        };
        const addLocationToDOM = (config) => {
            const contentDiv = document.getElementById('schedule-settings-content');
            const { location, work_days = [], start_time_am = '09:00', end_time_am = '13:00', start_time_pm = '15:00', end_time_pm = '21:00' } = config;
            const daysOfWeek = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            let locationHtml = `<div class="admin-tool-card" data-location-block="${location}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0; text-align:left;">${location}</h4>
                    <button class="btn btn-danger btn-sm btn-remove-location" data-location="${location}" style="width:auto;">&times;</button>
                </div>
                <div class="days-checkboxes" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;">`;
            for (let i = 1; i <= 6; i++) {
                locationHtml += `<div><input type="checkbox" id="${location}-${i}" value="${i}" ${work_days.includes(i) ? 'checked' : ''}><label for="${location}-${i}" style="margin-left:0.25rem;">${daysOfWeek[i]}</label></div>`;
            }
            locationHtml += `</div>
                <h5 style="margin: 1.5rem 0 0.5rem; text-align: left;">Fascia Mattutina</h5>
                <div class="time-inputs-container">
                    <div><label for="start-time-am-${location}">Inizio</label><input type="time" id="start-time-am-${location}" value="${formatTime(start_time_am)}" step="900"></div>
                    <div><label for="end-time-am-${location}">Fine (Pausa)</label><input type="time" id="end-time-am-${location}" value="${formatTime(end_time_am)}" step="900"></div>
                </div>
                <h5 style="margin: 1.5rem 0 0.5rem; text-align: left;">Fascia Pomeridiana</h5>
                <div class="time-inputs-container">
                     <div><label for="start-time-pm-${location}">Inizio</label><input type="time" id="start-time-pm-${location}" value="${formatTime(start_time_pm)}" step="900"></div>
                     <div><label for="end-time-pm-${location}">Fine</label><input type="time" id="end-time-pm-${location}" value="${formatTime(end_time_pm)}" step="900"></div>
                </div>
            </div>`;
            contentDiv.insertAdjacentHTML('beforeend', locationHtml);
        };
        const saveScheduleSettings = async () => {
            showLoading(true);
            if (state.locationsToDelete.length > 0) {
                await supabase.from('schedule_config').delete().in('location', state.locationsToDelete);
            }
            const updates = [];
            document.querySelectorAll('[data-location-block]').forEach(div => {
                const location = div.dataset.locationBlock;
                if (!state.locationsToDelete.includes(location)) {
                    updates.push({ 
                        location, 
                        work_days: Array.from(div.querySelectorAll('.days-checkboxes input:checked')).map(b => parseInt(b.value)),
                        start_time_am: document.getElementById(`start-time-am-${location}`).value,
                        end_time_am: document.getElementById(`end-time-am-${location}`).value,
                        start_time_pm: document.getElementById(`start-time-pm-${location}`).value,
                        end_time_pm: document.getElementById(`end-time-pm-${location}`).value
                    });
                }
            });
            if (updates.length > 0) await supabase.from('schedule_config').upsert(updates, { onConflict: 'location' });
            
            showLoading(false);
            alert("Impostazioni salvate.");
            await loadInitialData();
            navigateTo('main-screen');
        };

        // EVENT LISTENERS
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
        document.querySelector('main').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            if (button.id.startsWith('back-to-main')) navigateTo('main-screen');
            if (button.id === 'view-history-btn') navigateTo('history-screen');
            if (state.currentUser?.role === 'admin') {
                const adminActions = { 'manage-students-btn': 'student-list-screen', 'manage-schedule-btn': 'schedule-settings-screen', 'view-notifications-btn': 'notifications-screen', 'view-schedule-btn': 'schedule-screen' };
                if (adminActions[button.id]) navigateTo(adminActions[button.id]);
            }
        });
        document.getElementById('location-buttons-container').addEventListener('click', (e) => {
            const location = e.target.dataset.location;
            if (location) {
                state.currentLocation = location;
                document.getElementById('booking-location-title').textContent = `Sede di ${state.currentLocation}`;
                state.currentDate = new Date();
                state.currentDate.setDate(1);
                renderCalendar(); 
                navigateTo('booking-screen');
            }
        });
        document.getElementById('booking-screen').addEventListener('click', async (e) => {
            const target = e.target;
            if (target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
            if (target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
            if (target.classList.contains('valid')) await handleDateSelection(target.dataset.date);
            
            const button = e.target.closest('button');
            if (!button) return;

            if (button.classList.contains('btn-duration')) {
                await renderTimeSlots(formatDate(state.selectedDate), parseInt(button.dataset.duration));
            }
            if (state.currentUser.role === 'admin' && state.selectedDate) {
                const dateStr = formatDate(state.selectedDate);
                const unblock = button.id.includes('unblock');
                const action = unblock ? 'sbloccare' : 'bloccare';
                const ruleType = unblock ? 'UNBLOCK' : 'BLOCK';

                if (button.id.includes('-day-btn')) {
                    if (!confirm(`Sei sicuro di ${action} l'intera giornata ${dateStr}?`)) return;
                    const locConfig = state.scheduleConfig[state.currentLocation];
                    const rules = [
                        { location: state.currentLocation, rule_type: ruleType, day_of_week: state.selectedDate.getDay(), start_time: locConfig.start_time_am, end_time: locConfig.end_time_am, start_date: dateStr, end_date: dateStr },
                        { location: state.currentLocation, rule_type: ruleType, day_of_week: state.selectedDate.getDay(), start_time: locConfig.start_time_pm, end_time: locConfig.end_time_pm, start_date: dateStr, end_date: dateStr }
                    ];
                    await supabase.from('availability_rules').insert(rules);
                    await renderTimeSlots(dateStr);
                } else if (button.id.includes('-week-btn')) {
                    if (!confirm(`Sei sicuro di ${action} l'intera settimana corrente per tutte le sedi?`)) return;
                    const weekStart = new Date(state.selectedDate);
                    weekStart.setDate(weekStart.getDate() - (weekStart.getDay() + 6) % 7);
                    let promises = [];
                    for (let i = 0; i < 6; i++) {
                        const day = new Date(weekStart); day.setDate(weekStart.getDate() + i);
                        Object.keys(state.scheduleConfig).forEach(loc => {
                            if(isDayOfWeekAvailable(day, loc)) {
                                const locConfig = state.scheduleConfig[loc];
                                promises.push({ location: loc, rule_type: ruleType, day_of_week: day.getDay(), start_time: locConfig.start_time_am, end_time: locConfig.end_time_pm, start_date: formatDate(day), end_date: formatDate(day) });
                            }
                        });
                    }
                    await supabase.from('availability_rules').insert(promises);
                    await renderTimeSlots(dateStr);
                }
            }
        });
        document.getElementById('slots-content').addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('btn-book')) {
                const { time, duration } = target.dataset;
                const dateStr = formatDate(state.selectedDate);
                if (!confirm(`Confermi la prenotazione per ${state.selectedDate.toLocaleDateString('it-IT')} alle ${time}?`)) return;
                const endDateTime = new Date(`${dateStr}T${time}`);
                endDateTime.setMinutes(endDateTime.getMinutes() + parseInt(duration));
                await supabase.from('bookings').insert({ user_code: state.currentUser.code, location: state.currentLocation, date: dateStr, start_time: time, end_time: endDateTime.toTimeString().substring(0,8) });
                alert("Prenotazione confermata!");
                renderStudentBookingSummary();
                navigateTo('main-screen');

            } else if (state.currentUser.role === 'admin' && target.classList.contains('time-slot')) {
                const { time, booking } = target.dataset;
                if (target.classList.contains('booked')) {
                    const bookingData = JSON.parse(booking);
                    if(!confirm(`Slot occupato da ${bookingData.users.name}.\nVuoi cancellare la lezione e bloccare l'orario?`)) return;
                    await supabase.from('bookings').delete().eq('id', bookingData.id);
                    await supabase.from('notifications').insert({ student_code: bookingData.users.code, student_name: bookingData.users.name, message: `La tua lezione del ${formatDate(state.selectedDate)} alle ${time} è stata annullata.` });
                    openBlockModal(time, false);
                } else {
                     openBlockModal(time, target.classList.contains('blocked'));
                }
            }
        });
        document.getElementById('schedule-settings-screen').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if(!button) return;
            if(button.id === 'add-location-btn') {
                const input = document.getElementById('new-location-name');
                const newLocationName = input.value.trim();
                if (newLocationName && !document.querySelector(`[data-location-block="${newLocationName}"]`)) {
                    addLocationToDOM({location: newLocationName});
                    input.value = '';
                } else alert('Nome non valido o già presente.');
            } else if(button.id === 'save-schedule-settings-btn') {
                saveScheduleSettings();
            } else if(button.classList.contains('btn-remove-location')) {
                const location = button.dataset.location;
                if (confirm(`Rimuovere la sede "${location}"?`)) {
                    state.locationsToDelete.push(location);
                    document.querySelector(`[data-location-block="${location}"]`).remove();
                }
            }
        });
        document.getElementById('user-modal-cancel').addEventListener('click', () => document.getElementById('user-modal-overlay').style.display = 'none');
        blockModal.form.addEventListener('submit', handleSaveBlockRule);
        blockModal.overlay.addEventListener('click', (e) => { if (e.target === blockModal.overlay || e.target.id === 'block-modal-cancel') blockModal.overlay.style.display = 'none'; });
        
        // Initial load
        document.addEventListener('focusin', () => {
            if(!screens['schedule-settings-screen'].dataset.loaded) {
                document.getElementById('schedule-settings-content').innerHTML = '';
                Object.keys(state.scheduleConfig).forEach(loc => addLocationToDOM({location: loc, ...state.scheduleConfig[loc]}));
                screens['schedule-settings-screen'].dataset.loaded = true;
            }
        }, true);
        
        navigateTo('login-screen');
    });
    </script>
</body>
</html>