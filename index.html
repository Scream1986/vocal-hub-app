<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Online</title>
    <style>
        :root {
            --header-bg: #000;
            --button-primary-bg: #ffc107;
            --button-primary-text: #000;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--light-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
        .app-container { width: 100%; max-width: 480px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background-color: var(--header-bg); color: white; text-align: center; }
        main { padding: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        h2, h3, h4 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-logout { background-color: var(--danger-color); color: white; margin-top: 1rem; }
        #loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background-color: rgba(255,255,255,0.8); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .modal-buttons .btn { width: auto; margin-top: 0; }
        .student-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-info { font-weight: 500; }
        .student-actions .btn { width: auto; margin-top: 0; margin-left: 0.5rem; }
        .calendar { margin-top: 1.5rem; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .weekday { padding: 0.75rem 0.25rem; border-radius: 4px; }
        .weekday { font-weight: bold; }
        .calendar-day.invalid { color: #ccc; pointer-events: none; }
        .calendar-day.valid { background-color: #ffffff; border: 1px solid #ddd; cursor: pointer; }
        .calendar-day.selected { background-color: var(--button-primary-bg); color: var(--button-primary-text); font-weight: bold; border: 1px solid var(--button-primary-bg); }
        .admin-time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
        .time-slot { padding: 0.5rem; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.9rem; color: white; border: 1px solid rgba(0, 0, 0, 0.1); }
        .time-slot.free { background-color: var(--success-color); }
        .time-slot.booked { background-color: var(--secondary-color); }
        .time-slot.blocked { background-color: var(--danger-color); }
        .day-week-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .day-week-controls .btn { margin-top: 0; font-size: 0.8rem; padding: 0.5rem; }
        .student-time-slots .available-slot { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div id="loading-spinner">Caricamento...</div>

    <div class="app-container">
        <header id="app-header" style="padding: 0.5rem;">
            <img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>
        <main>
            <div id="login-screen" class="screen active">
                <h2>Accesso</h2>
                <div class="form-group"><label for="student-code">Codice Allievo</label><input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off"></div>
                <button id="login-btn" class="btn btn-primary">Accedi</button>
            </div>

            <div id="main-screen" class="screen">
                <h2 id="welcome-message"></h2>
                <div id="student-bookings-summary"></div>
                <p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p>
                <div id="location-buttons-container"></div>
                <div id="admin-actions"></div>
                <button id="logout-btn" class="btn btn-logout">Esci</button>
            </div>

            <div id="booking-screen" class="screen">
                <h2 id="booking-location-title"></h2>
                <div id="booking-admin-actions"></div>
                <div class="calendar">
                    <div id="calendar-header">
                        <button id="prev-month-btn" class="btn btn-secondary" style="width: auto; padding: 0.5rem 1rem;">&lt;</button>
                        <h3 id="month-year-label"></h3>
                        <button id="next-month-btn" class="btn btn-secondary" style="width: auto; padding: 0.5rem 1rem;">&gt;</button>
                    </div>
                    <div id="calendar-weekdays"><div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div></div>
                    <div id="calendar-grid"></div>
                </div>
                <div id="time-slots-container" style="display:none;">
                    <h3>Orari per il <span id="selected-date-label"></span></h3>
                    <div id="slots-content"></div>
                </div>
                <button id="back-to-main-btn" class="btn btn-secondary" style="margin-top: 2rem;">Torna Indietro</button>
            </div>

            <div id="schedule-settings-screen" class="screen">
                <h2>Impostazioni Calendario</h2>
                <div id="schedule-settings-content"></div><hr>
                <div class="form-group"><label for="new-location-name">Aggiungi una nuova sede</label><input type="text" id="new-location-name" placeholder="Nome nuova sede"><button id="add-location-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Aggiungi Sede</button></div>
                <button id="save-schedule-settings-btn" class="btn btn-primary">Salva Modifiche</button>
                <button id="back-to-main-from-schedule-settings-btn" class="btn btn-secondary">Torna Indietro</button>
            </div>

            <div id="student-list-screen" class="screen">
                <h2>Gestione Allievi</h2>
                <button id="create-student-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Crea Nuovo Allievo</button>
                <div id="student-list"></div>
                <button id="back-to-main-from-student-list-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button>
            </div>
        </main>
    </div>

    <div id="user-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h4 id="user-modal-title">Crea Nuovo Allievo</h4>
            <div class="form-group"><label for="user-modal-name">Nome Allievo</label><input type="text" id="user-modal-name"></div>
            <div class="form-group"><label for="user-modal-code">Codice Allievo</label><input type="text" id="user-modal-code" autocomplete="off"></div>
            <div class="modal-buttons"><button id="user-modal-cancel" class="btn btn-secondary">Annulla</button><button id="user-modal-save" class="btn btn-primary">Salva</button></div>
        </div>
    </div>

    <div id="generic-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h4 id="generic-modal-title"></h4>
            <p id="generic-modal-message"></p>
            <div id="generic-modal-buttons" class="modal-buttons"></div>
        </div>
    </div>

<script type="module">
    // --- 1. CONFIGURAZIONE SUPABASE ---
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // --- 2. STATO GLOBALE E ELEMENTI DOM ---
    let state = { 
        currentUser: null, 
        scheduleConfig: {}, 
        currentDate: new Date(), 
        currentLocation: null, 
        selectedDate: null,
        allUsers: [] 
    };
    state.currentDate.setDate(1);

    const loadingSpinner = document.getElementById('loading-spinner');
    const mainEl = document.querySelector('main');
    const screens = { 
        'login-screen': document.getElementById('login-screen'), 
        'main-screen': document.getElementById('main-screen'),
        'schedule-settings-screen': document.getElementById('schedule-settings-screen'),
        'student-list-screen': document.getElementById('student-list-screen'),
        'booking-screen': document.getElementById('booking-screen'),
    };
    const genericModal = {
        overlay: document.getElementById('generic-modal-overlay'),
        title: document.getElementById('generic-modal-title'),
        message: document.getElementById('generic-modal-message'),
        buttons: document.getElementById('generic-modal-buttons'),
    };

    // --- 3. FUNZIONI UTILITY E MODALI ---
    const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
    const navigateTo = (screenId) => {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        if (screens[screenId]) screens[screenId].classList.add('active');
    };
    const formatDate = (date) => date.toISOString().split('T')[0];
    const formatTime = (date) => date.toTimeString().substring(0, 5);
    const generateTimeSlots = (startHour, endHour, intervalMinutes) => {
        const slots = [];
        let currentTime = new Date(`1970-01-01T${startHour}:00:00Z`);
        const endTime = new Date(`1970-01-01T${endHour}:00:00Z`);
        while (currentTime < endTime) {
            slots.push(currentTime.toTimeString().substring(0, 5));
            currentTime.setMinutes(currentTime.getMinutes() + intervalMinutes);
        }
        return slots;
    };
    
    const showModal = (title, message, buttonsConfig) => {
        genericModal.title.textContent = title;
        genericModal.message.innerHTML = message;
        genericModal.buttons.innerHTML = '';
        buttonsConfig.forEach(btnConfig => {
            const button = document.createElement('button');
            button.textContent = btnConfig.text;
            button.className = `btn ${btnConfig.class}`;
            button.addEventListener('click', () => {
                genericModal.overlay.style.display = 'none';
                if (btnConfig.onClick) btnConfig.onClick();
            });
            genericModal.buttons.appendChild(button);
        });
        genericModal.overlay.style.display = 'flex';
    };
    
    const showAlert = (message, title = "Avviso") => {
        showModal(title, message, [{ text: 'OK', class: 'btn-primary' }]);
    };

    const showConfirm = (title, message, onConfirm) => {
        showModal(title, message, [
            { text: 'Annulla', class: 'btn-secondary' },
            { text: 'Conferma', class: 'btn-primary', onClick: onConfirm }
        ]);
    };

    // --- 4. FUNZIONI CORE ---
    const login = async () => {
        const code = document.getElementById('student-code').value.toUpperCase().trim();
        if (!code) return showAlert('Inserisci un codice.');
        showLoading(true);
        const { data: user, error } = await supabaseClient.from('users').select('*').eq('code', code).single();
        showLoading(false);
        if (error && error.code !== 'PGRST116') { return showAlert('Errore di connessione. Riprova più tardi.'); }
        if (user) {
            state.currentUser = user;
            document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
            await loadInitialData();
            if(user.role === 'admin') { 
                updateAdminUI(); 
                const { data: users } = await supabaseClient.from('users').select('code, name').eq('role', 'student');
                state.allUsers = users || [];
            }
            navigateTo('main-screen');
        } else {
            showAlert('Codice non valido. Riprova.');
        }
    };

    const loadInitialData = async () => {
        showLoading(true);
        const { data, error } = await supabaseClient.from('schedule_config').select('location, work_days');
        showLoading(false);
        if (error) { return console.error("Errore caricamento config calendario:", error); }
        state.scheduleConfig = {};
        if (data) data.forEach(item => { state.scheduleConfig[item.location] = item.work_days || []; });
        renderLocationButtons();
    };

    const renderLocationButtons = () => {
        const container = document.getElementById('location-buttons-container');
        container.innerHTML = '';
        const locations = Object.keys(state.scheduleConfig);
        if (locations.length > 0) {
            locations.forEach(location => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.dataset.location = location;
                btn.textContent = location;
                container.appendChild(btn);
            });
        } else {
            container.innerHTML = `<p style="text-align:center; color: #666;">Nessuna sede configurata.</p>`;
        }
    };

    const updateAdminUI = () => {
        document.getElementById('admin-actions').innerHTML = `
            <button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button>
            <button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button>
        `;
    };
    
    const logout = () => {
        showConfirm('Uscita', 'Sei sicuro di voler uscire?', () => {
            state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, allUsers: [] };
            state.currentDate.setDate(1);
            document.getElementById('student-code').value = '';
            navigateTo('login-screen');
        });
    };

    // --- 5. GESTIONE CALENDARIO E ORARI ---
    const isDayOfWeekAvailable = (date, location) => {
        const dayOfWeek = date.getDay();
        return state.scheduleConfig[location]?.includes(dayOfWeek) || false;
    };
    
    const renderCalendar = () => {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
        document.getElementById('time-slots-container').style.display = 'none';
        document.getElementById('booking-admin-actions').innerHTML = '';
        state.selectedDate = null;
        
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        let dayOfWeek = firstDay.getDay();
        dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
        
        for (let i = 0; i < dayOfWeek; i++) { calendarGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
        
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            const dayEl = document.createElement('div');
            dayEl.textContent = day;
            dayEl.classList.add('calendar-day');
            if (isDayOfWeekAvailable(date, state.currentLocation)) {
                dayEl.classList.add('valid');
                dayEl.dataset.date = formatDate(date);
            } else {
                dayEl.classList.add('invalid');
            }
            calendarGrid.appendChild(dayEl);
        }
    };

    const renderTimeSlots = async (date) => {
        state.selectedDate = date;
        const dateStr = formatDate(date);
        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
        document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');

        document.getElementById('selected-date-label').textContent = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
        document.getElementById('time-slots-container').style.display = 'block';
        
        const slotsContent = document.getElementById('slots-content');
        slotsContent.innerHTML = '';

        if (state.currentUser.role === 'admin') {
            document.getElementById('booking-admin-actions').innerHTML = `
                <div class="day-week-controls">
                    <button id="block-day-btn" class="btn btn-danger btn-sm">Blocca Giorno</button>
                    <button id="unblock-day-btn" class="btn btn-success btn-sm">Sblocca Giorno</button>
                    <button id="block-week-btn" class="btn btn-danger btn-sm">Blocca Settimana</button>
                    <button id="unblock-week-btn" class="btn btn-success btn-sm">Sblocca Settimana</button>
                </div>`;
            await renderAdminTimeGrid(dateStr, state.currentLocation);
        } else {
            await renderStudentTimeSlots(dateStr, state.currentLocation);
        }
    };

    const renderAdminTimeGrid = async (dateStr, location) => {
        const slotsContent = document.getElementById('slots-content');
        slotsContent.innerHTML = 'Caricamento orari...';
        showLoading(true);
        
        const { data: bookings, error: bookingsError } = await supabaseClient.from('bookings').select('*, users(name)').eq('date', dateStr).eq('location', location);
        const { data: blocked, error: blockedError } = await supabaseClient.from('blocked_slots').select('*').eq('date', dateStr).eq('location', location);
        
        showLoading(false);
        if (bookingsError) {
            console.error(bookingsError);
            showAlert('Errore nel database', 'Non è stato possibile caricare le prenotazioni. Assicurati che il collegamento tra le tabelle `bookings` e `users` sia stato creato correttamente nel SQL Editor di Supabase.');
            return;
        }
        if (blockedError) {
            console.error(blockedError);
            showAlert('Errore', 'Non è stato possibile caricare gli orari bloccati.');
            return;
        }

        const slots = generateTimeSlots(15, 21, 15);
        let gridHtml = '<div class="admin-time-grid">';
        gridHtml += slots.map(slot => {
            let status = 'free';
            let tooltip = `Orario: ${slot}, Libero`;
            const booking = bookings.find(b => slot >= b.start_time.substring(0, 5) && slot < b.end_time.substring(0, 5));
            if (booking) {
                status = 'booked';
                tooltip = `Occupato da: ${booking.users ? booking.users.name : 'Utente Sconosciuto'}`;
            } else {
                const isBlocked = blocked.some(b => slot >= b.start_time.substring(0, 5) && slot < b.end_time.substring(0, 5));
                if (isBlocked) { status = 'blocked'; tooltip = 'Bloccato'; }
            }
            return `<div class="time-slot ${status}" data-time="${slot}" title="${tooltip}">${slot}</div>`;
        }).join('');
        gridHtml += '</div>';
        slotsContent.innerHTML = gridHtml;
    };
    
    const renderStudentTimeSlots = async (dateStr, location) => {
        const slotsContent = document.getElementById('slots-content');
        slotsContent.innerHTML = 'Caricamento orari disponibili...';
        showLoading(true);

        const { data: bookings, error: bErr } = await supabaseClient.from('bookings').select('start_time, end_time').eq('date', dateStr).eq('location', location);
        const { data: blocked, error: blErr } = await supabaseClient.from('blocked_slots').select('start_time, end_time').eq('date', dateStr).eq('location', location);

        showLoading(false);
        if (bErr || blErr) return console.error(bErr || blErr);

        const allEventsOnDate = [...bookings, ...blocked];

        const isTimespanFree = (checkStart, checkEnd) => {
            for (const event of allEventsOnDate) {
                const eventStart = new Date(`${dateStr}T${event.start_time}`);
                const eventEnd = new Date(`${dateStr}T${event.end_time}`);
                if (checkStart < eventEnd && checkEnd > eventStart) return false;
            }
            return true;
        };

        const getAvailableSlots = (duration) => {
            const available = new Set();
            const allPossibleSlots = generateTimeSlots(15, 21, 15);
            
            allPossibleSlots.forEach(timeStr => {
                const potentialStart = new Date(`${dateStr}T${timeStr}`);
                const now = new Date();
                const hoursUntilSlot = (potentialStart - now) / (1000 * 60 * 60);
                if (hoursUntilSlot <= 12) return;

                const potentialEnd = new Date(potentialStart.getTime() + duration * 60000);
                if (potentialEnd <= new Date(`${dateStr}T21:00:00`) && isTimespanFree(potentialStart, potentialEnd)) {
                    available.add(timeStr);
                }
            });
            return Array.from(available).sort();
        };

        const slots45 = getAvailableSlots(45);
        const slots60 = getAvailableSlots(60);
        
        let html = `<h4>Crea Nuova Prenotazione</h4><div class="student-time-slots">`;
        if (slots45.length === 0 && slots60.length === 0) {
            html += "<p>Nessun orario disponibile per oggi.</p>";
        } else {
            if (slots45.length > 0) {
                html += '<h5>Lezione da 45 minuti</h5>';
                slots45.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn btn-primary btn-sm btn-book" data-time="${slot}" data-duration="45">Prenota</button></div>`; });
            }
            if (slots60.length > 0) {
                html += '<h5>Lezione da 60 minuti</h5>';
                slots60.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn btn-primary btn-sm btn-book" data-time="${slot}" data-duration="60">Prenota</button></div>`; });
            }
        }
        html += '</div>';
        slotsContent.innerHTML = html;
    };

    // --- 6. FUNZIONI ADMIN ---
    const renderStudentList = async () => {
        const listDiv = document.getElementById('student-list');
        listDiv.innerHTML = '';
        showLoading(true);
        const { data: users, error } = await supabaseClient.from('users').select('*').eq('role', 'student').order('name');
        showLoading(false);
        if (error) { return console.error("Errore caricamento allievi:", error); }
        users.forEach(student => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'student-list-item';
            itemDiv.innerHTML = `
                <div class="student-info">${student.name}<br><small style="color: #6c757d;">Codice: ${student.code}</small></div>
                <div class="student-actions">
                    <button class="btn btn-secondary btn-sm btn-edit-student" data-id="${student.id}" data-name="${student.name}" data-code="${student.code}">Modifica</button>
                    <button class="btn btn-danger btn-sm btn-delete-student" data-id="${student.id}" data-name="${student.name}">Elimina</button>
                </div>`;
            listDiv.appendChild(itemDiv);
        });
    };
    const showUserModal = (isEdit, userData) => {
        document.getElementById('user-modal-title').textContent = isEdit ? 'Modifica Allievo' : 'Crea Nuovo Allievo';
        document.getElementById('user-modal-name').value = userData.name || '';
        document.getElementById('user-modal-code').value = userData.code || '';
        const saveBtn = document.getElementById('user-modal-save');
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        newSaveBtn.onclick = () => handleSaveUser(userData.id);
        document.getElementById('user-modal-overlay').style.display = 'flex';
    };
    const handleSaveUser = async (userId) => {
        const name = document.getElementById('user-modal-name').value.trim();
        const code = document.getElementById('user-modal-code').value.toUpperCase().trim();
        if (!name || !code) { return showAlert("Nome e Codice non possono essere vuoti."); }
        showLoading(true);
        const { error } = userId ? 
            await supabaseClient.from('users').update({ name, code }).eq('id', userId) :
            await supabaseClient.from('users').insert({ name, code, role: 'student' });
        showLoading(false);
        if (error) { return showAlert("Errore: il codice potrebbe essere già in uso."); }
        showAlert(`Allievo "${name}" salvato.`);
        await renderStudentList();
        document.getElementById('user-modal-overlay').style.display = 'none';
    };
    const deleteUser = (userId, userName) => {
        showConfirm('Elimina Allievo', `Sei sicuro di voler eliminare "${userName}"? <br>Verranno eliminate anche tutte le sue prenotazioni.`, async () => {
            showLoading(true);
            const { data: userToDelete, error: userError } = await supabaseClient.from('users').select('code').eq('id', userId).single();
            if (userError) { showLoading(false); return showAlert("Utente non trovato."); }
            if (userToDelete) { await supabaseClient.from('bookings').delete().eq('user_code', userToDelete.code); }
            const { error } = await supabaseClient.from('users').delete().eq('id', userId);
            showLoading(false);
            if (error) { return showAlert("Errore durante l'eliminazione."); }
            showAlert("Allievo eliminato.");
            await renderStudentList();
        });
    };
    const renderScheduleSettings = async () => {
        const contentDiv = document.getElementById('schedule-settings-content');
        contentDiv.innerHTML = '';
        const daysOfWeek = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
        showLoading(true);
        const { data, error } = await supabaseClient.from('schedule_config').select('*').order('location');
        showLoading(false);
        if(error) { return console.error("Errore caricamento impostazioni:", error); }
        data.forEach(locationData => {
            let locationHtml = `<div style="border:1px solid #eee; padding:1rem; border-radius:8px; margin-bottom:1rem;"><div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0;">${locationData.location}</h4><button class="btn btn-danger btn-sm btn-remove-location" data-location="${locationData.location}">&times; Rimuovi</button></div><div class="days-checkboxes" data-location="${locationData.location}" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;">`;
            for (let i = 1; i <= 6; i++) {
                const isChecked = (locationData.work_days || []).includes(i);
                locationHtml += `<div><input type="checkbox" id="${locationData.location}-${i}" value="${i}" ${isChecked ? 'checked' : ''}><label for="${locationData.location}-${i}" style="margin-left:0.25rem;">${daysOfWeek[i]}</label></div>`;
            }
            locationHtml += `</div></div>`;
            contentDiv.innerHTML += locationHtml;
        });
    };
    const saveScheduleSettings = async () => {
        const newConfig = [];
        document.querySelectorAll('.days-checkboxes').forEach(div => {
            const location = div.dataset.location;
            const work_days = [];
            div.querySelectorAll('input[type="checkbox"]:checked').forEach(box => { work_days.push(parseInt(box.value)); });
            newConfig.push({ location, work_days });
        });
        showLoading(true);
        await supabaseClient.from('schedule_config').delete().neq('id', -1);
        const { error } = await supabaseClient.from('schedule_config').insert(newConfig);
        showLoading(false);
        if(error) { showAlert("Errore nel salvataggio."); } 
        else { showAlert("Impostazioni salvate."); await loadInitialData(); navigateTo('main-screen'); }
    };
    const addLocation = async () => {
        const input = document.getElementById('new-location-name');
        const newLocationName = input.value.trim();
        if (!newLocationName) return;
        showLoading(true);
        const { error } = await supabaseClient.from('schedule_config').insert({ location: newLocationName, work_days: [] });
        showLoading(false);
        if(error) { showAlert("Errore: la sede potrebbe già esistere."); } 
        else { await renderScheduleSettings(); input.value = ''; }
    };
    const removeLocation = (locationToRemove) => {
        showConfirm('Rimuovi Sede', `Sei sicuro di voler rimuovere la sede "${locationToRemove}"?`, async () => {
            showLoading(true);
            const { error } = await supabaseClient.from('schedule_config').delete().eq('location', locationToRemove);
            showLoading(false);
            if(error) { showAlert("Errore durante la rimozione."); } 
            else { await renderScheduleSettings(); }
        });
    };

    const handleBlockUnblockDay = (block = true) => {
        if (!state.selectedDate) return;
        const action = block ? 'bloccare' : 'sbloccare';
        showConfirm(`Conferma ${action}`, `Sei sicuro di voler ${action} l'intera giornata del ${state.selectedDate.toLocaleDateString('it-IT')}?`, async () => {
            const dateStr = formatDate(state.selectedDate);
            showLoading(true);
            await supabaseClient.from('blocked_slots').delete().eq('date', dateStr).eq('location', state.currentLocation);
            if (block) {
                const { error } = await supabaseClient.from('blocked_slots').insert({
                    location: state.currentLocation, date: dateStr, start_time: '15:00', end_time: '21:00'
                });
                if (error) showAlert(`Errore durante il blocco: ${error.message}`);
            }
            showLoading(false);
            await renderTimeSlots(state.selectedDate);
        });
    };

    const handleBlockUnblockWeek = (block = true) => {
        if (!state.selectedDate) return;
        const action = block ? 'bloccare' : 'sbloccare';
        const date = new Date(state.selectedDate);
        const dayOfWeek = date.getDay() === 0 ? 6 : date.getDay() - 1;
        const weekStart = new Date(date.setDate(date.getDate() - dayOfWeek));

        showConfirm(`Conferma ${action}`, `Sei sicuro di voler ${action} tutti i giorni lavorativi di questa settimana?`, async () => {
            showLoading(true);
            const promises = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                if (isDayOfWeekAvailable(day, state.currentLocation)) {
                    const dateStr = formatDate(day);
                    promises.push(supabaseClient.from('blocked_slots').delete().eq('date', dateStr).eq('location', state.currentLocation));
                    if(block) {
                         promises.push(supabaseClient.from('blocked_slots').insert({
                            location: state.currentLocation, date: dateStr, start_time: '15:00', end_time: '21:00'
                        }));
                    }
                }
            }
            await Promise.all(promises);
            showLoading(false);
            await renderTimeSlots(state.selectedDate);
        });
    };
    
    // --- 7. EVENT LISTENERS ---
    document.getElementById('login-btn').addEventListener('click', login);
    document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
    document.getElementById('logout-btn').addEventListener('click', logout);
    
    document.getElementById('location-buttons-container').addEventListener('click', (e) => {
        const location = e.target.dataset.location;
        if (location) {
            state.currentLocation = location;
            document.getElementById('booking-location-title').textContent = `Sede di ${location}`;
            state.currentDate = new Date();
            state.currentDate.setDate(1);
            renderCalendar();
            navigateTo('booking-screen');
        }
    });

    document.getElementById('booking-screen').addEventListener('click', async (e) => {
        if (e.target.id === 'back-to-main-btn') return navigateTo('main-screen');
        if (e.target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
        if (e.target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
        if (e.target.classList.contains('valid')) {
            const date = new Date(e.target.dataset.date + 'T12:00:00');
            await renderTimeSlots(date);
        }
        if (e.target.id === 'block-day-btn') handleBlockUnblockDay(true);
        if (e.target.id === 'unblock-day-btn') handleBlockUnblockDay(false);
        if (e.target.id === 'block-week-btn') handleBlockUnblockWeek(true);
        if (e.target.id === 'unblock-week-btn') handleBlockUnblockWeek(false);
    });

    document.getElementById('slots-content').addEventListener('click', async (e) => {
        const target = e.target;
        // Studente prenota
        if (target.classList.contains('btn-book')) {
            const startTime = target.dataset.time;
            const duration = parseInt(target.dataset.duration);
            showConfirm('Conferma Prenotazione', `Confermi la prenotazione per ${state.selectedDate.toLocaleDateString('it-IT')} alle ${startTime} per ${duration} minuti?`, async () => {
                const slotEnd = new Date(new Date(`${formatDate(state.selectedDate)}T${startTime}`).getTime() + duration * 60000);
                showLoading(true);
                const { error } = await supabaseClient.from('bookings').insert({
                    user_code: state.currentUser.code, location: state.currentLocation, date: formatDate(state.selectedDate),
                    start_time: startTime, end_time: formatTime(slotEnd), is_package: false
                });
                showLoading(false);
                if (error) { showAlert(`Errore nella prenotazione: ${error.message}`); } 
                else { showAlert('Prenotazione effettuata!'); await renderTimeSlots(state.selectedDate); }
            });
        }
        // Admin clicca su uno slot
        else if (state.currentUser?.role === 'admin' && target.classList.contains('time-slot')) {
            const time = target.dataset.time;
            const dateStr = formatDate(state.selectedDate);
            
            let modalContent = `
                <div class="form-group">
                    <label>Azione per l'orario ${time}:</label>
                    <button id="modal-assign-lesson" class="btn btn-primary">Assegna Lezione</button>
                    <button id="modal-block-slot" class="btn btn-danger">Blocca Orario</button>
                    <button id="modal-unblock-slot" class="btn btn-success">Sblocca Orario</button>
                </div>
            `;
            showModal(`Gestisci Orario ${time}`, modalContent, [{ text: 'Chiudi', class: 'btn-secondary' }]);

            document.getElementById('modal-assign-lesson').onclick = () => {
                let studentOptions = state.allUsers.map(u => `<option value="${u.code}">${u.name} (${u.code})</option>`).join('');
                let assignContent = `
                    <div class="form-group"><label for="student-select">Seleziona Allievo:</label><select id="student-select">${studentOptions}</select></div>
                    <div class="form-group"><label for="duration-input">Durata (minuti):</label><input type="number" id="duration-input" value="45"></div>
                `;
                showConfirm('Assegna Lezione', assignContent, async () => {
                    const studentCode = document.getElementById('student-select').value;
                    const duration = parseInt(document.getElementById('duration-input').value);
                    if (studentCode && duration > 0) {
                        const endTime = formatTime(new Date(new Date(`${dateStr}T${time}`).getTime() + duration * 60000));
                        showLoading(true);
                        await supabaseClient.from('bookings').insert({ user_code: studentCode, location: state.currentLocation, date: dateStr, start_time: time, end_time: endTime, is_package: false });
                        showLoading(false);
                        await renderTimeSlots(state.selectedDate);
                    }
                });
            };
            document.getElementById('modal-block-slot').onclick = () => {
                 let blockContent = `<div class="form-group"><label for="block-duration-input">Durata blocco (minuti):</label><input type="number" id="block-duration-input" value="15"></div>`;
                 showConfirm('Blocca Orario', blockContent, async () => {
                     const duration = parseInt(document.getElementById('block-duration-input').value);
                     if (duration > 0) {
                        const endTime = formatTime(new Date(new Date(`${dateStr}T${time}`).getTime() + duration * 60000));
                        showLoading(true);
                        await supabaseClient.from('blocked_slots').insert({ location: state.currentLocation, date: dateStr, start_time: time, end_time: endTime });
                        showLoading(false);
                        await renderTimeSlots(state.selectedDate);
                     }
                 });
            };
             document.getElementById('modal-unblock-slot').onclick = () => {
                 showConfirm('Sblocca Orario', `Sei sicuro di voler rimuovere tutti i blocchi che iniziano alle ${time}?`, async () => {
                    showLoading(true);
                    await supabaseClient.from('blocked_slots').delete().eq('location', state.currentLocation).eq('date', dateStr).eq('start_time', time);
                    showLoading(false);
                    await renderTimeSlots(state.selectedDate);
                 });
            };
        }
    });
    
    mainEl.addEventListener('click', async (e) => {
        if (e.target.id === 'manage-students-btn') { await renderStudentList(); navigateTo('student-list-screen'); }
        if (e.target.id === 'manage-schedule-btn') { await renderScheduleSettings(); navigateTo('schedule-settings-screen'); }
        if (e.target.id === 'back-to-main-from-student-list-btn' || e.target.id === 'back-to-main-from-schedule-settings-btn') { navigateTo('main-screen'); }
    });

    document.getElementById('student-list-screen').addEventListener('click', (e) => {
        if (e.target.id === 'create-student-btn') showUserModal(false, {});
        if (e.target.classList.contains('btn-edit-student')) { showUserModal(true, e.target.dataset); }
        if (e.target.classList.contains('btn-delete-student')) { deleteUser(e.target.dataset.id, e.target.dataset.name); }
    });

    document.getElementById('schedule-settings-screen').addEventListener('click', async (e) => {
        if (e.target.id === 'add-location-btn') await addLocation();
        if (e.target.id === 'save-schedule-settings-btn') await saveScheduleSettings();
        if (e.target.classList.contains('btn-remove-location')) removeLocation(e.target.dataset.location);
    });

    document.getElementById('user-modal-cancel').addEventListener('click', () => { document.getElementById('user-modal-overlay').style.display = 'none'; });

</script>
</body>
</html>