<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --header-bg: #000; --button-primary-bg: #ffc107; --button-primary-text: #000; --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545; --light-color: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--light-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
        .app-container { width: 100%; max-width: 480px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background-color: var(--header-bg); color: white; text-align: center; }
        main { padding: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        h2, h3, h4 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-logout { background-color: var(--danger-color); color: white; margin-top: 1rem; }
        #loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background-color: rgba(255,255,255,0.8); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .modal-buttons .btn { width: auto; margin-top: 0; }
        .student-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-info { font-weight: 500; }
        .student-actions .btn { width: auto; margin-top: 0; margin-left: 0.5rem; }
        .calendar { margin-top: 1.5rem; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .weekday { padding: 0.75rem 0.25rem; border-radius: 4px; }
        .weekday { font-weight: bold; }
        .calendar-day.invalid { color: #ccc; pointer-events: none; }
        .calendar-day.valid { background-color: #ffffff; border: 1px solid #ddd; cursor: pointer; }
        .calendar-day.selected { background-color: var(--button-primary-bg); color: var(--button-primary-text); font-weight: bold; border: 1px solid var(--button-primary-bg); }
        .admin-time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
        .time-slot { padding: 0.5rem; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.9rem; color: white; border: 1px solid rgba(0, 0, 0, 0.1); }
        .time-slot.free { background-color: var(--success-color); }
        .time-slot.booked { background-color: var(--secondary-color); }
        .time-slot.blocked { background-color: var(--danger-color); }
        .student-time-slots .available-slot, .booked-slot { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-time-slots .btn-book, .booked-slot .btn-request-change { padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; border: none; border-radius: 4px; flex-shrink: 0; margin-left: 1rem; }
        .student-time-slots .btn-book { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .booked-slot { background-color: #e9ecef; }
        .btn-request-change { background-color: var(--secondary-color); color: white; }
        .btn-request-change:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; border: 1px solid #ddd; }
        .notification-item { padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem; background-color: #f8f9fa; }
        .notification-details { font-size: 0.9rem; color: #6c757d; border-left: 3px solid var(--button-primary-bg); padding-left: 0.75rem; margin-top: 0.75rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div id="loading-spinner">Caricamento...</div>
    <div class="app-container">
        <header id="app-header" style="padding: 0.5rem;">
            <img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>
        <main>
            <div id="login-screen" class="screen active">
                <h2>Accesso</h2>
                <div class="form-group"><label for="student-code">Codice Allievo</label><input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off"></div>
                <button id="login-btn" class="btn btn-primary">Accedi</button>
            </div>

            <div id="main-screen" class="screen">
                <h2 id="welcome-message"></h2>
                <div id="student-bookings-summary"></div>
                <hr>
                <p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p>
                <div id="location-buttons-container"></div>
                <div id="admin-actions" style="margin-top: 1.5rem;"></div>
                <button id="logout-btn" class="btn btn-logout">Esci</button>
            </div>

            <div id="booking-screen" class="screen">
                <h2 id="booking-location-title"></h2>
                <div id="booking-admin-actions"></div>
                <div class="calendar">
                    <div id="calendar-header">
                        <button id="prev-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&lt;</button>
                        <h3 id="month-year-label"></h3>
                        <button id="next-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&gt;</button>
                    </div>
                    <div id="calendar-weekdays"><div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div></div>
                    <div id="calendar-grid"></div>
                </div>
                <div id="time-slots-container" style="display:none; margin-top: 1.5rem;">
                    <h3>Orari per il <span id="selected-date-label"></span></h3>
                    <div id="slots-content"></div>
                </div>
                <button id="back-to-main-btn" class="btn btn-secondary" style="margin-top: 2rem;">Torna Indietro</button>
            </div>

            <div id="schedule-settings-screen" class="screen">
                <h2>Impostazioni Calendario</h2>
                <div id="schedule-settings-content"></div><hr>
                <div class="form-group"><label for="new-location-name">Aggiungi una nuova sede</label><input type="text" id="new-location-name" placeholder="Nome nuova sede"><button id="add-location-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Aggiungi Sede</button></div>
                <button id="save-schedule-settings-btn" class="btn btn-primary">Salva Modifiche</button>
                <button id="back-to-main-from-schedule-settings-btn" class="btn btn-secondary">Torna Indietro</button>
            </div>

            <div id="student-list-screen" class="screen">
                <h2>Gestione Allievi</h2>
                <button id="create-student-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Crea Nuovo Allievo</button>
                <div id="student-list"></div>
                <button id="back-to-main-from-student-list-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button>
            </div>

            <div id="notifications-screen" class="screen">
                <h2>Notifiche Studenti</h2>
                <div id="notifications-list"></div>
                <button id="back-to-main-from-notifications-btn" class="btn btn-secondary">Torna Indietro</button>
            </div>

        </main>
    </div>

    <div id="user-modal-overlay" class="modal-overlay">
		<div class="modal-content">
			<h4 id="user-modal-title">Crea Nuovo Allievo</h4>
			<div class="form-group"><label for="user-modal-name">Nome Allievo</label><input type="text" id="user-modal-name"></div>
			<div class="form-group"><label for="user-modal-code">Codice Allievo</label><input type="text" id="user-modal-code" autocomplete="off"></div>
			<div class="modal-buttons"><button id="user-modal-cancel" class="btn btn-secondary">Annulla</button><button id="user-modal-save" class="btn btn-primary">Salva</button></div>
		</div>
	</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURAZIONE ---
        const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. STATO E ELEMENTI DOM ---
        let state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null };
        state.currentDate.setDate(1);
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainEl = document.querySelector('main');
        const screens = { 
            'login-screen': document.getElementById('login-screen'), 
            'main-screen': document.getElementById('main-screen'),
            'schedule-settings-screen': document.getElementById('schedule-settings-screen'),
            'student-list-screen': document.getElementById('student-list-screen'),
            'booking-screen': document.getElementById('booking-screen'),
            'notifications-screen': document.getElementById('notifications-screen'),
        };

        // --- 3. FUNZIONI UTILITY ---
        const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
        const navigateTo = (screenId) => {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
        };
        const formatDate = (date) => date.toISOString().split('T')[0];
        const formatTime = (timeStr) => timeStr.substring(0, 5); // From HH:MM:SS to HH:MM

        // --- 4. FUNZIONI CORE ---
        const login = async () => {
            const code = document.getElementById('student-code').value.toUpperCase().trim();
            if (!code) return;
            showLoading(true);
            const { data: user, error } = await supabase.from('users').select('*').eq('code', code).single();
            showLoading(false);
            if (error && error.code !== 'PGRST116') return alert('Errore di connessione.');
            if (user) {
                state.currentUser = user;
                document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
                await loadInitialData();
                if (user.role === 'admin') {
                    updateAdminUI();
                } else {
                    checkStudentReplies();
                    renderStudentBookingSummary();
                }
                navigateTo('main-screen');
            } else {
                alert('Codice non valido. Riprova.');
            }
        };

        const loadInitialData = async () => {
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('location, work_days');
            showLoading(false);
            if (error) return console.error("Errore caricamento config calendario:", error);
            state.scheduleConfig = {};
            if (data) data.forEach(item => { state.scheduleConfig[item.location] = item.work_days || []; });
            renderLocationButtons();
        };

        const renderLocationButtons = () => {
            const container = document.getElementById('location-buttons-container');
            container.innerHTML = '';
            const locations = Object.keys(state.scheduleConfig);
            if (locations.length > 0) {
                locations.forEach(location => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.dataset.location = location;
                    btn.textContent = location;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = `<p style="text-align:center; color: #666;">Nessuna sede configurata.</p>`;
            }
        };

        const updateAdminUI = async () => {
            const adminActionsDiv = document.getElementById('admin-actions');
            const { data, error, count } = await supabase.from('notifications').select('*', { count: 'exact' }).eq('status', 'pending');

            adminActionsDiv.innerHTML = `
                <button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button>
                <button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button>
                <button id="view-notifications-btn" class="btn btn-secondary">Notifiche Studenti (${count ?? 0})</button>
            `;
        };

        const logout = () => {
            state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null };
            state.currentDate.setDate(1);
            document.getElementById('student-code').value = '';
            document.getElementById('admin-actions').innerHTML = '';
            document.getElementById('student-bookings-summary').innerHTML = '';
            navigateTo('login-screen');
        };

        const renderStudentBookingSummary = async () => {
            const summaryDiv = document.getElementById('student-bookings-summary');
            summaryDiv.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            showLoading(true);
            const { data: bookings, error } = await supabase.from('bookings').select('*').eq('user_code', state.currentUser.code).gte('date', formatDate(today)).order('date').order('start_time');
            showLoading(false);

            if (error) return console.error("Errore caricamento prenotazioni:", error);

            if (bookings.length > 0) {
                let html = '<h4>Le Tue Prossime Lezioni</h4>';
                bookings.forEach(booking => {
                    const lessonStart = new Date(`${booking.date}T${booking.start_time}`);
                    const hoursUntilLesson = (lessonStart - new Date()) / (1000 * 60 * 60);
                    const canRequestChange = hoursUntilLesson > 36;

                    html += `
                        <div class="booked-slot">
                            <span>
                                <strong>${new Date(booking.date + 'T00:00:00').toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</strong><br>
                                <small>Ore: ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)} (${booking.location})</small>
                            </span>
                            <button class="btn-request-change" data-booking-id="${booking.id}" ${canRequestChange ? '' : 'disabled'}>
                                ${canRequestChange ? 'Richiedi Cambio' : 'Scaduto'}
                            </button>
                        </div>
                    `;
                });
                summaryDiv.innerHTML = html;
            } else {
                summaryDiv.innerHTML = "<p style='text-align:center;'>Nessuna lezione futura prenotata.</p>";
            }
        };

        const checkStudentReplies = async () => {
            const { data, error } = await supabase.from('notifications')
                .select('*')
                .eq('student_code', state.currentUser.code)
                .eq('status', 'replied');

            if (error || data.length === 0) return;

            let alertMessage = "L'amministratore ha risposto alle tue richieste:\n\n";
            const idsToArchive = [];
            data.forEach(reply => {
                alertMessage += `--- Richiesta del ${new Date(reply.created_at).toLocaleDateString('it-IT')} ---\n`;
                alertMessage += `Messaggio: "${reply.reply_message}"\n\n`;
                idsToArchive.push(reply.id);
            });
            alert(alertMessage);

            // Archive notifications
            await supabase.from('notifications').update({ status: 'archived' }).in('id', idsToArchive);
        };
        
        // --- 5. FUNZIONI GESTIONE CALENDARIO ---
        const isDayOfWeekAvailable = (date, location) => {
            const dayOfWeek = date.getDay(); // 0 = Domenica, 1 = Lunedì...
            return state.scheduleConfig[location]?.includes(dayOfWeek) || false;
        };
        
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('time-slots-container').style.display = 'none';
            state.selectedDate = null;
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
            for (let i = 0; i < dayOfWeek; i++) { calendarGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.classList.add('calendar-day');
                if (isDayOfWeekAvailable(date, state.currentLocation)) {
                    dayEl.classList.add('valid');
                    dayEl.dataset.date = formatDate(date);
                } else {
                    dayEl.classList.add('invalid');
                }
                calendarGrid.appendChild(dayEl);
            }
        };

        const renderTimeSlots = async (dateStr) => {
            state.selectedDate = new Date(dateStr + 'T00:00:00');
            document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
            document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');
            document.getElementById('selected-date-label').textContent = state.selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('time-slots-container').style.display = 'block';

            if (state.currentUser.role === 'admin') {
                await renderAdminTimeGrid(dateStr, state.currentLocation);
            } else {
                await renderStudentTimeSlots(dateStr, state.currentLocation);
            }
        };

        const renderAdminTimeGrid = async (dateStr, location) => {
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = 'Caricamento...';
            showLoading(true);
            const { data: bookings, error: bookingsError } = await supabase.from('bookings').select('*, users(name)').eq('date', dateStr).eq('location', location);
            const { data: blocked, error: blockedError } = await supabase.from('blocked_slots').select('*').eq('date', dateStr).eq('location', location);
            showLoading(false);

            if (bookingsError || blockedError) return console.error(bookingsError || blockedError);

            const generateTimeSlots = (start, end, interval) => Array.from({length: (end - start) * (60 / interval)}, (_, i) => {
                const date = new Date(0);
                date.setUTCHours(start, i * interval, 0, 0);
                return date.toISOString().substring(11, 16);
            });
            const allSlots = generateTimeSlots(15, 21, 15);
            
            let gridHtml = '<div class="admin-time-grid">';
            gridHtml += allSlots.map(slot => {
                let status = 'free', tooltip = `Orario: ${slot}, Libero`;
                const booking = bookings.find(b => slot >= formatTime(b.start_time) && slot < formatTime(b.end_time));
                if (booking) {
                    status = 'booked';
                    tooltip = `Occupato da: ${booking.users.name}`;
                } else if (blocked.some(b => slot >= formatTime(b.start_time) && slot < formatTime(b.end_time))) {
                    status = 'blocked';
                    tooltip = 'Bloccato';
                }
                return `<div class="time-slot ${status}" data-time="${slot}" title="${tooltip}">${slot}</div>`;
            }).join('');
            gridHtml += '</div>';
            slotsContent.innerHTML = gridHtml;
        };

        const renderStudentTimeSlots = async (dateStr, location) => {
            const slotsContent = document.getElementById('slots-content');
            slotsContent.innerHTML = 'Caricamento...';
            showLoading(true);
            const { data: bookings, error: bErr } = await supabase.from('bookings').select('*').eq('date', dateStr).eq('location', location);
            const { data: blocked, error: blErr } = await supabase.from('blocked_slots').select('*').eq('date', dateStr).eq('location', location);
            showLoading(false);

            if (bErr || blErr) return console.error(bErr || blErr);
            
            const allEvents = [...bookings, ...blocked].sort((a,b) => a.start_time.localeCompare(b.start_time));

            const isTimespanFree = (checkStart, checkEnd) => !allEvents.some(event => {
                const eventStart = new Date(`${dateStr}T${event.start_time}`);
                const eventEnd = new Date(`${dateStr}T${event.end_time}`);
                return checkStart < eventEnd && checkEnd > eventStart;
            });
            
            const getAvailableSlots = (duration) => {
                const available = new Set();
                const now = new Date();
                const potentialStarts = new Set(["15:00"]);
                allEvents.forEach(e => potentialStarts.add(formatTime(e.end_time)));

                potentialStarts.forEach(timeStr => {
                    const potentialStart = new Date(`${dateStr}T${timeStr}`);
                    if ((potentialStart - now) / (1000 * 60 * 60) <= 12) return;
                    
                    const potentialEnd = new Date(potentialStart.getTime() + duration * 60000);
                    if (potentialEnd <= new Date(`${dateStr}T21:00:00`) && isTimespanFree(potentialStart, potentialEnd)) {
                        available.add(timeStr);
                    }
                });
                return Array.from(available).sort();
            };
            
            const slots45 = getAvailableSlots(45), slots60 = getAvailableSlots(60);
            let html = `<h4>Crea Nuova Prenotazione</h4>`;
            if (slots45.length === 0 && slots60.length === 0) {
                html += "<p>Nessun orario disponibile per nuove prenotazioni.</p>";
            } else {
                 html += '<div class="student-time-slots">';
                if (slots45.length > 0) {
                    html += '<h5>Lezione da 45 minuti</h5>';
                    slots45.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn-book" data-time="${slot}" data-duration="45">Prenota</button></div>`; });
                }
                if (slots60.length > 0) {
                    html += '<h5>Lezione da 60 minuti</h5>';
                    slots60.forEach(slot => { html += `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn-book" data-time="${slot}" data-duration="60">Prenota</button></div>`; });
                }
                html += '</div>';
            }
            slotsContent.innerHTML = html;
        };

        // --- 6. FUNZIONI ADMIN ---
        const renderStudentList = async () => {
            const listDiv = document.getElementById('student-list');
            listDiv.innerHTML = '';
            showLoading(true);
            const { data: users, error } = await supabase.from('users').select('*').eq('role', 'student').order('name');
            showLoading(false);
            if (error) return console.error("Errore caricamento allievi:", error);
            users.forEach(student => {
                listDiv.innerHTML += `
                    <div class="student-list-item">
                        <div class="student-info">${student.name}<br><small style="color: #6c757d;">Codice: ${student.code}</small></div>
                        <div class="student-actions">
                            <button class="btn btn-secondary btn-sm btn-edit-student" data-id="${student.id}" data-name="${student.name}" data-code="${student.code}">Modifica</button>
                            <button class="btn btn-danger btn-sm btn-delete-student" data-id="${student.id}" data-name="${student.name}" data-code="${student.code}">Elimina</button>
                        </div>
                    </div>`;
            });
        };

        const showUserModal = (isEdit, userData = {}) => {
            document.getElementById('user-modal-title').textContent = isEdit ? 'Modifica Allievo' : 'Crea Nuovo Allievo';
            document.getElementById('user-modal-name').value = userData.name || '';
            document.getElementById('user-modal-code').value = userData.code || '';
            const saveBtn = document.getElementById('user-modal-save');
            saveBtn.onclick = () => handleSaveUser(userData.id);
            document.getElementById('user-modal-overlay').style.display = 'flex';
        };

        const handleSaveUser = async (userId) => {
            const name = document.getElementById('user-modal-name').value.trim();
            const code = document.getElementById('user-modal-code').value.toUpperCase().trim();
            if (!name || !code) return alert("Nome e Codice non possono essere vuoti.");
            
            showLoading(true);
            const { error } = userId 
                ? await supabase.from('users').update({ name, code }).eq('id', userId)
                : await supabase.from('users').insert({ name, code, role: 'student' });
            showLoading(false);
            
            if (error) return alert("Errore: il codice potrebbe essere già in uso.");
            
            alert(`Allievo "${name}" salvato.`);
            await renderStudentList();
            document.getElementById('user-modal-overlay').style.display = 'none';
        };

        const deleteUser = async (userId, userName, userCode) => {
            if (!confirm(`Sei sicuro di voler eliminare "${userName}"? Verranno cancellate anche tutte le sue prenotazioni.`)) return;
            showLoading(true);
            // La foreign key con ON DELETE CASCADE si occuperà delle prenotazioni.
            const { error } = await supabase.from('users').delete().eq('id', userId);
            showLoading(false);
            if (error) return alert("Errore durante l'eliminazione.");
            alert("Allievo eliminato.");
            await renderStudentList();
        };

        const renderScheduleSettings = async () => {
            const contentDiv = document.getElementById('schedule-settings-content');
            contentDiv.innerHTML = 'Caricamento...';
            const daysOfWeek = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('*').order('location');
            showLoading(false);
            if(error) return console.error("Errore caricamento impostazioni:", error);

            contentDiv.innerHTML = '';
            data.forEach(locationData => {
                let locationHtml = `<div style="border:1px solid #eee; padding:1rem; border-radius:8px; margin-bottom:1rem;"><div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0;">${locationData.location}</h4><button class="btn btn-danger btn-sm btn-remove-location" data-location="${locationData.location}">&times; Rimuovi</button></div><div class="days-checkboxes" data-location="${locationData.location}" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;">`;
                for (let i = 1; i <= 6; i++) { // From Monday to Saturday
                    const isChecked = (locationData.work_days || []).includes(i);
                    locationHtml += `<div><input type="checkbox" id="${locationData.location}-${i}" value="${i}" ${isChecked ? 'checked' : ''}><label for="${locationData.location}-${i}" style="margin-left:0.25rem;">${daysOfWeek[i]}</label></div>`;
                }
                locationHtml += `</div></div>`;
                contentDiv.innerHTML += locationHtml;
            });
        };

        const saveScheduleSettings = async () => {
            const updates = [];
            document.querySelectorAll('.days-checkboxes').forEach(div => {
                const location = div.dataset.location;
                const work_days = Array.from(div.querySelectorAll('input:checked')).map(box => parseInt(box.value));
                updates.push({ location, work_days });
            });
            showLoading(true);
            // Upsert is perfect here: it updates existing locations and inserts new ones.
            const { error } = await supabase.from('schedule_config').upsert(updates, { onConflict: 'location' });
            showLoading(false);
            if(error) { alert("Errore nel salvataggio."); console.error(error); } 
            else { alert("Impostazioni salvate."); await loadInitialData(); navigateTo('main-screen'); }
        };

        const addLocation = async () => {
            const input = document.getElementById('new-location-name');
            const newLocationName = input.value.trim();
            if (!newLocationName) return;
            showLoading(true);
            const { error } = await supabase.from('schedule_config').insert({ location: newLocationName, work_days: [] });
            showLoading(false);
            if(error) { alert("Errore: la sede potrebbe già esistere."); } 
            else { await renderScheduleSettings(); input.value = ''; }
        };
        
        const removeLocation = async (locationToRemove) => {
            if (!confirm(`Sei sicuro di voler rimuovere la sede "${locationToRemove}"?`)) return;
            showLoading(true);
            const { error } = await supabase.from('schedule_config').delete().eq('location', locationToRemove);
            showLoading(false);
            if(error) { alert("Errore durante la rimozione."); } 
            else { await renderScheduleSettings(); }
        };

        const renderNotifications = async () => {
            const listDiv = document.getElementById('notifications-list');
            showLoading(true);
            const { data: notifications, error } = await supabase.from('notifications')
                .select('*, bookings(*)')
                .eq('status', 'pending');
            showLoading(false);

            if (error) return console.error(error);

            if (!notifications || notifications.length === 0) {
                listDiv.innerHTML = '<p>Nessuna nuova notifica.</p>';
                return;
            }

            listDiv.innerHTML = notifications.map(n => `
                <div class="notification-item" data-notification-id="${n.id}">
                    <p>Da: <strong>${n.student_name}</strong></p>
                    <p>Richiesta: <em>"${n.message}"</em></p>
                    <div class="notification-details">
                        Lezione da modificare:<br>
                        Sede: ${n.bookings.location}<br>
                        Giorno: ${new Date(n.bookings.date + 'T00:00:00').toLocaleDateString('it-IT')}<br>
                        Orario: ${formatTime(n.bookings.start_time)} - ${formatTime(n.bookings.end_time)}
                    </div>
                    <textarea placeholder="Scrivi la risposta qui..." style="margin-bottom: 0.5rem;"></textarea>
                    <button class="btn btn-primary btn-sm btn-reply">Invia Risposta</button>
                    <button class="btn btn-secondary btn-sm btn-mark-read">Segna come Letta</button>
                </div>
            `).join('');
        };

        // --- 7. EVENT LISTENERS ---
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        document.getElementById('location-buttons-container').addEventListener('click', (e) => {
            const location = e.target.dataset.location;
            if (location) {
                state.currentLocation = location;
                document.getElementById('booking-location-title').textContent = `Sede di ${location}`;
                state.currentDate = new Date();
                state.currentDate.setDate(1);
                renderCalendar();
                navigateTo('booking-screen');
            }
        });

        document.getElementById('booking-screen').addEventListener('click', async (e) => {
            if (e.target.id === 'back-to-main-btn') return navigateTo('main-screen');
            if (e.target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
            if (e.target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
            if (e.target.classList.contains('valid')) {
                await renderTimeSlots(e.target.dataset.date);
            }
        });

        mainEl.addEventListener('click', async (e) => {
            if (e.target.id === 'manage-students-btn') { await renderStudentList(); navigateTo('student-list-screen'); }
            if (e.target.id === 'manage-schedule-btn') { await renderScheduleSettings(); navigateTo('schedule-settings-screen'); }
            if (e.target.id === 'view-notifications-btn') { await renderNotifications(); navigateTo('notifications-screen'); }
            if (e.target.id === 'back-to-main-from-student-list-btn' || e.target.id === 'back-to-main-from-schedule-settings-btn' || e.target.id === 'back-to-main-from-notifications-btn') { navigateTo('main-screen'); }
        });

        document.getElementById('student-list-screen').addEventListener('click', (e) => {
            const target = e.target;
            if (target.id === 'create-student-btn') showUserModal(false);
            if (target.classList.contains('btn-edit-student')) showUserModal(true, target.dataset);
            if (target.classList.contains('btn-delete-student')) deleteUser(target.dataset.id, target.dataset.name, target.dataset.code);
        });

        document.getElementById('schedule-settings-screen').addEventListener('click', async (e) => {
            if (e.target.id === 'add-location-btn') await addLocation();
            if (e.target.id === 'save-schedule-settings-btn') await saveScheduleSettings();
            if (e.target.classList.contains('btn-remove-location')) await removeLocation(e.target.dataset.location);
        });
        
        document.getElementById('slots-content').addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-book')) {
                const startTime = e.target.dataset.time;
                const duration = parseInt(e.target.dataset.duration);
                const dateStr = formatDate(state.selectedDate);
                if (confirm(`Confermi la prenotazione per ${state.selectedDate.toLocaleDateString('it-IT')} alle ${startTime} per ${duration} minuti?`)) {
                    const startDateTime = new Date(`${dateStr}T${startTime}`);
                    const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
                    const endTime = endDateTime.toTimeString().substring(0, 8);
                    
                    showLoading(true);
                    const { error } = await supabase.from('bookings').insert({
                        user_code: state.currentUser.code,
                        location: state.currentLocation,
                        date: dateStr,
                        start_time: startTime,
                        end_time: endTime
                    });
                    showLoading(false);

                    if (error) {
                        alert("Errore durante la prenotazione.");
                        console.error(error);
                    } else {
                        alert("Prenotazione confermata!");
                        await renderTimeSlots(dateStr);
                        await renderStudentBookingSummary();
                    }
                }
            }
        });

        document.getElementById('student-bookings-summary').addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-request-change')) {
                const bookingId = e.target.dataset.bookingId;
                const message = prompt("Scrivi un messaggio per l'amministratore riguardo la tua richiesta di cambio (es. 'Vorrei spostare ad un altro giorno in settimana'):");
                if (message && message.trim()) {
                    showLoading(true);
                    const { error } = await supabase.from('notifications').insert({
                        student_code: state.currentUser.code,
                        student_name: state.currentUser.name,
                        message: message.trim(),
                        booking_id: bookingId,
                        status: 'pending'
                    });
                    showLoading(false);
                    if (error) {
                        alert("Errore nell'invio della richiesta.");
                    } else {
                        alert("Richiesta inviata. Verrai avvisato quando l'amministratore risponderà.");
                    }
                }
            }
        });

        document.getElementById('notifications-list').addEventListener('click', async (e) => {
            const item = e.target.closest('.notification-item');
            if (!item) return;
            const notificationId = item.dataset.notificationId;

            if (e.target.classList.contains('btn-mark-read')) {
                showLoading(true);
                await supabase.from('notifications').update({ status: 'read' }).eq('id', notificationId);
                showLoading(false);
                await renderNotifications();
                await updateAdminUI();
            } else if (e.target.classList.contains('btn-reply')) {
                const replyMessage = item.querySelector('textarea').value.trim();
                if (!replyMessage) return alert("Scrivi un messaggio di risposta.");
                showLoading(true);
                await supabase.from('notifications').update({ status: 'replied', reply_message: replyMessage }).eq('id', notificationId);
                showLoading(false);
                await renderNotifications();
                await updateAdminUI();
            }
        });

        document.getElementById('user-modal-cancel').addEventListener('click', () => { document.getElementById('user-modal-overlay').style.display = 'none'; });
    });
    </script>
</body>
</html>