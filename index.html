<!doctype html>
<html lang="it">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Vocal Hub Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		:root {
			--header-bg: #000000;
			--button-primary-bg: #ffc107;
			--button-primary-text: #000000;
			--secondary-color: #6c757d;
			--success-color: #28a745;
			--danger-color: #dc3545;
			--light-color: #f8f9fa;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			margin: 0;
			background-color: var(--light-color);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			padding: 1rem 0;
		}

		.app-container {
			width: 100%;
			max-width: 480px;
			background-color: white;
			border-radius: 8px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
			overflow: hidden;
		}

		header {
			background-color: var(--header-bg);
			color: white;
			text-align: center;
		}

		main {
			padding: 1.5rem;
		}

		.screen { display: none; }
		.screen.active { display: block; }
        h2, h3, h4 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"] { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem; }
        .btn-logout { background-color: var(--danger-color); color: white; margin-top: 1rem; }
        #loading-spinner {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			z-index: 2000;
			background-color: rgba(255,255,255,0.8);
			padding: 2rem;
			border-radius: 8px;
			box-shadow: 0 5px 15px rgba(0,0,0,0.2);
			font-weight: bold;
		}
	</style>
</head>

<body>
    <div id="loading-spinner">Caricamento...</div>
	<div class="app-container">
		<header id="app-header" style="padding: 0.5rem;">
			<img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>
			<main>
				<div id="login-screen" class="screen active">
					<h2>Accesso</h2>
					<div class="form-group">
						<label for="student-code">Codice Allievo</label>
						<input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off">
                    </div>
					<button id="login-btn" class="btn btn-primary">Accedi</button>
				</div>
				<div id="main-screen" class="screen">
					<h2 id="welcome-message"></h2>
					<div id="student-bookings-summary"></div>
					<p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p>
					<div id="location-buttons-container"></div>
					<div id="admin-actions"></div>
					<button id="logout-btn" class="btn btn-logout">Esci</button>
				</div>
                </main>
	</div>

	<script>
	document.addEventListener('DOMContentLoaded', () => {

        // --- 1. CONFIGURAZIONE ---
		const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
		const supabase = supabase.createClient(supabaseUrl, supabaseKey);
		
		console.log('Supabase Inizializzato');

        // --- 2. STATO DELL'APPLICAZIONE E UTILITY ---
        const state = { 
            currentUser: null, 
            currentScreen: 'login-screen', 
            // ... altri stati UI
        };
        const loadingSpinner = document.getElementById('loading-spinner');
		const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
        
        const screens = { 
            'login-screen': document.getElementById('login-screen'), 
            'main-screen': document.getElementById('main-screen'),
            // Aggiungi qui gli ID delle altre schermate se le inserisci nell'HTML
        };
        const navigateTo = (screenId) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenId]) {
                screens[screenId].classList.add('active');
            } else {
                console.error(`Schermata non trovata: ${screenId}`);
            }
        };

        // --- 3. FUNZIONI DI INTERAZIONE CON SUPABASE ---

        // Funzione di Login
        const login = async () => {
            const codeInput = document.getElementById('student-code');
            const code = codeInput.value.toUpperCase().trim();
            if (!code) return;

            showLoading(true);
            const { data: user, error } = await supabase
                .from('users')
                .select('*')
                .eq('code', code)
                .single();
            showLoading(false);

            if (error && error.code !== 'PGRST116') {
                console.error('Errore durante il login:', error);
                alert('Si è verificato un errore di connessione.');
                return;
            }

            if (user) {
                state.currentUser = user;
                document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
                
                // Popola dinamicamente i dati della dashboard
                await renderLocationButtons();
                if(user.role === 'admin') {
                    // await updateAdminUI(); // Da implementare
                } else {
                    await renderStudentBookingSummary();
                }

                navigateTo('main-screen');
            } else {
                alert('Codice non valido. Riprova.');
                codeInput.focus();
            }
        };

        // Funzione per mostrare le sedi
        const renderLocationButtons = async () => {
            const container = document.getElementById('location-buttons-container');
            container.innerHTML = '';
            
            showLoading(true);
            const { data: locations, error } = await supabase
                .from('schedule_config')
                .select('location');
            showLoading(false);

            if(error) {
                console.error("Errore nel caricare le sedi:", error);
                container.innerHTML = "<p>Errore nel caricamento delle sedi.</p>";
                return;
            }

            if (locations && locations.length > 0) {
                locations.forEach(loc => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary location-btn';
                    btn.dataset.location = loc.location;
                    btn.textContent = loc.location;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = `<p style="text-align:center; color: #666;">Nessuna sede configurata.</p>`;
            }
        };
        
        // Funzione per mostrare le prenotazioni future dello studente
        const renderStudentBookingSummary = async () => {
            const summaryDiv = document.getElementById('student-bookings-summary');
            if (!summaryDiv) return;

            summaryDiv.innerHTML = '<h4>Le Tue Prossime Lezioni</h4>';
            const today = new Date().toISOString().split('T')[0];

            showLoading(true);
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*')
                .eq('user_code', state.currentUser.code)
                .gte('date', today)
                .order('date', { ascending: true })
                .order('start_time', { ascending: true });
            showLoading(false);

            if (error) {
                console.error("Errore nel caricare le prenotazioni:", error);
                summaryDiv.innerHTML += '<p>Impossibile caricare le lezioni.</p>';
                return;
            }

            if (bookings && bookings.length > 0) {
                let html = bookings.map(b => 
                    `<div style="padding:1rem; border:1px solid #ddd; margin-bottom:0.5rem; border-radius:4px; background-color:#e9ecef; display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <strong>${new Date(b.date).toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long', timeZone: 'UTC'})}</strong><br>
                            <small>Ore: ${b.start_time.substring(0,5)} - ${b.end_time.substring(0,5)} (${b.location})</small>
                        </span>
                    </div>`
                ).join('');
                summaryDiv.innerHTML += html;
            } else {
                summaryDiv.innerHTML += "<p style='text-align:center;'>Nessuna lezione futura prenotata.</p>";
            }
        };
        
        // Funzione di Logout
        const logout = () => {
            state.currentUser = null;
            document.getElementById('student-code').value = '';
            navigateTo('login-screen');
        };

        // --- 4. EVENT LISTENERS ---
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        // Questo è lo scheletro funzionante. Da qui si possono aggiungere le altre schermate
        // e collegare le funzioni JS (es. cliccando su una sede, si apre la schermata di prenotazione
        // che a sua volta leggerà e scriverà sulla tabella `bookings` e `blocked_slots`).

	});
	</script>
</body>
</html>