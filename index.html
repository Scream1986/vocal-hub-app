<!doctype html>
<html>
<head>
</head>
<body>
<!DOCTYPE html>
<html lang="it">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Prenotazione Lezioni di Canto 5.0 - Online</title>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	
	<style>
		:root {
			--header-bg: #000000;
			--button-primary-bg: #ffc107;
			--button-primary-text: #000000;
			--secondary-color: #6c757d;
			--success-color: #28a745;
			--danger-color: #dc3545;
			--light-color: #f8f9fa;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			margin: 0;
			background-color: var(--light-color);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			padding: 1rem 0;
		}

		.app-container {
			width: 100%;
			max-width: 480px;
			background-color: white;
			border-radius: 8px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
			overflow: hidden;
		}

		header {
			background-color: var(--header-bg);
			color: white;
			text-align: center;
		}

		main {
			padding: 1.5rem;
		}

		.screen {
			display: none;
		}

		.screen.active {
			display: block;
		}

		h2,
		h3,
		h4 {
			margin-top: 0;
			text-align: center;
		}
		
		/* ... Stili CSS omessi per brevità, sono identici alla versione 4.0 ... */
		
	</style>
</head>

<body>

	<div class="app-container">
		<header id="app-header" style="padding: 0.5rem;">
			<img src="https://wboqltikfutuijhwvuel.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>

			<main>
				<div id="login-screen" class="screen active">
					<h2>Accesso</h2>
					<div class="form-group">
						<label for="student-code">Codice Allievo</label>
						<input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off">
					</div>
					<button id="login-btn" class="btn btn-primary">Accedi</button>
					<div id="loading-spinner" style="display:none; text-align:center; padding:1rem;">Caricamento...</div>
				</div>

				</main>
	</div>

	<script>
	document.addEventListener('DOMContentLoaded', () => {

		// --- NUOVO: Configurazione della connessione a Supabase ---
		const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
		const supabaseKey = 'eyJhbGciOiJIJWTJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
		const supabase = supabase.createClient(supabaseUrl, supabaseKey);
		
		console.log('Supabase Inizializzato');

		// --- MODIFICATO: Lo stato non contiene più i dati, solo lo stato dell'interfaccia ---
		const state = { 
			currentUser: null, 
			currentScreen: 'login-screen', 
			currentLocation: null, 
			currentDate: new Date(), 
			selectedDate: null, 
			scheduleCurrentDate: new Date(), 
			viewingStudentCode: null 
		};
		state.currentDate.setDate(1);

		const screens = { 
			'login-screen': document.getElementById('login-screen'),
			// ... altre schermate
		};
		const loadingSpinner = document.getElementById('loading-spinner');

		const showLoading = (show) => {
			loadingSpinner.style.display = show ? 'block' : 'none';
		};

		const navigateTo = (screenId) => {
			for (const key in screens) {
				if(screens[key]) screens[key].classList.remove('active');
			}
			if (screens[screenId]) {
				screens[screenId].classList.add('active');
			}
		};

		// --- NUOVA VERSIONE ASINCRONA DELLE FUNZIONI ---
		// Ogni funzione che interagisce con i dati ora è 'async' e usa 'await'
		
		const login = async () => {
			const codeInput = document.getElementById('student-code');
			const code = codeInput.value.toUpperCase().trim();
			if (!code) return;

			showLoading(true);
			
			const { data: user, error } = await supabase
				.from('users')
				.select('*')
				.eq('code', code)
				.single();

			showLoading(false);

			if (error && error.code !== 'PGRST116') { // Ignora l'errore "nessuna riga trovata"
				console.error('Errore durante il login:', error);
				alert('Si è verificato un errore di connessione.');
				return;
			}

			if (user) {
				state.currentUser = user;
				document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
				
				// Carica dinamicamente i dati necessari per questo utente
				await renderLocationButtons();
				if (user.role === 'admin') {
					await updateAdminUI();
				} else {
					// await checkStudentReplies(); // Funzionalità da implementare
					await renderStudentBookingSummary();
				}
				navigateTo('main-screen');
			} else {
				alert('Codice non valido. Riprova.');
				codeInput.focus();
			}
		};

		const renderStudentBookingSummary = async () => {
			const summaryDiv = document.getElementById('student-bookings-summary');
			summaryDiv.innerHTML = '<h4>Le Tue Prossime Lezioni</h4>';
			const today = new Date().toISOString().split('T')[0];

			const { data: bookings, error } = await supabase
				.from('bookings')
				.select('*')
				.eq('user_code', state.currentUser.code)
				.gte('date', today)
				.order('date', { ascending: true })
				.order('start_time', { ascending: true });

			if (error) {
				console.error("Errore nel caricare le prenotazioni:", error);
				summaryDiv.innerHTML += '<p>Impossibile caricare le lezioni.</p>';
				return;
			}
			
			if (bookings && bookings.length > 0) {
				let html = '';
				bookings.forEach(booking => {
					// La logica per creare l'HTML della prenotazione è la stessa di prima
					// ...
					html += `<div class="booked-slot">...</div>`;
				});
				summaryDiv.innerHTML += html;
			} else {
				summaryDiv.innerHTML = "<p style='text-align:center;'>Nessuna lezione futura prenotata.</p><hr>";
			}
		};

		const handleSaveUser = async (originalCode = null) => {
			const name = document.getElementById('user-modal-name').value.trim();
			const code = document.getElementById('user-modal-code').value.toUpperCase().trim();

			if (!name || !code) {
				alert("Nome e Codice Allievo non possono essere vuoti.");
				return;
			}

			showLoading(true);
			let error;

			if (originalCode) {
				// MODIFICA
				const { error: updateError } = await supabase
					.from('users')
					.update({ name: name, code: code })
					.eq('code', originalCode);
				error = updateError;
			} else {
				// CREAZIONE
				const { error: insertError } = await supabase
					.from('users')
					.insert({ name: name, code: code, role: 'student' });
				error = insertError;
			}
			
			showLoading(false);

			if (error) {
				console.error("Errore nel salvataggio dell'utente:", error);
				alert("Errore: il codice potrebbe essere già in uso o c'è un problema di connessione.");
			} else {
				alert(`Allievo "${name}" salvato con successo!`);
				await renderStudentList();
				showUserModal(false);
			}
		};

		// ... e così via per TUTTE le altre funzioni (renderStudentList, deleteUser, renderCalendar, etc.)
		// Ognuna di esse deve essere riscritta per usare `await supabase.from(...)` invece che l'oggetto `db`.
		// Questo è un esempio abbreviato per mostrarti la struttura.
		
		// Aggiungi gli event listener
		document.getElementById('login-btn').addEventListener('click', login);
		// ... tutti gli altri listener ...

	});
	</script>
</body>

</html>
</body>
</html>