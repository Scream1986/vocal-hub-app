<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vocal Hub Online</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --header-bg: #000000;
      --button-primary-bg: #ffc107;
      --button-primary-hover-bg: #e0a800;
      --button-secondary-bg: #6c757d;
      --button-secondary-hover-bg: #5a6268;
      --text-color: #212529;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-color: #f8f9fa;
    }

    * { box-sizing: border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; color: var(--text-color); background: #f3f5f7; margin: 0; }
    .centered { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
    .app-container { width: 100%; max-width: 480px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,.1); overflow: hidden; }
    header { background: var(--header-bg); color: white; text-align: center; padding: .5rem 0; }
    main { padding: 1.5rem; }
    .screen { display: none; }
    .screen.active { display: block; }

    h2, h3, h4 { margin-top: 0; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 500; margin-bottom: .5rem; }
    input[type="text"] { width: 100%; padding: .75rem; border: 1px solid #ccc; border-radius: 4px; }

    .btn { width: 100%; padding: .75rem 1rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color .2s, opacity .2s; }
    .btn + .btn { margin-top: .5rem; }
    .btn-primary { background: var(--button-primary-bg); }
    .btn-primary:hover { background: var(--button-primary-hover-bg); }
    .btn-secondary { background: var(--button-secondary-bg); color: white; }
    .btn-secondary:hover { background: var(--button-secondary-hover-bg); }
    .btn-logout { background: #efefef; color: #333; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-sm { padding: .35rem .5rem; font-size: .9rem; }

    .pill { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.8rem; background:#eee; }

    .calendar { margin-top: 1.5rem; }
    #calendar-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:1rem; }
    #calendar-weekdays, #calendar-grid { display:grid; grid-template-columns: repeat(7,1fr); gap:5px; text-align:center; }
    .calendar-day, .weekday { padding: .75rem .25rem; border-radius: 4px; }
    .weekday { font-weight: bold; }
    .calendar-day.invalid { color:#ccc; pointer-events:none; }
    .calendar-day.valid { background:#ffffff; border:1px solid #ddd; cursor:pointer; }
    .calendar-day.selected { background: var(--button-primary-bg); color:black; font-weight:700; border:1px solid var(--button-primary-bg); }

    .admin-time-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap:8px; }
    .time-slot { padding:.5rem; border-radius:4px; text-align:center; font-weight:600; font-size:.9rem; color:white; border:1px solid rgba(0,0,0,.1); cursor:pointer; }
    .time-slot.free { background: var(--success-color); }
    .time-slot.booked { background: var(--button-secondary-bg); }
    .time-slot.blocked { background: var(--danger-color); }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: .5rem; }
    .list-card { border:1px solid #eee; padding:.75rem; border-radius:8px; display:flex; justify-content:space-between; align-items:center; }
    .student-info { font-weight:500; }
    .student-actions .btn { width:auto; margin:0 0 0 .5rem; }

    .day-week-controls { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom: .75rem; }

    .modal-overlay { display:none; position:fixed; inset:0; background: rgba(0,0,0,.4); z-index:10; align-items:center; justify-content:center; padding: 1rem; }
    .modal-content { background:white; border-radius:10px; padding:1rem; width:100%; max-width:420px; }
  </style>
</head>
<body>
<div class="centered">
  <div class="app-container">
    <header>
      <img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub" style="height:60px; width:auto; display:block; margin:0 auto;" />
    </header>
    <main>
      <!-- LOGIN -->
      <div id="login-screen" class="screen active">
        <h2>Accesso</h2>
        <div class="form-group">
          <label for="student-code">Codice Allievo</label>
          <input id="student-code" type="text" placeholder="Inserisci il tuo codice" autocomplete="off" />
        </div>
        <button id="login-btn" class="btn btn-primary">Accedi</button>
      </div>

      <!-- MAIN -->
      <div id="main-screen" class="screen">
        <h2 id="welcome-message"></h2>
        <div id="student-bookings-summary"></div>
        <p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p>
        <div id="location-buttons-container"></div>
        <div id="admin-actions"></div>
        <button id="logout-btn" class="btn btn-logout">Esci</button>
      </div>

      <!-- BOOKING -->
      <div id="booking-screen" class="screen">
        <h2 id="booking-location-title"></h2>
        <div id="booking-admin-actions"></div>
        <div class="calendar">
          <div id="calendar-header">
            <button id="prev-month-btn" class="btn btn-primary" style="width:auto; padding:.5rem 1rem;">&lt;</button>
            <h3 id="month-year-label"></h3>
            <button id="next-month-btn" class="btn btn-primary" style="width:auto; padding:.5rem 1rem;">&gt;</button>
          </div>
          <div id="calendar-weekdays">
            <div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div>
          </div>
          <div id="calendar-grid"></div>
        </div>
        <div id="time-slots-container" style="display:none; margin-top:1rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
            <div id="selected-date-label" class="pill"></div>
            <button id="back-to-main-btn" class="btn btn-secondary" style="width:auto;">Torna Indietro</button>
          </div>
          <div id="slots-content"></div>
        </div>
      </div>

      <!-- SCHEDULE SETTINGS -->
      <div id="schedule-settings-screen" class="screen">
        <h2>Impostazioni Calendario</h2>
        <div id="schedule-settings-content"></div>
        <hr />
        <div class="form-group">
          <label for="new-location">Nuova Sede</label>
          <input id="new-location" type="text" placeholder="Es. Dorsoduro" />
          <button id="add-location-btn" class="btn btn-secondary" style="margin-top:.5rem;">Aggiungi Sede</button>
        </div>
        <button id="save-schedule-settings-btn" class="btn btn-primary">Salva Modifiche</button>
        <button id="back-to-main-from-schedule-settings-btn" class="btn btn-secondary">Torna Indietro</button>
      </div>

      <!-- STUDENT LIST -->
      <div id="student-list-screen" class="screen">
        <h2>Gestione Allievi</h2>
        <button id="create-student-btn" class="btn btn-primary" style="margin-bottom:1rem;">+ Crea Nuovo Allievo</button>
        <div id="student-list"></div>
        <button id="back-to-main-from-student-list-btn" class="btn btn-secondary" style="margin-top:1rem;">Torna Indietro</button>
      </div>
    </main>
  </div>
</div>

<!-- USER MODAL -->
<div id="user-modal-overlay" class="modal-overlay">
  <div class="modal-content">
    <h4 id="user-modal-title">Crea Nuovo Allievo</h4>
    <div class="form-group"><label for="user-modal-name">Nome Allievo</label><input id="user-modal-name" type="text" /></div>
    <div class="form-group"><label for="user-modal-code">Codice Allievo</label><input id="user-modal-code" type="text" autocomplete="off" /></div>
    <div class="grid-2">
      <button id="user-modal-save" class="btn btn-success">Salva</button>
      <button id="user-modal-cancel" class="btn btn-secondary">Annulla</button>
    </div>
  </div>
</div>

<script>
  // === 0. Supabase ===
  const SUPABASE_URL = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // === 1. Stato ===
  let state = {
    currentUser: null, // {id,name,code,role}
    currentDate: new Date(),
    currentLocation: null,
    selectedDate: null,
    scheduleConfig: {} // { [location]: [1..6] }
  };

  // === 2. Helper UI ===
  const navigateTo = (id) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  };
  const formatDate = (d) => d.toISOString().slice(0,10);
  const showLoading = (show) => { document.body.style.cursor = show ? 'wait' : 'default'; };

  // === 3. Login ===
  const login = async () => {
    const code = (document.getElementById('student-code').value || '').trim();
    if (!code) return alert('Inserisci il codice.');
    showLoading(true);
    const { data: user, error } = await supabaseClient.from('users').select('*').eq('code', code).maybeSingle();
    showLoading(false);
    if (error || !user) return alert('Codice non valido.');
    state.currentUser = user;
    document.getElementById('student-code').value = '';
    document.getElementById('welcome-message').textContent = `Benvenuto, ${user.name}!`;
    await loadInitialData();
    navigateTo('main-screen');
  };
  const logout = () => {
    state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null };
    navigateTo('login-screen');
  };

  // === 4. Dati iniziali: sedi e giorni lavorativi ===
  const loadInitialData = async () => {
    const { data, error } = await supabaseClient.from('schedule_config').select('*');
    if (error) { console.error(error); return; }
    state.scheduleConfig = {};
    data.forEach(row => { state.scheduleConfig[row.location] = row.work_days || []; });
    renderLocationButtons();
    if (state.currentUser.role === 'admin') updateAdminUI();
  };

  const renderLocationButtons = () => {
    const container = document.getElementById('location-buttons-container');
    container.innerHTML = '';
    const locations = Object.keys(state.scheduleConfig);
    if (!locations.length) { container.innerHTML = '<p style="text-align:center; color:#666;">Nessuna sede configurata.</p>'; return; }
    locations.forEach(loc => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary';
      btn.dataset.location = loc;
      btn.textContent = loc;
      container.appendChild(btn);
    });
  };
  const updateAdminUI = () => {
    const div = document.getElementById('admin-actions');
    div.innerHTML = `
      <button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button>
      <button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button>
    `;
  };

  // === 5. Calendario e Slots ===
  const renderCalendar = () => {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
    document.getElementById('time-slots-container').style.display = 'none';
    state.selectedDate = null;

    const year = state.currentDate.getFullYear();
    const month = state.currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    let dayOfWeek = firstDay.getDay(); // 0=Dom..6=Sab
    dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // 0=Lun
    for (let i=0;i<dayOfWeek;i++) grid.insertAdjacentHTML('beforeend','<div></div>');

    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(year, month, day);
      const el = document.createElement('div');
      el.className = 'calendar-day';
      el.textContent = String(day);
      const wd = (date.getDay() + 6) % 7; // 0=Lun..6=Dom
      const work = state.scheduleConfig[state.currentLocation] || [];
      if (work.includes(wd+1)) { el.classList.add('valid'); el.dataset.date = formatDate(date); }
      else { el.classList.add('invalid'); }
      grid.appendChild(el);
    }
  };

  const generateTimeSlots = (startHour, endHour, intervalMinutes) => {
    const slots = [];
    let d = new Date(`1970-01-01T${startHour}:00:00Z`);
    const end = new Date(`1970-01-01T${endHour}:00:00Z`);
    while (d < end) { slots.push(d.toISOString().slice(11,16)); d = new Date(d.getTime() + intervalMinutes*60000); }
    return slots;
  };

  const renderAdminTimeGrid = async (dateStr, location) => {
    const slotsContent = document.getElementById('slots-content');
    slotsContent.innerHTML = '';
    showLoading(true);
    const { data: bookings, error: e1 } = await supabaseClient.from('bookings').select('start_time,end_time,user_code,package_id').eq('date', dateStr).eq('location', location);
    const { data: blocked, error: e2 } = await supabaseClient.from('blocked_slots').select('*').eq('date', dateStr).eq('location', location);
    showLoading(false);
    if (e1 || e2) { console.error(e1||e2); return; }

    const slots = generateTimeSlots(15, 21, 15);
    let html = '<div class="admin-time-grid">';
    html += slots.map(slot => {
      let status = 'free';
      let tooltip = `Orario: ${slot}, Libero`;
      const b = (bookings||[]).find(x => slot >= x.start_time.slice(0,5) && slot < x.end_time.slice(0,5));
      if (b) { status = 'booked'; tooltip = b.package_id ? 'Occupato (pacchetto)' : `Occupato (${b.user_code})`; }
      else {
        const isB = (blocked||[]).some(x => slot >= x.start_time.slice(0,5) && slot < x.end_time.slice(0,5));
        if (isB) { status = 'blocked'; tooltip = 'Bloccato'; }
      }
      return `<div class="time-slot ${status}" data-time="${slot}" title="${tooltip}">${slot}</div>`;
    }).join('');
    html += '</div>';
    slotsContent.innerHTML = html;
  };

  // === 6. Admin: blocchi & assegnazioni ===
  const addMinutes = (hhmm, minutes) => { const [h,m]=hhmm.split(':').map(Number); const d=new Date(1970,0,1,h,m,0); d.setMinutes(d.getMinutes()+minutes); return d.toTimeString().slice(0,5); };
  const weekRangeFor = (dateStr) => { const d=new Date(dateStr+'T00:00:00'); const day=(d.getDay()+6)%7; const mon=new Date(d); mon.setDate(d.getDate()-day); const sun=new Date(mon); sun.setDate(mon.getDate()+6); const fmt=x=>x.toISOString().slice(0,10); return {start:fmt(mon), end:fmt(sun)}; };
  const isFree = async (dateStr, location, a, b) => {
    const { data: bookings } = await supabaseClient.from('bookings').select('start_time,end_time').eq('date', dateStr).eq('location', location);
    const { data: blocked } = await supabaseClient.from('blocked_slots').select('start_time,end_time').eq('date', dateStr).eq('location', location);
    const overlaps = (x1,x2,y1,y2)=> (x1<y2 && y1<x2);
    if ((bookings||[]).some(x=> overlaps(a,b,x.start_time.slice(0,5),x.end_time.slice(0,5)))) return false;
    if ((blocked||[]).some(x=> overlaps(a,b,x.start_time.slice(0,5),x.end_time.slice(0,5)))) return false;
    return true;
  };
  const blockDay = async () => {
    if(!state.selectedDate) return; showLoading(true);
    const { error } = await supabaseClient.from('blocked_slots').insert({ location: state.currentLocation, date: state.selectedDate, start_time: '15:00:00', end_time: '21:00:00' });
    showLoading(false); if(error){ alert('Errore blocco giorno'); console.error(error);} else { await renderAdminTimeGrid(state.selectedDate,state.currentLocation);} };
  const unblockDay = async () => {
    if(!state.selectedDate) return; showLoading(true);
    const { error } = await supabaseClient.from('blocked_slots').delete().eq('location', state.currentLocation).eq('date', state.selectedDate);
    showLoading(false); if(error){ alert('Errore sblocco giorno'); console.error(error);} else { await renderAdminTimeGrid(state.selectedDate,state.currentLocation);} };
  const blockWeek = async () => {
    if(!state.selectedDate) return; const { start, end } = weekRangeFor(state.selectedDate);
    const { data: cfg } = await supabaseClient.from('schedule_config').select('work_days').eq('location', state.currentLocation).maybeSingle();
    const workDays = (cfg && cfg.work_days) || [1,2,3,4,5,6];
    const promises = []; for(let d=new Date(start+'T00:00:00'); d<=new Date(end+'T00:00:00'); d.setDate(d.getDate()+1)){ const w=(d.getDay()+6)%7; if(workDays.includes(w+1)){ const ds=d.toISOString().slice(0,10); promises.push(supabaseClient.from('blocked_slots').insert({ location: state.currentLocation, date: ds, start_time:'15:00:00', end_time:'21:00:00'})); } }
    showLoading(true); await Promise.all(promises); showLoading(false); await renderAdminTimeGrid(state.selectedDate,state.currentLocation);
  };
  const unblockWeek = async () => {
    if(!state.selectedDate) return; const { start, end } = weekRangeFor(state.selectedDate);
    showLoading(true); const { error } = await supabaseClient.from('blocked_slots').delete().eq('location', state.currentLocation).gte('date', start).lte('date', end); showLoading(false);
    if(error){ alert('Errore sblocco settimana'); console.error(error);} else { await renderAdminTimeGrid(state.selectedDate,state.currentLocation);} };
  const assignSingleAt = async (startHHMM) => {
    const code = prompt('Codice allievo?'); if(!code) return;
    const { data: user } = await supabaseClient.from('users').select('*').eq('code', code.trim()).maybeSingle(); if(!user) return alert('Allievo non trovato');
    const dur = parseInt(prompt('Durata (45 o 60 minuti)?','45')||'45',10);
    const endHHMM = addMinutes(startHHMM, dur);
    if(!(await isFree(state.selectedDate, state.currentLocation, startHHMM, endHHMM))) return alert('Slot occupato/bloccato');
    showLoading(true);
    const { error } = await supabaseClient.from('bookings').insert({ user_code: user.code, location: state.currentLocation, date: state.selectedDate, start_time: startHHMM+':00', end_time: endHHMM+':00', is_package: false, package_id: null, changes_allowed: 0, changes_used: 0 });
    showLoading(false);
    if(error){ alert('Errore creazione lezione'); console.error(error);} else { await renderAdminTimeGrid(state.selectedDate,state.currentLocation);} };
  const assignPackageAt = async (startHHMM) => {
    const code = prompt('Codice allievo?'); if(!code) return;
    const { data: user } = await supabaseClient.from('users').select('*').eq('code', code.trim()).maybeSingle(); if(!user) return alert('Allievo non trovato');
    const n = Math.max(1, parseInt(prompt('Quante lezioni?','4')||'4',10));
    const dur = parseInt(prompt('Durata (45 o 60 minuti)?','45')||'45',10);
    const pkgId = 'PKG_'+Math.random().toString(36).slice(2,10);
    let created=0, dateStr = state.selectedDate;
    showLoading(true);
    while(created<n){ const endHHMM = addMinutes(startHHMM, dur); const free = await isFree(dateStr, state.currentLocation, startHHMM, endHHMM); if(free){ const { error } = await supabaseClient.from('bookings').insert({ user_code: user.code, location: state.currentLocation, date: dateStr, start_time: startHHMM+':00', end_time: endHHMM+':00', is_package: true, package_id: pkgId, changes_allowed: n, changes_used: 0 }); if(error){ console.error(error); alert('Errore inserimento lezione pacchetto'); break; } created++; } const d=new Date(dateStr+'T00:00:00'); d.setDate(d.getDate()+7); dateStr = d.toISOString().slice(0,10); }
    showLoading(false); await renderAdminTimeGrid(state.selectedDate,state.currentLocation);
  };
  const manageCustomBlockAt = async () => {
    const range = prompt('Intervallo HH:MM-HH:MM (es. 17:00-18:30)'); if(!range) return;
    const m = range.match(/^(\d{2}:\d{2})\s*[-–]\s*(\d{2}:\d{2})$/); if(!m) return alert('Formato non valido');
    const [_, startHHMM, endHHMM] = m;
    const { data: ex } = await supabaseClient.from('blocked_slots').select('id,start_time,end_time').eq('location', state.currentLocation).eq('date', state.selectedDate);
    const hit = (ex||[]).find(x => x.start_time.slice(0,5)===startHHMM && x.end_time.slice(0,5)===endHHMM);
    showLoading(true);
    if (hit) { await supabaseClient.from('blocked_slots').delete().eq('id', hit.id); }
    else { await supabaseClient.from('blocked_slots').insert({ location: state.currentLocation, date: state.selectedDate, start_time: startHHMM+':00', end_time: endHHMM+':00' }); }
    showLoading(false);
    await renderAdminTimeGrid(state.selectedDate,state.currentLocation);
  };

  // === 7. Gestione studenti (admin) ===
  const renderStudentList = async () => {
    const cont = document.getElementById('student-list');
    cont.innerHTML = '';
    showLoading(true);
    const { data: users, error } = await supabaseClient.from('users').select('*').eq('role','student').order('name');
    showLoading(false);
    if (error) { console.error(error); return; }
    (users||[]).forEach(stu => {
      const row = document.createElement('div'); row.className='list-card';
      row.innerHTML = `<div class="student-info">${stu.name}<br><small style="color:#6c757d;">Codice: ${stu.code}</small></div>
      <div class="student-actions">
        <button class="btn btn-secondary btn-sm btn-edit-student" data-id="${stu.id}" data-name="${stu.name}" data-code="${stu.code}">Modifica</button>
        <button class="btn btn-danger btn-sm btn-delete-student" data-id="${stu.id}" data-name="${stu.name}">Elimina</button>
      </div>`;
      cont.appendChild(row);
    });
  };
  const showUserModal = (isEdit, data) => {
    document.getElementById('user-modal-title').textContent = isEdit ? 'Modifica Allievo' : 'Crea Nuovo Allievo';
    document.getElementById('user-modal-name').value = data.name || '';
    document.getElementById('user-modal-code').value = data.code || '';
    document.getElementById('user-modal-save').onclick = async () => {
      const name = document.getElementById('user-modal-name').value.trim();
      const code = document.getElementById('user-modal-code').value.trim();
      if(!name || !code) return alert('Compila nome e codice');
      showLoading(true);
      if (isEdit) {
        const { error } = await supabaseClient.from('users').update({ name, code }).eq('id', data.id);
        if (error) console.error(error);
      } else {
        const { error } = await supabaseClient.from('users').insert({ name, code, role: 'student' });
        if (error) console.error(error);
      }
      showLoading(false);
      document.getElementById('user-modal-overlay').style.display='none';
      await renderStudentList();
    };
    document.getElementById('user-modal-overlay').style.display='flex';
  };
  const deleteUser = async (id, name) => { if(!confirm(`Eliminare ${name}?`)) return; showLoading(true); const { error } = await supabaseClient.from('users').delete().eq('id', id); showLoading(false); if(error){ alert('Errore eliminazione'); console.error(error);} else { await renderStudentList(); } };

  // === 8. Impostazioni calendario (admin) ===
  const renderScheduleSettings = async () => {
    const div = document.getElementById('schedule-settings-content');
    div.innerHTML = '';
    const days = ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
    showLoading(true);
    const { data, error } = await supabaseClient.from('schedule_config').select('*').order('location');
    showLoading(false);
    if (error) { console.error(error); return; }
    (data||[]).forEach(row => {
      let html = `<div class="list-card" style="flex-direction:column; align-items:flex-start;">`+
                 `<div style="display:flex; width:100%; justify-content:space-between; align-items:center;">`+
                 `<strong>${row.location}</strong>`+
                 `<button class="btn btn-danger btn-sm btn-remove-location" data-location="${row.location}">Rimuovi</button>`+
                 `</div>`+
                 `<div class="days-checkboxes" data-location="${row.location}" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px,1fr)); gap:.5rem; margin-top:.5rem;">`;
      for(let i=1;i<=6;i++){ const ck = (row.work_days||[]).includes(i) ? 'checked' : ''; html += `<label><input type="checkbox" value="${i}" ${ck}/> ${days[i]}</label>`; }
      html += `</div></div>`;
      div.insertAdjacentHTML('beforeend', html);
    });
  };
  const addLocation = async () => { const loc=(document.getElementById('new-location').value||'').trim(); if(!loc) return; showLoading(true); const { error } = await supabaseClient.from('schedule_config').insert({ location: loc, work_days: [1,2,3,4,5,6] }); showLoading(false); if(error){ alert('Errore aggiunta sede'); console.error(error);} else { document.getElementById('new-location').value=''; await renderScheduleSettings(); } };
  const saveScheduleSettings = async () => {
    const payload = [];
    document.querySelectorAll('.days-checkboxes').forEach(div => { const location = div.dataset.location; const work_days=[]; div.querySelectorAll('input[type="checkbox"]:checked').forEach(ch=>work_days.push(parseInt(ch.value,10))); payload.push({ location, work_days }); });
    showLoading(true);
    await supabaseClient.from('schedule_config').delete().neq('id', -1);
    if (payload.length) await supabaseClient.from('schedule_config').insert(payload);
    showLoading(false);
    await loadInitialData();
    alert('Impostazioni salvate.');
  };
  const removeLocation = async (location) => { if(!confirm(`Rimuovere la sede "${location}"?`)) return; showLoading(true); const { error } = await supabaseClient.from('schedule_config').delete().eq('location', location); showLoading(false); if(error){ alert('Errore rimozione'); console.error(error);} else { await renderScheduleSettings(); } };

  // === 9. Event Listeners ===
  document.getElementById('login-btn').addEventListener('click', login);
  document.getElementById('student-code').addEventListener('keyup', (e)=>{ if(e.key==='Enter') login(); });
  document.getElementById('logout-btn').addEventListener('click', logout);

  document.getElementById('location-buttons-container').addEventListener('click', (e) => {
    const location = e.target.dataset.location; if(!location) return;
    state.currentLocation = location; state.currentDate = new Date(); state.currentDate.setDate(1);
    document.getElementById('booking-location-title').textContent = `Sede di ${location}`;
    renderCalendar();
    navigateTo('booking-screen');
  });

  document.getElementById('booking-screen').addEventListener('click', async (e) => {
    if (e.target.id === 'back-to-main-btn') return navigateTo('main-screen');
    if (e.target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth()-1); renderCalendar(); }
    if (e.target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth()+1); renderCalendar(); }

    if (e.target.classList.contains('valid')) {
      state.selectedDate = e.target.dataset.date;
      const d = new Date(state.selectedDate+'T00:00:00');
      document.getElementById('selected-date-label').textContent = d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
      document.getElementById('time-slots-container').style.display = 'block';
      if (state.currentUser.role === 'admin') {
        document.getElementById('booking-admin-actions').innerHTML = `
          <div class="day-week-controls">
            <button id="block-day-btn" class="btn btn-secondary btn-sm">Blocca Giorno</button>
            <button id="unblock-day-btn" class="btn btn-secondary btn-sm">Sblocca Giorno</button>
            <button id="block-week-btn" class="btn btn-secondary btn-sm">Blocca Settimana</button>
            <button id="unblock-week-btn" class="btn btn-secondary btn-sm">Sblocca Settimana</button>
            <button id="custom-block-btn" class="btn btn-danger btn-sm" title="Aggiungi/rimuovi blocco personalizzato">Gestisci Blocco Orario</button>
          </div>`;
      } else { document.getElementById('booking-admin-actions').innerHTML = ''; }
      await renderAdminTimeGrid(state.selectedDate, state.currentLocation);
    }

    // Bottoni
    if (e.target.id === 'block-day-btn') return blockDay();
    if (e.target.id === 'unblock-day-btn') return unblockDay();
    if (e.target.id === 'block-week-btn') return blockWeek();
    if (e.target.id === 'unblock-week-btn') return unblockWeek();
    if (e.target.id === 'custom-block-btn') return manageCustomBlockAt();

    // Click su slot quando admin
    if (state.currentUser?.role === 'admin' && e.target.classList.contains('time-slot')) {
      const time = e.target.dataset.time;
      if (e.target.classList.contains('blocked')) return alert('Slot bloccato');
      const choice = prompt('Cosa vuoi fare?\n\n1. Assegna lezione singola\n2. Assegna pacchetto a studente\n3. Gestisci blocco orario');
      if (!choice) return;
      if (choice.trim()==='1') return assignSingleAt(time);
      if (choice.trim()==='2') return assignPackageAt(time);
      if (choice.trim()==='3') return manageCustomBlockAt();
    }
  });

  document.getElementById('main-screen').addEventListener('click', async (e) => {
    if (e.target.id === 'manage-students-btn') { await renderStudentList(); navigateTo('student-list-screen'); }
    if (e.target.id === 'manage-schedule-btn') { await renderScheduleSettings(); navigateTo('schedule-settings-screen'); }
  });

  document.getElementById('student-list-screen').addEventListener('click', (e) => {
    if (e.target.id === 'create-student-btn') showUserModal(false, {});
    if (e.target.classList.contains('btn-edit-student')) showUserModal(true, e.target.dataset);
    if (e.target.classList.contains('btn-delete-student')) deleteUser(e.target.dataset.id, e.target.dataset.name);
  });

  document.getElementById('schedule-settings-screen').addEventListener('click', async (e) => {
    if (e.target.id === 'add-location-btn') await addLocation();
    if (e.target.id === 'save-schedule-settings-btn') await saveScheduleSettings();
    if (e.target.classList.contains('btn-remove-location')) await removeLocation(e.target.dataset.location);
    if (e.target.id === 'back-to-main-from-schedule-settings-btn') navigateTo('main-screen');
  });

  document.getElementById('user-modal-cancel').addEventListener('click', () => { document.getElementById('user-modal-overlay').style.display='none'; });

  // Avvio
  window.addEventListener('load', loadInitialData);
</script>
</body>
</html>
