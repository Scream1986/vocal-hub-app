<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Hub Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --header-bg: #000; --button-primary-bg: #ffc107; --button-primary-text: #000; --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545; --light-color: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--light-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem 0; }
        .app-container { width: 100%; max-width: 480px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        header { background-color: var(--header-bg); color: white; text-align: center; }
        main { padding: 1.5rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        h2, h3, h4 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; margin-top: 0.5rem; }
        .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-logout { background-color: var(--danger-color); color: white; margin-top: 1rem; }
        #loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background-color: rgba(255,255,255,0.8); padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .modal-buttons .btn { width: auto; margin-top: 0; }
        .student-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-info { font-weight: 500; }
        .student-actions .btn { width: auto; margin-top: 0; margin-left: 0.5rem; }
        .calendar { margin-top: 1.5rem; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .weekday { padding: 0.75rem 0.25rem; border-radius: 4px; }
        .weekday { font-weight: bold; }
        .calendar-day.invalid { color: #ccc; pointer-events: none; }
        .calendar-day.valid { background-color: #ffffff; border: 1px solid #ddd; cursor: pointer; }
        .calendar-day.selected { background-color: var(--button-primary-bg); color: var(--button-primary-text); font-weight: bold; border: 1px solid var(--button-primary-bg); }
        .admin-time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
        .time-slot { padding: 0.5rem; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.9rem; color: white; border: 1px solid rgba(0, 0, 0, 0.1); }
        .time-slot.free { background-color: var(--success-color); }
        .time-slot.booked { background-color: var(--secondary-color); }
        .time-slot.blocked { background-color: var(--danger-color); }
        .student-time-slots .available-slot, .booked-slot { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem; }
        .student-time-slots .btn-book, .booked-slot .btn-request-change { padding: 0.4rem 0.8rem; font-size: 0.8rem; cursor: pointer; border: none; border-radius: 4px; flex-shrink: 0; margin-left: 1rem; }
        .student-time-slots .btn-book { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
        .booked-slot { background-color: #e9ecef; }
        .btn-request-change { background-color: var(--secondary-color); color: white; }
        .btn-request-change:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; border: 1px solid #ddd; }
        .notification-item { padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem; background-color: #f8f9fa; }
        .notification-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .notification-details { font-size: 0.9rem; color: #6c757d; border-left: 3px solid var(--button-primary-bg); padding-left: 0.75rem; margin-top: 0.75rem; margin-bottom: 1rem; }
        #booking-admin-actions .day-week-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        #booking-admin-actions .day-week-controls .btn { margin-top: 0; font-size: 0.8rem; padding: 0.5rem; }
        #schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #schedule-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .schedule-day-column { padding: 0.5rem; border-radius: 4px; border: 1px solid #eee; }
        .schedule-day-column h5 { margin: -0.5rem -0.5rem 0.5rem -0.5rem; padding: 0.5rem; background-color: #6c757d; color: white; border-radius: 4px 4px 0 0; }
        .schedule-booking { border-left: 3px solid var(--button-primary-bg); padding: 0.5rem; margin-bottom: 0.5rem; background-color: #f8f9fa; font-size: 0.9rem; }
        .admin-tool-card { background: #fff; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <div id="loading-spinner">Caricamento...</div>
    <div class="app-container">
        <header id="app-header" style="padding: 0.5rem;">
            <img src="https://esxpbpxdhqijsomqmrvr.supabase.co/storage/v1/object/public/sito/logo.jpg" alt="Vocal Hub Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </header>
        <main>
            <div id="login-screen" class="screen active"><h2>Accesso</h2><div class="form-group"><label for="student-code">Codice Allievo</label><input type="text" id="student-code" placeholder="Inserisci il tuo codice" autocomplete="off"></div><button id="login-btn" class="btn btn-primary">Accedi</button></div>
            <div id="main-screen" class="screen"><h2 id="welcome-message"></h2><div id="student-bookings-summary"></div><hr><p style="text-align:center;">Seleziona una sede per prenotare una nuova lezione:</p><div id="location-buttons-container"></div><div id="admin-actions" style="margin-top: 1.5rem;"></div><button id="logout-btn" class="btn btn-logout">Esci</button></div>
            <div id="booking-screen" class="screen"><h2 id="booking-location-title"></h2><div id="booking-admin-actions"></div><div class="calendar"><div id="calendar-header"><button id="prev-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&lt;</button><h3 id="month-year-label"></h3><button id="next-month-btn" class="btn btn-secondary btn-sm" style="width: auto;">&gt;</button></div><div id="calendar-weekdays"><div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div></div><div id="calendar-grid"></div></div><div id="time-slots-container" style="display:none; margin-top: 1.5rem;"><h3>Orari per il <span id="selected-date-label"></span></h3><div id="slots-content"></div></div><button id="back-to-main-btn" class="btn btn-secondary" style="margin-top: 2rem;">Torna Indietro</button></div>
            <div id="schedule-screen" class="screen"><h2>Orari della Settimana</h2><div id="schedule-header"><button id="prev-week-btn" class="btn btn-secondary btn-sm">&lt; Prec.</button><h4 id="week-label" style="margin:0;"></h4><button id="next-week-btn" class="btn btn-secondary btn-sm">Succ. &gt;</button></div><div id="schedule-grid" style="margin-top: 1rem;"></div><button id="back-to-main-from-schedule-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button></div>
            <div id="admin-tools-screen" class="screen"><h2>Strumenti Admin</h2><p style="text-align: center; font-size: 0.9rem; color: #6c757d;">Usa questi strumenti per cancellazioni di massa. Le azioni sono irreversibili.</p><div class="admin-tool-card"><h4>Svuota Prenotazioni</h4><div class="form-group"><label for="admin-tools-location">Seleziona Sede</label><select id="admin-tools-location"></select></div><hr><div class="form-group"><label for="reset-day-date">Svuota Giorno Singolo</label><input type="date" id="reset-day-date"><button id="reset-day-btn" class="btn btn-danger">Svuota Giorno</button></div><hr><div class="form-group"><label for="reset-period-start">Svuota Periodo Personalizzato</label><input type="date" id="reset-period-start"><input type="date" id="reset-period-end" style="margin-top: 0.5rem;"><button id="reset-period-btn" class="btn btn-danger">Svuota Periodo</button></div></div><button id="back-to-main-from-admin-tools-btn" class="btn btn-secondary">Torna Indietro</button></div>
            <div id="schedule-settings-screen" class="screen"><h2>Impostazioni Calendario</h2><div id="schedule-settings-content"></div><hr><div class="form-group"><label for="new-location-name">Aggiungi una nuova sede</label><input type="text" id="new-location-name" placeholder="Nome nuova sede"><button id="add-location-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">Aggiungi Sede</button></div><button id="save-schedule-settings-btn" class="btn btn-primary">Salva Modifiche</button><button id="back-to-main-from-schedule-settings-btn" class="btn btn-secondary">Torna Indietro</button></div>
            <div id="student-list-screen" class="screen"><h2>Gestione Allievi</h2><button id="create-student-btn" class="btn btn-primary" style="margin-bottom: 1rem;">+ Crea Nuovo Allievo</button><div id="student-list"></div><button id="back-to-main-from-student-list-btn" class="btn btn-secondary" style="margin-top: 1rem;">Torna Indietro</button></div>
            <div id="notifications-screen" class="screen"><h2>Notifiche Studenti</h2><div id="notifications-list"></div><button id="back-to-main-from-notifications-btn" class="btn btn-secondary">Torna Indietro</button></div>
        </main>
    </div>
    <div id="user-modal-overlay" class="modal-overlay"><div class="modal-content"><h4 id="user-modal-title"></h4><div class="form-group"><label for="user-modal-name">Nome Allievo</label><input type="text" id="user-modal-name"></div><div class="form-group"><label for="user-modal-code">Codice Allievo</label><input type="text" id="user-modal-code" autocomplete="off"></div><div class="modal-buttons"><button id="user-modal-cancel" class="btn btn-secondary">Annulla</button><button id="user-modal-save" class="btn btn-primary">Salva</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const supabaseUrl = 'https://esxpbpxdhqijsomqmrvr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzeHBicHhkaHFpanNvbXFtcnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjExODYsImV4cCI6MjA3MDczNzE4Nn0.5WuPwviEzanny9ky0IgMIgFo4N83t8dQTUZsbp2wEnk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, scheduleCurrentDate: new Date(), calendarPollingInterval: null, locationsToDelete: [] };
        state.currentDate.setDate(1);
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainEl = document.querySelector('main');
        const screens = { 'login-screen': document.getElementById('login-screen'), 'main-screen': document.getElementById('main-screen'), 'schedule-settings-screen': document.getElementById('schedule-settings-screen'), 'student-list-screen': document.getElementById('student-list-screen'), 'booking-screen': document.getElementById('booking-screen'), 'notifications-screen': document.getElementById('notifications-screen'), 'schedule-screen': document.getElementById('schedule-screen'), 'admin-tools-screen': document.getElementById('admin-tools-screen'), };

        const showLoading = (show) => { loadingSpinner.style.display = show ? 'block' : 'none'; };
        const navigateTo = (screenId) => {
            if (state.calendarPollingInterval) { clearInterval(state.calendarPollingInterval); state.calendarPollingInterval = null; }
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenId]) screens[screenId].classList.add('active');
            state.currentScreen = screenId;
        };
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatTime = (timeStr) => timeStr ? timeStr.substring(0, 5) : '';

        const login = async () => {
            const code = document.getElementById('student-code').value.toUpperCase().trim();
            if (!code) return;
            showLoading(true);
            const { data: user, error } = await supabase.from('users').select('*').eq('code', code).single();
            showLoading(false);
            if (error && error.code !== 'PGRST116') {
                console.error('Dettagli errore Supabase:', error);
                return alert(`Si è verificato un errore.\n\nDettagli tecnici: ${error.message}`);
            }
            if (user) {
                state.currentUser = user;
                document.getElementById('welcome-message').textContent = `Ciao, ${user.name}!`;
                await loadInitialData();
                if (user.role === 'admin') updateAdminUI();
                else { checkStudentReplies(); renderStudentBookingSummary(); }
                navigateTo('main-screen');
            } else {
                alert('Codice non valido. Riprova.');
            }
        };

        const loadInitialData = async () => {
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('location, work_days');
            showLoading(false);
            if (error) return console.error("Errore caricamento config calendario:", error);
            state.scheduleConfig = {};
            if (data) data.forEach(item => { state.scheduleConfig[item.location] = item.work_days || []; });
            renderLocationButtons();
        };

        const renderLocationButtons = () => {
            const container = document.getElementById('location-buttons-container');
            container.innerHTML = '';
            const locations = Object.keys(state.scheduleConfig);
            if (locations.length > 0) {
                locations.forEach(location => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary';
                    btn.dataset.location = location;
                    btn.textContent = location;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = `<p style="text-align:center; color: #666;">Nessuna sede configurata.</p>`;
            }
        };

        const updateAdminUI = async () => {
            const adminActionsDiv = document.getElementById('admin-actions');
            const { count } = await supabase.from('notifications').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            adminActionsDiv.innerHTML = `<button id="manage-students-btn" class="btn btn-primary">Gestione Allievi</button><button id="view-schedule-btn" class="btn btn-primary">Visualizza Orari Generali</button><button id="admin-tools-btn" class="btn btn-danger">Strumenti Admin</button><button id="manage-schedule-btn" class="btn btn-secondary">Impostazioni Calendario</button><button id="view-notifications-btn" class="btn btn-secondary">Notifiche Studenti (${count ?? 0})</button>`;
        };

        const logout = () => {
            navigateTo('login-screen');
            state = { currentUser: null, scheduleConfig: {}, currentDate: new Date(), currentLocation: null, selectedDate: null, scheduleCurrentDate: new Date(), calendarPollingInterval: null, locationsToDelete: [] };
            state.currentDate.setDate(1);
            document.getElementById('student-code').value = '';
            document.getElementById('admin-actions').innerHTML = '';
            document.getElementById('student-bookings-summary').innerHTML = '';
        };

        const renderStudentBookingSummary = async () => {
            const summaryDiv = document.getElementById('student-bookings-summary');
            const today = new Date(); today.setHours(0, 0, 0, 0);
            showLoading(true);
            const { data: bookings, error } = await supabase.from('bookings').select('*').eq('user_code', state.currentUser.code).gte('date', formatDate(today)).order('date').order('start_time');
            showLoading(false);
            if (error) return console.error("Errore caricamento prenotazioni:", error);
            if (bookings && bookings.length > 0) {
                summaryDiv.innerHTML = '<h4>Le Tue Prossime Lezioni</h4>' + bookings.map(booking => {
                    const lessonStart = new Date(`${booking.date}T${booking.start_time}`);
                    const canRequestChange = (lessonStart - new Date()) / (1000 * 60 * 60) > 36;
                    return `<div class="booked-slot"><span><strong>${lessonStart.toLocaleDateString('it-IT', {weekday: 'long', day: 'numeric', month: 'long'})}</strong><br><small>Ore: ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)} (${booking.location})</small></span><button class="btn-request-change" data-booking-id="${booking.id}" ${canRequestChange ? '' : 'disabled'}>${canRequestChange ? 'Richiedi Cambio' : 'Scaduto'}</button></div>`;
                }).join('');
            } else {
                summaryDiv.innerHTML = "<p style='text-align:center;'>Nessuna lezione futura prenotata.</p>";
            }
        };

        const checkStudentReplies = async () => {
            const { data, error } = await supabase.from('notifications').select('*').eq('student_code', state.currentUser.code).eq('status', 'replied');
            if (error || !data || data.length === 0) return;
            let alertMessage = "L'amministratore ha risposto alle tue richieste:\n\n";
            const idsToArchive = data.map(reply => {
                alertMessage += `--- Richiesta del ${new Date(reply.created_at).toLocaleDateString('it-IT')} ---\nRisposta: "${reply.reply_message}"\n\n`;
                return reply.id;
            });
            alert(alertMessage);
            await supabase.from('notifications').update({ status: 'archived' }).in('id', idsToArchive);
        };
        
        const isDayOfWeekAvailable = (date, location) => state.scheduleConfig[location]?.includes(date.getDay()) || false;
        
        const renderCalendar = () => {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            document.getElementById('month-year-label').textContent = state.currentDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('time-slots-container').style.display = 'none';
            document.getElementById('booking-admin-actions').innerHTML = '';
            state.selectedDate = null;
            const year = state.currentDate.getFullYear(), month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            let dayOfWeek = firstDay.getDay(); dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
            for (let i = 0; i < dayOfWeek; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'calendar-day ' + (isDayOfWeekAvailable(date, state.currentLocation) ? 'valid' : 'invalid');
                if (dayEl.classList.contains('valid')) dayEl.dataset.date = formatDate(date);
                calendarGrid.appendChild(dayEl);
            }
        };

        const renderTimeSlots = async (dateStr, isPolling = false) => {
            if (state.currentScreen !== 'booking-screen' || !dateStr) return;
            state.selectedDate = new Date(dateStr + 'T00:00:00');
            if (!isPolling) {
                document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');
                document.getElementById('selected-date-label').textContent = state.selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
                document.getElementById('time-slots-container').style.display = 'block';
                if (state.currentUser.role === 'admin') {
                    document.getElementById('booking-admin-actions').innerHTML = `<div class="day-week-controls"><button id="block-day-btn" class="btn btn-danger">Blocca Giorno</button><button id="unblock-day-btn" class="btn btn-success">Sblocca Giorno</button><button id="block-week-btn" class="btn btn-danger">Blocca Settimana (TUTTE LE SEDI)</button><button id="unblock-week-btn" class="btn btn-success">Sblocca Settimana (TUTTE LE SEDI)</button></div>`;
                } else {
                    document.getElementById('booking-admin-actions').innerHTML = '';
                }
            }
            const slotsContent = document.getElementById('slots-content');
            if (!isPolling) slotsContent.innerHTML = 'Aggiornamento...';
            const { data: bookings, errorB } = await supabase.from('bookings').select('*, users(name, code)').eq('date', dateStr).eq('location', state.currentLocation);
            const { data: blocked, errorL } = await supabase.from('blocked_slots').select('*').eq('date', dateStr).eq('location', state.currentLocation);
            if (errorB || errorL) return;
            if (state.currentUser.role === 'admin') {
                const generateTimeSlots = (start, end, interval) => Array.from({length: (end - start) * (60 / interval)}, (_, i) => { const d = new Date(0); d.setUTCHours(start, i * interval); return d.toISOString().substring(11, 16); });
                const allSlots = generateTimeSlots(15, 21, 15);
                slotsContent.innerHTML = '<div class="admin-time-grid">' + allSlots.map(slot => {
                    let status = 'free', tooltip = `Orario: ${slot}, Libero`;
                    const booking = bookings.find(b => slot >= formatTime(b.start_time) && slot < formatTime(b.end_time));
                    if (booking) { status = 'booked'; tooltip = `Occupato da: ${booking.users.name}`; }
                    else if (blocked.some(b => slot >= formatTime(b.start_time) && slot < formatTime(b.end_time))) { status = 'blocked'; tooltip = 'Bloccato'; }
                    return `<div class="time-slot ${status}" data-time="${slot}" title="${tooltip}" data-booking='${booking ? JSON.stringify(booking) : null}'>${slot}</div>`;
                }).join('') + '</div>';
            } else {
                const allEvents = [...bookings, ...blocked].sort((a,b) => a.start_time.localeCompare(b.start_time));
                const isTimespanFree = (start, end) => !allEvents.some(event => new Date(`${dateStr}T${event.start_time}`) < end && new Date(`${dateStr}T${event.end_time}`) > start);
                const getAvailableSlots = (duration) => {
                    const available = new Set(), now = new Date(), potentialStarts = new Set(["15:00"]);
                    allEvents.forEach(e => potentialStarts.add(formatTime(e.end_time)));
                    potentialStarts.forEach(timeStr => {
                        const start = new Date(`${dateStr}T${timeStr}`);
                        if ((start - now) / 36e5 > 12 && start.getTime() + duration * 60000 <= new Date(`${dateStr}T21:00:00`).getTime() && isTimespanFree(start, new Date(start.getTime() + duration * 60000))) {
                            available.add(timeStr);
                        }
                    });
                    return Array.from(available).sort();
                };
                const slots45 = getAvailableSlots(45), slots60 = getAvailableSlots(60);
                let html = `<h4>Crea Nuova Prenotazione</h4>`;
                if (slots45.length === 0 && slots60.length === 0) html += "<p>Nessun orario disponibile per nuove prenotazioni.</p>";
                else {
                    html += '<div class="student-time-slots">';
                    if (slots45.length > 0) html += '<h5>Lezione da 45 minuti</h5>' + slots45.map(slot => `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn-book" data-time="${slot}" data-duration="45">Prenota</button></div>`).join('');
                    if (slots60.length > 0) html += '<h5>Lezione da 60 minuti</h5>' + slots60.map(slot => `<div class="available-slot"><span>Inizio ore: <strong>${slot}</strong></span><button class="btn-book" data-time="${slot}" data-duration="60">Prenota</button></div>`).join('');
                    html += '</div>';
                }
                slotsContent.innerHTML = html;
            }
        };

        const renderStudentList = async () => {
            const listDiv = document.getElementById('student-list');
            listDiv.innerHTML = ''; showLoading(true);
            const { data: users, error } = await supabase.from('users').select('*').eq('role', 'student').order('name');
            showLoading(false);
            if (error) return console.error("Errore caricamento allievi:", error);
            users.forEach(student => {
                listDiv.innerHTML += `<div class="student-list-item"><div class="student-info">${student.name}<br><small style="color: #6c757d;">Codice: ${student.code}</small></div><div class="student-actions"><button class="btn btn-secondary btn-sm btn-edit-student" data-id="${student.id}" data-name="${student.name}" data-code="${student.code}">Modifica</button><button class="btn btn-danger btn-sm btn-delete-student" data-id="${student.id}" data-name="${student.name}">Elimina</button></div></div>`;
            });
        };
        const showUserModal = (isEdit, userData = {}) => {
            document.getElementById('user-modal-title').textContent = isEdit ? 'Modifica Allievo' : 'Crea Nuovo Allievo';
            document.getElementById('user-modal-name').value = userData.name || '';
            document.getElementById('user-modal-code').value = userData.code || '';
            document.getElementById('user-modal-save').onclick = () => handleSaveUser(userData.id);
            document.getElementById('user-modal-overlay').style.display = 'flex';
        };
        const handleSaveUser = async (userId) => {
            const name = document.getElementById('user-modal-name').value.trim();
            const code = document.getElementById('user-modal-code').value.toUpperCase().trim();
            if (!name || !code) return alert("Nome e Codice non possono essere vuoti.");
            showLoading(true);
            const { error } = userId ? await supabase.from('users').update({ name, code }).eq('id', userId) : await supabase.from('users').insert({ name, code, role: 'student' });
            showLoading(false);
            if (error) return alert("Errore: il codice potrebbe essere già in uso.");
            alert(`Allievo "${name}" salvato.`);
            await renderStudentList();
            document.getElementById('user-modal-overlay').style.display = 'none';
        };
        const deleteUser = async (userId, userName) => {
            if (!confirm(`Sei sicuro di voler eliminare "${userName}"? Verranno cancellate anche tutte le sue prenotazioni.`)) return;
            showLoading(true);
            const { error } = await supabase.from('users').delete().eq('id', userId);
            showLoading(false);
            if (error) return alert("Errore durante l'eliminazione.");
            alert("Allievo eliminato.");
            await renderStudentList();
        };

        const renderScheduleSettings = async () => {
            state.locationsToDelete = [];
            const contentDiv = document.getElementById('schedule-settings-content');
            contentDiv.innerHTML = 'Caricamento...';
            showLoading(true);
            const { data, error } = await supabase.from('schedule_config').select('*').order('location');
            showLoading(false);
            if(error) return console.error("Errore caricamento impostazioni:", error);
            contentDiv.innerHTML = '';
            data.forEach(locationData => addLocationToDOM(locationData.location, locationData.work_days));
        };
        
        const addLocationToDOM = (locationName, workDays = []) => {
            const contentDiv = document.getElementById('schedule-settings-content');
            const daysOfWeek = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            let locationHtml = `<div style="border:1px solid #eee; padding:1rem; border-radius:8px; margin-bottom:1rem;" data-location-block="${locationName}"><div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0;">${locationName}</h4><button class="btn btn-danger btn-sm btn-remove-location" data-location="${locationName}">&times; Rimuovi</button></div><div class="days-checkboxes" data-location="${locationName}" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;">`;
            for (let i = 1; i <= 6; i++) {
                const isChecked = workDays.includes(i);
                locationHtml += `<div><input type="checkbox" id="${locationName}-${i}" value="${i}" ${isChecked ? 'checked' : ''}><label for="${locationName}-${i}" style="margin-left:0.25rem;">${daysOfWeek[i]}</label></div>`;
            }
            locationHtml += `</div></div>`;
            contentDiv.insertAdjacentHTML('beforeend', locationHtml);
        };

        const saveScheduleSettings = async () => {
            showLoading(true);
            const promises = [];
            if (state.locationsToDelete.length > 0) {
                promises.push(supabase.from('schedule_config').delete().in('location', state.locationsToDelete));
            }
            const updates = [];
            document.querySelectorAll('.days-checkboxes').forEach(div => {
                const location = div.dataset.location;
                const work_days = Array.from(div.querySelectorAll('input:checked')).map(box => parseInt(box.value));
                updates.push({ location, work_days });
            });
            if (updates.length > 0) {
                promises.push(supabase.from('schedule_config').upsert(updates, { onConflict: 'location' }));
            }
            const results = await Promise.all(promises);
            showLoading(false);
            if (results.some(res => res.error)) { alert("Errore nel salvataggio."); } 
            else { alert("Impostazioni salvate."); await loadInitialData(); navigateTo('main-screen'); }
        };

        const removeLocationFromDOM = (locationToRemove) => {
            if (confirm(`Sei sicuro di voler rimuovere la sede "${locationToRemove}"? La modifica sarà definitiva solo dopo aver cliccato 'Salva Modifiche'.`)) {
                if (!state.locationsToDelete.includes(locationToRemove)) state.locationsToDelete.push(locationToRemove);
                document.querySelector(`[data-location-block="${locationToRemove}"]`)?.remove();
            }
        };

        const renderNotifications = async () => {
            const listDiv = document.getElementById('notifications-list');
            showLoading(true);
            const { data: notifications, error: notifError } = await supabase.from('notifications').select('*').eq('status', 'pending');
            if (notifError || !notifications || notifications.length === 0) {
                listDiv.innerHTML = '<p>Nessuna nuova notifica.</p>';
                showLoading(false);
                return;
            }
            const bookingIds = notifications.map(n => n.booking_id).filter(id => id);
            let bookingsMap = new Map();
            if(bookingIds.length > 0) {
                const { data: bookings, error: bookError } = await supabase.from('bookings').select('*').in('id', bookingIds);
                if (bookError) console.error(bookError);
                else bookingsMap = new Map(bookings.map(b => [b.id, b]));
            }
            showLoading(false);
            listDiv.innerHTML = notifications.map(n => {
                const booking = n.booking_id ? bookingsMap.get(n.booking_id) : null;
                let bookingDetails = '<i>Info sulla lezione originale non disponibili.</i>';
                if (booking) {
                    bookingDetails = `Sede: ${booking.location}<br>Giorno: ${new Date(booking.date + 'T00:00:00').toLocaleDateString('it-IT')}<br>Orario: ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}`;
                }
                return `<div class="notification-item" data-notification-id="${n.id}" data-booking-id="${n.booking_id || ''}"><p>Da: <strong>${n.student_name}</strong></p><p>Richiesta: <em>"${n.message}"</em></p><div class="notification-details">${bookingDetails}</div><div class="notification-actions"><button class="btn btn-primary btn-sm btn-reply">Rispondi</button><button class="btn btn-secondary btn-sm btn-mark-read">Segna come Letta</button>${booking ? `<button class="btn btn-danger btn-sm btn-cancel-booking">Cancella Lezione</button>` : ''}</div></div>`;
            }).join('');
        };
        
        const renderSchedule = async () => {
            const grid = document.getElementById('schedule-grid'), label = document.getElementById('week-label');
            grid.innerHTML = 'Caricamento...';
            const current = new Date(state.scheduleCurrentDate);
            const dayOfWeek = current.getDay();
            const diff = current.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const weekStart = new Date(current.setDate(diff));
            const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 5);
            label.textContent = `${weekStart.toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit'})} - ${weekEnd.toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit', year:'numeric'})}`;
            showLoading(true);
            const { data: bookings, error } = await supabase.from('bookings').select('*, users(name)').gte('date', formatDate(weekStart)).lte('date', formatDate(weekEnd)).order('date').order('start_time');
            showLoading(false);
            if(error) return console.error(error);
            const bookingsByDay = {};
            for(let i=0; i<6; i++) { const d = new Date(weekStart); d.setDate(weekStart.getDate() + i); bookingsByDay[formatDate(d)] = []; }
            bookings.forEach(b => { if(bookingsByDay[b.date]) bookingsByDay[b.date].push(b); });
            const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
            grid.innerHTML = dayNames.map((name, i) => {
                const dayDate = new Date(weekStart); dayDate.setDate(weekStart.getDate() + i);
                const dayBookings = bookingsByDay[formatDate(dayDate)];
                let bookingsHtml = '<p>Nessuna lezione.</p>';
                if(dayBookings.length > 0) {
                    bookingsHtml = dayBookings.map(b => `<div class="schedule-booking"><strong>${formatTime(b.start_time)}</strong> - ${b.users.name} <small>(${b.location})</small></div>`).join('');
                }
                return `<div class="schedule-day-column"><h5>${name} ${dayDate.getDate()}</h5>${bookingsHtml}</div>`;
            }).join('');
        };

        const renderAdminTools = () => {
            const select = document.getElementById('admin-tools-location');
            select.innerHTML = Object.keys(state.scheduleConfig).map(loc => `<option value="${loc}">${loc}</option>`).join('');
        };

        const internalBlockDay = async (dateStr, location) => {
            const { data: bookings } = await supabase.from('bookings').select('*, users(name, code)').eq('date', dateStr).eq('location', location);
            if (bookings && bookings.length > 0) {
                const bookingIds = bookings.map(b => b.id);
                const notifications = bookings.map(b => ({ student_code: b.users.code, student_name: b.users.name, message: `La tua lezione del ${dateStr} alle ${formatTime(b.start_time)} è stata annullata per indisponibilità. Questa notifica è automatica, contatta l'insegnante per dettagli.`, booking_id: null, status: 'replied', reply_message: `La tua lezione del ${dateStr} è stata annullata per indisponibilità. Contatta l'insegnante per riprogrammare.`}));
                await supabase.from('bookings').delete().in('id', bookingIds);
                await supabase.from('notifications').insert(notifications);
            }
            await supabase.from('blocked_slots').delete().eq('date', dateStr).eq('location', location);
            await supabase.from('blocked_slots').insert({ date: dateStr, location, start_time: '15:00:00', end_time: '21:00:00'});
        };
        const internalUnblockDay = async (dateStr, location) => {
            await supabase.from('blocked_slots').delete().eq('date', dateStr).eq('location', location);
        };

        const assignPackage = async (startDate, location) => {
            const studentCode = prompt("Inserisci il codice dell'allievo:").toUpperCase();
            if(!studentCode) return;
            const { data: student } = await supabase.from('users').select('code').eq('code', studentCode).single();
            if (!student) return alert('Codice allievo non trovato.');
            const numLessons = parseInt(prompt("Quante lezioni nel pacchetto?"));
            if (isNaN(numLessons) || numLessons < 1) return alert("Numero lezioni non valido.");
            const duration = parseInt(prompt("Durata di ogni lezione (45 o 60 min)?"));
            if (![45, 60].includes(duration)) return alert("Durata non valida.");
            showLoading(true);
            let searchDate = new Date(startDate), lessonsBooked = [], attempts = 0;
            while(lessonsBooked.length < numLessons && attempts < 365) {
                if (isDayOfWeekAvailable(searchDate, location)) {
                    const dateStr = formatDate(searchDate);
                    const { data: bookings, errorB } = await supabase.from('bookings').select('start_time, end_time').eq('date', dateStr).eq('location', location);
                    const { data: blocked, errorL } = await supabase.from('blocked_slots').select('start_time, end_time').eq('date', dateStr).eq('location', location);
                    if (!errorB && !errorL) {
                        const allEvents = [...bookings, ...blocked];
                        const potentialStarts = new Set(["15:00"]);
                        allEvents.forEach(e => potentialStarts.add(formatTime(e.end_time)));
                        for (const timeStr of Array.from(potentialStarts).sort()) {
                            const start = new Date(`${dateStr}T${timeStr}`);
                            const end = new Date(start.getTime() + duration * 60000);
                            const isFree = !allEvents.some(event => new Date(`${dateStr}T${event.start_time}`) < end && new Date(`${dateStr}T${event.end_time}`) > start);
                            if (end <= new Date(`${dateStr}T21:00:00`) && isFree) {
                                lessonsBooked.push({ user_code: student.code, location, date: dateStr, start_time: timeStr, end_time: end.toTimeString().substring(0,8) });
                                break; 
                            }
                        }
                    }
                }
                const bookedOnThisDate = lessonsBooked.length > 0 && lessonsBooked[lessonsBooked.length-1].date === formatDate(searchDate);
                searchDate.setDate(searchDate.getDate() + (bookedOnThisDate ? 7 : 1));
                attempts++;
            }
            if(lessonsBooked.length < numLessons) {
                showLoading(false);
                return alert(`Impossibile trovare slot liberi per tutte le ${numLessons} lezioni. Sono state trovate solo ${lessonsBooked.length} disponibilità.`);
            }
            const { error: insertError } = await supabase.from('bookings').insert(lessonsBooked);
            showLoading(false);
            if (insertError) alert("Errore durante la creazione del pacchetto.");
            else {
                const dates = lessonsBooked.map(b => new Date(b.date + 'T00:00:00').toLocaleDateString('it-IT')).join('\n');
                alert(`Pacchetto di ${numLessons} lezioni creato per ${studentCode}.\n\nDate prenotate:\n${dates}`);
            }
            await renderTimeSlots(formatDate(state.selectedDate));
        };
        
        mainEl.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.id;
            
            if (id === 'login-btn') await login();
            if (id === 'logout-btn') logout();
            if (id.startsWith('back-to-main')) navigateTo('main-screen');

            if (state.currentUser?.role === 'admin') {
                if (id === 'manage-students-btn') { await renderStudentList(); navigateTo('student-list-screen'); }
                if (id === 'manage-schedule-btn') { await renderScheduleSettings(); navigateTo('schedule-settings-screen'); }
                if (id === 'view-notifications-btn') { await renderNotifications(); navigateTo('notifications-screen'); }
                if (id === 'view-schedule-btn') { state.scheduleCurrentDate = new Date(); await renderSchedule(); navigateTo('schedule-screen'); }
                if (id === 'admin-tools-btn') { renderAdminTools(); navigateTo('admin-tools-screen'); }
            }
        });

        document.getElementById('student-code').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
        
        document.getElementById('location-buttons-container').addEventListener('click', (e) => {
            const location = e.target.dataset.location;
            if (location) {
                state.currentLocation = location;
                document.getElementById('booking-location-title').textContent = `Sede di ${location}`;
                state.currentDate = new Date(); state.currentDate.setDate(1);
                renderCalendar(); 
                navigateTo('booking-screen');
                state.calendarPollingInterval = setInterval(() => {
                    if (state.selectedDate) renderTimeSlots(formatDate(state.selectedDate), true);
                }, 15000);
            }
        });

        document.getElementById('booking-screen').addEventListener('click', async (e) => {
            const target = e.target;
            const dateStr = state.selectedDate ? formatDate(state.selectedDate) : null;
            if (target.id === 'prev-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
            if (target.id === 'next-month-btn') { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
            if (target.classList.contains('valid')) await renderTimeSlots(target.dataset.date, false);
            if (!dateStr || !target.closest('button')) return;
            const buttonId = target.closest('button').id;
            if (buttonId === 'block-day-btn') { if (confirm(`Sei sicuro di bloccare il giorno ${dateStr}? Le prenotazioni verranno cancellate.`)) { await internalBlockDay(dateStr, state.currentLocation); } }
            if (buttonId === 'unblock-day-btn') await internalUnblockDay(dateStr, state.currentLocation);
            if (buttonId === 'block-week-btn' || buttonId === 'unblock-week-btn') {
                const isBlocking = buttonId === 'block-week-btn';
                if (!confirm(`SEI SICURO? Questa azione ${isBlocking ? 'bloccherà' : 'sbloccherà'} la settimana corrente per TUTTE le sedi.`)) return;
                showLoading(true);
                const d = new Date(state.selectedDate);
                const dayOfWeek = d.getDay() === 0 ? 7 : d.getDay();
                const weekStart = new Date(d.setDate(d.getDate() - dayOfWeek + 1));
                const promises = [];
                const allLocations = Object.keys(state.scheduleConfig);
                for(let i=0; i<6; i++) {
                    const currentDay = new Date(weekStart); currentDay.setDate(weekStart.getDate() + i);
                    for (const loc of allLocations) {
                        if(isDayOfWeekAvailable(currentDay, loc)) {
                            promises.push(isBlocking ? internalBlockDay(formatDate(currentDay), loc) : internalUnblockDay(formatDate(currentDay), loc));
                        }
                    }
                }
                await Promise.all(promises);
                showLoading(false);
                await renderTimeSlots(dateStr, false);
            }
        });
        
        document.getElementById('schedule-screen').addEventListener('click', async e => {
            if (e.target.id === 'prev-week-btn') { state.scheduleCurrentDate.setDate(state.scheduleCurrentDate.getDate() - 7); await renderSchedule(); }
            if (e.target.id === 'next-week-btn') { state.scheduleCurrentDate.setDate(state.scheduleCurrentDate.getDate() + 7); await renderSchedule(); }
        });

        document.getElementById('admin-tools-screen').addEventListener('click', async e => {
            const button = e.target.closest('button');
            if (!button || button.id.startsWith('back-to-main')) return;
            const location = document.getElementById('admin-tools-location').value;
            if (!location) return alert("Seleziona una sede prima di procedere.");
            let startDate, endDate;
            if(button.id === 'reset-day-btn') {
                const day = document.getElementById('reset-day-date').value;
                if(!day) return alert("Seleziona un giorno.");
                startDate = endDate = day;
            } else if (button.id === 'reset-period-btn') {
                startDate = document.getElementById('reset-period-start').value;
                endDate = document.getElementById('reset-period-end').value;
                if(!startDate || !endDate) return alert("Seleziona una data di inizio e una di fine.");
            } else { return; }
            const { count: bookingCount } = await supabase.from('bookings').select('*', { count: 'exact', head: true }).eq('location', location).gte('date', startDate).lte('date', endDate);
            if (!confirm(`SEI SICURO?\n\nStai per cancellare ${bookingCount} prenotazioni per la sede di ${location} dal ${startDate} al ${endDate}.\n\nL'azione è irreversibile.`)) return;
            showLoading(true);
            const { error } = await supabase.from('bookings').delete().eq('location', location).gte('date', startDate).lte('date', endDate);
            showLoading(false);
            if (error) alert("Errore durante la cancellazione.");
            else alert(`${bookingCount} prenotazioni cancellate con successo.`);
        });

        document.getElementById('student-list-screen').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || button.id.startsWith('back-to-main')) return;
            if (button.id === 'create-student-btn') showUserModal(false);
            if (button.classList.contains('btn-edit-student')) showUserModal(true, button.dataset);
            if (button.classList.contains('btn-delete-student')) deleteUser(button.dataset.id, button.dataset.name);
        });

        document.getElementById('schedule-settings-screen').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || button.id.startsWith('back-to-main')) return;
            if (button.id === 'add-location-btn') {
                const input = document.getElementById('new-location-name'); const newLocationName = input.value.trim();
                if (newLocationName && !document.querySelector(`[data-location-block="${newLocationName}"]`)) {
                    addLocationToDOM(newLocationName); input.value = '';
                } else { alert('Inserisci un nome valido o un nome non già presente.'); }
            }
            if (button.id === 'save-schedule-settings-btn') saveScheduleSettings();
            if (button.classList.contains('btn-remove-location')) removeLocationFromDOM(button.dataset.location);
        });
        
        document.getElementById('slots-content').addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('btn-book')) {
                const startTime = target.dataset.time, duration = parseInt(target.dataset.duration), dateStr = formatDate(state.selectedDate);
                if (confirm(`Confermi la prenotazione per ${state.selectedDate.toLocaleDateString('it-IT')} alle ${startTime} per ${duration} minuti?`)) {
                    const endDateTime = new Date(new Date(`${dateStr}T${startTime}`).getTime() + duration * 60000);
                    showLoading(true);
                    const { error } = await supabase.from('bookings').insert({ user_code: state.currentUser.code, location: state.currentLocation, date: dateStr, start_time: startTime, end_time: endDateTime.toTimeString().substring(0,8) });
                    showLoading(false);
                    if (error) { alert("Errore durante la prenotazione."); } else { alert("Prenotazione confermata!"); await renderTimeSlots(dateStr, false); await renderStudentBookingSummary(); }
                }
            } else if (state.currentUser.role === 'admin' && target.classList.contains('time-slot')) {
                const time = target.dataset.time, dateStr = formatDate(state.selectedDate), location = state.currentLocation;
                const statusClass = target.classList.contains('free') ? 'free' : (target.classList.contains('booked') ? 'booked' : 'blocked');
                const bookingData = JSON.parse(target.dataset.booking);
                let info = `Orario: ${time}\nStato: `;
                if(statusClass === 'booked') info += `Occupato da ${bookingData.users.name}`;
                else if(statusClass === 'blocked') info += 'Bloccato';
                else info += 'Libero';
                alert(info);
                const choice = prompt("Cosa vuoi fare?\n\n1. Gestisci Blocco Orario\n2. Assegna Lezione Singola\n3. Assegna Pacchetto a Studente");
                if (!choice) return;
                if (choice === '1') {
                    showLoading(true);
                    if (statusClass === 'blocked') {
                        if (confirm('Questo slot è bloccato. Vuoi sbloccarlo?')) await supabase.from('blocked_slots').delete().eq('date', dateStr).eq('location', location).gte('start_time', time + ':00').lt('end_time', new Date(new Date(`${dateStr}T${time}`).getTime() + 16 * 60000).toTimeString().substring(0,8));
                    } else if (confirm(`Vuoi bloccare lo slot delle ${time}? ${statusClass === 'booked' ? '\nATTENZIONE: la lezione prenotata verrà CANCELLATA e lo studente avvisato.' : ''}`)) {
                        if (statusClass === 'booked') {
                            await supabase.from('bookings').delete().eq('id', bookingData.id);
                            await supabase.from('notifications').insert({ student_code: bookingData.users.code, student_name: bookingData.users.name, message: `La tua lezione del ${dateStr} alle ${time} è stata annullata.`, booking_id: null, status: 'replied', reply_message: `La tua lezione del ${dateStr} alle ${time} è stata annullata.` });
                        }
                        const endTime = new Date(new Date(`${dateStr}T${time}`).getTime() + 15 * 60000).toTimeString().substring(0,8);
                        await supabase.from('blocked_slots').insert({ date: dateStr, location, start_time: time, end_time: endTime });
                    }
                    showLoading(false); await renderTimeSlots(dateStr, false);
                } else if (choice === '2') {
                     const studentCode = prompt("Inserisci il codice dell'allievo:").toUpperCase();
                     if(studentCode) {
                        const durationInput = prompt("Inserisci la durata della lezione (45 o 60 minuti):");
                        const duration = parseInt(durationInput);

                        if (![45, 60].includes(duration)) {
                            alert("Durata non valida. Inserisci 45 o 60.");
                            return;
                        }
                        
                        showLoading(true);
                        const { data: student } = await supabase.from('users').select('code').eq('code', studentCode).single();
                        if (student) {
                            const endTime = new Date(new Date(`${dateStr}T${time}`).getTime() + duration * 60000).toTimeString().substring(0,8);
                            await supabase.from('bookings').insert({ user_code: student.code, location, date: dateStr, start_time: time, end_time: endTime });
                        } else alert('Codice allievo non trovato.');
                        showLoading(false); await renderTimeSlots(dateStr, false);
                     }
                } else if (choice === '3') {
                    await assignPackage(state.selectedDate, location);
                }
            }
        });

        document.getElementById('student-bookings-summary').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (button && button.classList.contains('btn-request-change')) {
                const bookingId = button.dataset.bookingId;
                const message = prompt("Scrivi un messaggio per l'amministratore (es. 'Vorrei spostare ad un altro giorno'):");
                if (message && message.trim()) {
                    showLoading(true);
                    const { error } = await supabase.from('notifications').insert({ student_code: state.currentUser.code, student_name: state.currentUser.name, message: message.trim(), booking_id: bookingId, status: 'pending' });
                    showLoading(false);
                    if (error) alert("Errore nell'invio della richiesta."); else alert("Richiesta inviata.");
                }
            }
        });

        document.getElementById('notifications-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const item = button.closest('.notification-item');
            const notificationId = item.dataset.notificationId;
            const bookingId = item.dataset.bookingId;
            if (button.classList.contains('btn-mark-read')) {
                showLoading(true);
                await supabase.from('notifications').update({ status: 'read' }).eq('id', notificationId);
            } else if (button.classList.contains('btn-reply')) {
                const replyMessage = prompt("Scrivi la tua risposta per lo studente:");
                if (replyMessage && replyMessage.trim()) {
                    showLoading(true);
                    await supabase.from('notifications').update({ status: 'replied', reply_message: replyMessage.trim() }).eq('id', notificationId);
                } else return;
            } else if (button.classList.contains('btn-cancel-booking')) {
                if (confirm("Sei sicuro di voler cancellare questa lezione e notificare lo studente?")) {
                    showLoading(true);
                    await supabase.from('bookings').delete().eq('id', bookingId);
                    await supabase.from('notifications').update({ status: 'replied', reply_message: "Lezione cancellata come da richiesta." }).eq('id', notificationId);
                } else return;
            } else return;
            showLoading(false); await renderNotifications(); await updateAdminUI();
        });

        document.getElementById('user-modal-cancel').addEventListener('click', () => { document.getElementById('user-modal-overlay').style.display = 'none'; });
    });
    </script>
</body>
</html>